name: Build Multiple LKM (Selectable Module)
on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Select module to build'
        required: true
        type: choice
        options:
          - exianb-dev
          - exianb
          - prctl-fd
          - prctl-hook
        default: exianb
      add_timestamp:
        description: 'Add timestamp to artifacts?'
        required: true
        type: boolean
        default: true

jobs:
  build-pvm:
    strategy:
      matrix:
        include:
          - version: android12-5.10
            sub_level: 185
            os_patch_level: 2023-09
          - version: android13-5.15
            sub_level: 137
            os_patch_level: 2023-12
          - version: android14-6.1
            sub_level: 84
            os_patch_level: 2024-07
          - version: android15-6.6
            sub_level: 30
            os_patch_level: 2024-08
    runs-on: ubuntu-latest
    
    steps:
    - name: Generate timestamp
      if: inputs.add_timestamp
      id: timestamp
      run: echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
    
    - name: Build with reusable workflow
      uses: ./.github/workflows/gki-kernel.yml
      with:
        version: ${{ matrix.version }}
        version_name: ${{ matrix.version }}.${{ matrix.sub_level }}
        tag: ${{ matrix.version }}-${{ matrix.os_patch_level }}
        module_dir: ${{ github.event.inputs.module_dir }}
        module_name: ${{ github.event.inputs.module_dir }}${{ inputs.add_timestamp && format('_{0}', steps.timestamp.outputs.timestamp) || '' }}
        module_config: PVM_MOD
        build_lkm: true
