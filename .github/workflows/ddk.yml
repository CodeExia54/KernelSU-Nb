name: Build Kernel Module

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - proti-fd
        - proti-hook
        - offset
        - hello-world
        default: 'exianb-dev'

jobs:
  build-modules:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko for KMI: ${{ matrix.kmi }} ==="
        
        # Setup DDK
        sudo curl -fsSL https://raw.githubusercontent.com/Ylarod/ddk/main/scripts/ddk -o /usr/local/bin/ddk
        sudo chmod +x /usr/local/bin/ddk
        
        # Build with DDK
        cd "${{ inputs.module_dir }}"
        ddk build --target "${{ matrix.kmi }}"
        
        echo "=== Build completed ==="

        # Create output directory
        mkdir -p /github/workspace/out
        
        # Copy with KMI-specific naming
        OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}.ko"
        cp "${{ inputs.module_dir }}.ko" "/github/workspace/out/$OUTPUT_NAME"

        echo "Copied to: /github/workspace/out/$OUTPUT_NAME"
        ls -la "/github/workspace/out/$OUTPUT_NAME"
        echo "Size: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"
        llvm-strip -d "/github/workspace/out/$OUTPUT_NAME"
        echo "Size after stripping: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"

    - name: Upload ${{ inputs.module_dir }}.ko artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}
        path: /github/workspace/out/${{ inputs.module_dir }}-${{ matrix.kmi }}.ko
