name: Build Kernel Module ddk (OLLVM Levels)

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory'
        required: true
        type: choice
        options:
          - wuwa
        default: 'wuwa'

      obfuscation_level:
        description: 'OLLVM obfuscation strength'
        required: true
        type: choice
        options:
          - easy
          - medium
          - hard
          - extreme
        default: easy

      enable_fla:
        description: 'Enable Control Flow Flattening'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'yes'

      enable_split:
        description: 'Enable Basic Block Splitting'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

      split_num:
        description: 'Splitting iterations (1-5)'
        required: true
        type: string
        default: '3'

      enable_sub:
        description: 'Enable Instruction Substitution'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

      sub_loop:
        description: 'Substitution iterations (1-5)'
        required: true
        type: string
        default: '2'

      enable_bcf:
        description: 'Enable Bogus Control Flow'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

      bcf_loop:
        description: 'BCF iterations (1-5)'
        required: true
        type: string
        default: '2'

      bcf_prob:
        description: 'BCF probability (1-100)'
        required: true
        type: string
        default: '40'

      enable_sobf:
        description: 'Enable String Obfuscation'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }} (${{ inputs.obfuscation_level }}) for ${{ matrix.kmi }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    # ==================================================
    # Install tools and extract OLLVM
    # ==================================================
    - name: Setup environment
      run: |
        apt-get update
        apt-get install -y unzip file binutils
        
        cd ${{ inputs.module_dir }}
        
        echo "Extracting OLLVM..."
        unzip -q android-ollvm.zip
        unzip -q -o android-ollvm1.zip
        
        chmod -R 755 android-ollvm/bin/

    # ==================================================
    # STRATEGY: Pre-compile with OLLVM, link with AOSP
    # ==================================================
    - name: Pre-compile core files with OLLVM
      run: |
        echo "=== PRE-COMPILING CORE FILES WITH OLLVM ==="
        cd ${{ inputs.module_dir }}
        
        # Build OLLVM flags
        OLLVM_FLAGS=""
        
        if [ "${{ inputs.enable_fla }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -fla"
        fi
        
        if [ "${{ inputs.enable_split }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -split -mllvm -split_num=${{ inputs.split_num }}"
        fi
        
        if [ "${{ inputs.enable_sub }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -sub -mllvm -sub_loop=${{ inputs.sub_loop }}"
        fi
        
        if [ "${{ inputs.enable_bcf }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -bcf -mllvm -bcf_loop=${{ inputs.bcf_loop }} -mllvm -bcf_prob=${{ inputs.bcf_prob }}"
        fi
        
        if [ "${{ inputs.enable_sobf }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -sobf"
        fi
        
        echo "OLLVM Flags: $OLLVM_FLAGS"
        
        # Find AOSP clang to get correct flags
        AOSP_CLANG=$(which clang)
        echo "AOSP Clang: $AOSP_CLANG"
        
        # Step 1: Get exact compile command from kernel build system
        echo ""
        echo "=== Getting kernel compile flags ==="
        
        # Clean first
        make -C $KERNEL_SRC M=$PWD clean 2>/dev/null || true
        
        # Build one file to capture command
        make -C $KERNEL_SRC M=$PWD V=1 src/core/wuwa.o 2>&1 | head -50 > compile_cmd.txt
        
        # Extract the compile command
        COMPILE_CMD=$(grep "clang.*-c.*wuwa\.c" compile_cmd.txt | head -1)
        
        if [ -n "$COMPILE_CMD" ]; then
            echo "Captured compile command:"
            echo "$COMPILE_CMD"
            
            # Remove the actual compiler and input/output files, keep flags
            # Extract flags between 'clang' and '-c'
            KERNEL_FLAGS=$(echo "$COMPILE_CMD" | sed 's/^[^ ]*clang[^ ]* //' | sed 's/-c [^ ]*//' | sed 's/-o [^ ]*//')
            echo "Extracted kernel flags: $KERNEL_FLAGS"
        else
            echo "Using default kernel flags"
            KERNEL_FLAGS="--target=aarch64-linux-gnu -D__KERNEL__ -nostdinc"
        fi
        
        # Step 2: Pre-compile selected files with OLLVM
        echo ""
        echo "=== Pre-compiling files with OLLVM ==="
        
        # Files to compile with OLLVM
        OLLVM_FILES=(
            "src/core/wuwa.c"
            "src/utils/wuwa_utils.c"
            "src/mm/wuwa_page_walk.c"
            "src/mm/wuwa_bindproc.c"
            "src/hook/wuwa_safe_signal.c"
        )
        
        OLLVM_CLANG="$PWD/android-ollvm/bin/clang"
        
        for file in "${OLLVM_FILES[@]}"; do
            if [ ! -f "$file" ]; then
                echo "⚠️ File not found: $file"
                continue
            fi
            
            obj_file="${file%.c}.o"
            echo ""
            echo "Compiling $file -> $obj_file"
            
            # Build compile command with OLLVM
            CMD="$OLLVM_CLANG"
            CMD="$CMD -c $file -o $obj_file"
            CMD="$CMD $KERNEL_FLAGS"
            CMD="$CMD $OLLVM_FLAGS"
            CMD="$CMD -I./src/core -I./src/utils -I./src/mm -I./src/hook -I./src/net -I./src/ioctl -I./src/inlinehook -I./src/proc"
            CMD="$CMD -Wno-implicit-function-declaration -Wno-strict-prototypes -Wno-int-conversion"
            CMD="$CMD -Wno-gcc-compat -Wno-declaration-after-statement -Wno-unused-function"
            CMD="$CMD -Wno-unused-variable -Wno-unused-label"
            CMD="$CMD -DHIDE_SELF_MODULE -DBUILD_HIDE_SIGNAL -DBUILD_NO_CFI -DENABLE_WUWA_LOGS"
            
            echo "Running: $CMD"
            
            if eval "$CMD" 2>&1; then
                if [ -f "$obj_file" ]; then
                    echo "✅ Success: $obj_file"
                    # Mark as read-only so kernel won't rebuild
                    chmod 444 "$obj_file"
                else
                    echo "❌ Object file not created"
                fi
            else
                echo "❌ Compilation failed"
            fi
        done
        
        # Save OLLVM flags for later
        echo "OLLVM_FLAGS='$OLLVM_FLAGS'" >> $GITHUB_ENV

    # ==================================================
    # Build rest of module with AOSP toolchain
    # ==================================================
    - name: Build module with AOSP toolchain
      run: |
        echo "=== BUILDING MODULE WITH AOSP TOOLCHAIN ==="
        cd ${{ inputs.module_dir }}
        
        # The kernel build system will:
        # 1. Skip already compiled .o files (they exist, are newer than .c)
        # 2. Compile remaining .c files with AOSP clang
        # 3. Link everything with AOSP linker
        
        echo "Starting kernel build..."
        
        # Build with verbose output
        make -C $KERNEL_SRC M=$PWD V=1 modules 2>&1 | tee build.log
        
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "✅ Build successful!"
        else
            echo "❌ Build failed"
            echo "Last 50 lines:"
            tail -50 build.log
            exit 1
        fi
        
        # Check what happened
        echo ""
        echo "=== Build Analysis ==="
        
        # Count OLLVM vs AOSP compilations
        OLLVM_COMPILES=$(grep -c "android-ollvm/bin/clang" build.log 2>/dev/null || echo "0")
        AOSP_COMPILES=$(grep -c "clang.*-c.*\.c" build.log 2>/dev/null || echo "0")
        
        echo "OLLVM compilations: $OLLVM_COMPILES"
        echo "AOSP compilations: $AOSP_COMPILES"
        
        if [ $OLLVM_COMPILES -eq 0 ] && [ $AOSP_COMPILES -gt 0 ]; then
            echo "✅ Good: Kernel used AOSP clang for compilation"
            echo "Our pre-compiled OLLVM objects were used as-is"
        fi
        
        # Find the module
        KO_FILE=$(find . -name "*.ko" -type f | head -1)
        if [ -z "$KO_FILE" ]; then
            echo "❌ No .ko file found!"
            exit 1
        fi
        
        echo ""
        echo "✅ Module built: $KO_FILE"
        echo "Size: $(du -h "$KO_FILE" | cut -f1)"

    # ==================================================
    # Verify OLLVM obfuscation
    # ==================================================
    - name: Verify obfuscation
      run: |
        cd ${{ inputs.module_dir }}
        
        echo "=== VERIFYING OBFUSCATION ==="
        
        # Check OLLVM object files
        echo ""
        echo "OLLVM object files:"
        for obj in src/core/wuwa.o src/utils/wuwa_utils.o src/mm/wuwa_page_walk.o src/mm/wuwa_bindproc.o src/hook/wuwa_safe_signal.o; do
            if [ -f "$obj" ]; then
                SIZE=$(stat -c%s "$obj" 2>/dev/null || stat -f%z "$obj")
                echo "  $obj: $((SIZE/1024)) KB"
            fi
        done
        
        echo ""
        echo "AOSP-compiled object files (for comparison):"
        for obj in src/net/wuwa_sock.o src/net/wuwa_protocol.o src/ioctl/wuwa_ioctl.o; do
            if [ -f "$obj" ]; then
                SIZE=$(stat -c%s "$obj" 2>/dev/null || stat -f%z "$obj")
                echo "  $obj: $((SIZE/1024)) KB"
            fi
        done
        
        # Simple check: OLLVM objects should be larger
        echo ""
        echo "Note: OLLVM-obfuscated objects are typically larger due to added complexity."

    # ==================================================
    # Package module
    # ==================================================
    - name: Package module
      run: |
        cd ${{ inputs.module_dir }}
        
        KO_FILE=$(find . -name "*.ko" -type f | head -1)
        if [ -z "$KO_FILE" ]; then
            echo "❌ No .ko file found!"
            exit 1
        fi
        
        # Create output
        mkdir -p /github/workspace/out
        TS=$(date +'%Y%m%d_%H%M%S')
        OUT_NAME="wuwa_${{ matrix.kmi }}_${{ inputs.obfuscation_level }}_$TS.ko"
        OUT_PATH="/github/workspace/out/$OUT_NAME"
        
        cp "$KO_FILE" "$OUT_PATH"
        
        # Strip
        if command -v llvm-strip &> /dev/null; then
            llvm-strip -d "$OUT_PATH"
        elif command -v strip &> /dev/null; then
            strip --strip-debug "$OUT_PATH"
        fi
        
        echo "✅ Output: $OUT_NAME"
        echo "Size: $(du -h "$OUT_PATH" | cut -f1)"

    # ==================================================
    # Upload artifacts
    # ==================================================
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-${{ inputs.obfuscation_level }}
        path: /github/workspace/out/*.ko
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-logs
        path: ${{ inputs.module_dir }}/build.log
