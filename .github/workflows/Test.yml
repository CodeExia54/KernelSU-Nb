name: Build Kernel Module ddk with DeClang Obfuscation

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'exianb-dev'
      obfuscate:
        description: 'Enable DeClang obfuscation'
        type: boolean
        default: true

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android14-6.1  # Test with ONE first

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Setup DeClang (if obfuscation enabled)
      if: ${{ inputs.obfuscate == true }}
      id: setup-declang
      run: |
        echo "=== SETTING UP DECLANG FOR OBFUSCATION ==="
        
        # Install tools
        apt-get update
        apt-get install -y wget unzip
        
        # Download DeClang
        wget -q https://github.com/DeNA/DeClang/releases/download/swift5.10-v1.0.0/Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        
        # Extract
        unzip -q Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        
        # Find clang - search recursively
        CLANG_PATH=$(find . -type f -name "clang" | head -1)
        
        if [ -z "$CLANG_PATH" ]; then
            echo "ERROR: Cannot find clang in DeClang package!"
            find . -type f | head -30
            exit 1
        fi
        
        echo "Found DeClang at: $CLANG_PATH"
        chmod +x "$CLANG_PATH"
        
        # Test it
        echo "DeClang version:"
        "$CLANG_PATH" --version || echo "Note: May need QEMU emulation"
        
        # Save the path
        echo "CLANG_PATH=$(realpath "$CLANG_PATH")" >> $GITHUB_OUTPUT
        
    - name: Build ${{ inputs.module_dir }}.ko
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko for KMI: ${{ matrix.kmi }} ==="
        
        # Check if obfuscation is enabled
        if [[ "${{ inputs.obfuscate }}" == "true" ]]; then
            echo "Using DeClang with obfuscation"
            
            DECLANG_CLANG="${{ steps.setup-declang.outputs.CLANG_PATH }}"
            
            if [ -z "$DECLANG_CLANG" ] || [ ! -f "$DECLANG_CLANG" ]; then
                echo "ERROR: DeClang not setup properly!"
                exit 1
            fi
            
            # Create a simple wrapper script
            cat > /tmp/declang_wrapper << EOF
#!/bin/bash
OBF_FLAGS="-mllvm -fla -mllvm -sub"
$DECLANG_CLANG "\$@" \$OBF_FLAGS
EOF
            
            chmod +x /tmp/declang_wrapper
            
            # Build with DeClang
            make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} modules \
                CC="/tmp/declang_wrapper" \
                HOSTCC="/tmp/declang_wrapper" \
                V=1 2>&1 | tail -30 || echo "Build may have warnings"
                
        else
            # Build normally without obfuscation
            echo "Building without obfuscation (normal DDK compiler)"
            make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} modules
        fi
        
        echo "=== Build completed ==="

        # Create output directory
        mkdir -p /github/workspace/out
        
        # Find the first .ko file in the module directory
        KO_FILE=$(find "${{ inputs.module_dir }}" -name "*.ko" -type f | head -1)
        
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        if [[ "${{ inputs.obfuscate }}" == "true" ]]; then
            OUTPUT_NAME="OBFUSCATED-${{ inputs.module_dir }}-${{ matrix.kmi }}-$TIMESTAMP.ko"
        else
            OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-$TIMESTAMP.ko"
        fi
        
        if [ -n "$KO_FILE" ] && [ -f "$KO_FILE" ]; then
            cp "$KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
            echo "Copied: $KO_FILE -> /github/workspace/out/$OUTPUT_NAME"
            echo "Size: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"
            
            # Strip debug symbols
            if command -v llvm-strip >/dev/null; then
                llvm-strip -d "/github/workspace/out/$OUTPUT_NAME"
                echo "Size after stripping: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"
            fi
        else
            echo "ERROR: No .ko file found in ${{ inputs.module_dir }}/!"
            echo "Available files in ${{ inputs.module_dir }}/:"
            ls -la "${{ inputs.module_dir }}/" || echo "Directory doesn't exist"
            exit 1
        fi

    - name: Upload ${{ inputs.module_dir }}.ko artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-${{ github.run_id }}
        path: /github/workspace/out/${{ inputs.module_dir }}-${{ matrix.kmi }}-*.ko
