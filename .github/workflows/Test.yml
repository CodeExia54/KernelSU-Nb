name: Build Kernel Module ddk (OLLVM Levels)

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory'
        required: true
        type: choice
        options:
          - wuwa
        default: 'wuwa'

      # OLLVM Configuration Options
      obfuscation_level:
        description: 'OLLVM obfuscation strength'
        required: true
        type: choice
        options:
          - easy
          - medium
          - hard
          - extreme
        default: easy

      enable_fla:
        description: 'Enable Control Flow Flattening'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'yes'

      enable_split:
        description: 'Enable Basic Block Splitting'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

      split_num:
        description: 'Splitting iterations (1-5)'
        required: true
        type: string
        default: '3'

      enable_sub:
        description: 'Enable Instruction Substitution'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

      sub_loop:
        description: 'Substitution iterations (1-5)'
        required: true
        type: string
        default: '2'

      enable_bcf:
        description: 'Enable Bogus Control Flow'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

      bcf_loop:
        description: 'BCF iterations (1-5)'
        required: true
        type: string
        default: '2'

      bcf_prob:
        description: 'BCF probability (1-100)'
        required: true
        type: string
        default: '40'

      enable_sobf:
        description: 'Enable String Obfuscation'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }} (${{ inputs.obfuscation_level }}) for ${{ matrix.kmi }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    # ==================================================
    # Install unzip and required tools
    # ==================================================
    - name: Install required tools
      run: |
        apt-get update
        apt-get install -y unzip file binutils findutils

    # ==================================================
    # Extract OLLVM toolchain directly
    # ==================================================
    - name: Extract OLLVM toolchain
      run: |
        set -e
        cd ${{ inputs.module_dir }}
        
        echo "=== Current directory structure ==="
        ls -la
        
        echo "=== Extracting OLLVM ZIPs ==="
        
        # Extract first ZIP directly
        echo "Extracting android-ollvm.zip..."
        unzip -q android-ollvm.zip
        
        # Extract second ZIP directly (will merge with first)
        echo "Extracting android-ollvm1.zip..."
        unzip -q -o android-ollvm1.zip
        
        echo "=== After extraction structure ==="
        ls -la android-ollvm/
        
        # Fix permissions on clang binary
        echo "=== Fixing permissions ==="
        chmod -R 755 android-ollvm/bin/
        
        echo "OLLVM clang version:"
        ./android-ollvm/bin/clang --version | head -5

    # ==================================================
    # Setup OLLVM environment and test in same step
    # ==================================================
    - name: Setup and test OLLVM environment
      run: |
        echo "=== SETTING UP AND TESTING OLLVM ENVIRONMENT ==="
        cd ${{ inputs.module_dir }}
        
        # Build OLLVM flags from user inputs
        OLLVM_FLAGS=""
        
        # Control Flow Flattening
        if [ "${{ inputs.enable_fla }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -fla"
        fi
        
        # Basic Block Splitting
        if [ "${{ inputs.enable_split }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -split -mllvm -split_num=${{ inputs.split_num }}"
        fi
        
        # Instruction Substitution
        if [ "${{ inputs.enable_sub }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -sub -mllvm -sub_loop=${{ inputs.sub_loop }}"
        fi
        
        # Bogus Control Flow
        if [ "${{ inputs.enable_bcf }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -bcf -mllvm -bcf_loop=${{ inputs.bcf_loop }} -mllvm -bcf_prob=${{ inputs.bcf_prob }}"
        fi
        
        # String Obfuscation
        if [ "${{ inputs.enable_sobf }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -sobf"
        fi
        
        echo "OLLVM Flags: $OLLVM_FLAGS"
        
        # Set OLLVM directory
        OLLVM_DIR="$PWD/android-ollvm"
        echo "OLLVM Directory: $OLLVM_DIR"
        
        # Set compiler paths
        OLLVM_CC="$OLLVM_DIR/bin/clang"
        OLLVM_CXX="$OLLVM_DIR/bin/clang++"
        OLLVM_AR="$OLLVM_DIR/bin/llvm-ar"
        
        echo "Compiler paths:"
        echo "  CC: $OLLVM_CC"
        echo "  CXX: $OLLVM_CXX"
        echo "  AR: $OLLVM_AR"
        
        # Test 1: Basic compilation
        echo ""
        echo "=== Test 1: Basic compilation ==="
        echo "int main() { return 0; }" > test.c
        
        if "$OLLVM_CC" -c test.c -o test.o; then
          echo "✅ Basic compilation successful"
          rm -f test.c test.o
        else
          echo "❌ Basic compilation failed"
          rm -f test.c test.o
          exit 1
        fi
        
        # Test 2: OLLVM flag test
        echo ""
        echo "=== Test 2: OLLVM flag test ==="
        echo "int test() { return 42; }" > test2.c
        
        if "$OLLVM_CC" -mllvm -fla -c test2.c -o test2.o 2>&1; then
          echo "✅ OLLVM -fla flag works"
          rm -f test2.c test2.o
        else
          echo "⚠️ OLLVM -fla flag test failed"
          echo "Testing without flag..."
          if "$OLLVM_CC" -c test2.c -o test2.o; then
            echo "✅ Clang works but OLLVM flags might not be supported"
          else
            echo "❌ Clang itself doesn't work"
          fi
          rm -f test2.c test2.o
        fi
        
        # Test 3: Check version
        echo ""
        echo "=== Test 3: Check OLLVM version ==="
        "$OLLVM_CC" --version | head -3
        
        # Set environment variables for next steps
        echo ""
        echo "=== Setting environment variables ==="
        
        # Write environment variables to file for next steps
        echo "OLLVM_DIR=$OLLVM_DIR" >> $GITHUB_ENV
        echo "OLLVM_CC=$OLLVM_CC" >> $GITHUB_ENV
        echo "OLLVM_CXX=$OLLVM_CXX" >> $GITHUB_ENV
        echo "OLLVM_AR=$OLLVM_AR" >> $GITHUB_ENV
        echo "OLLVM_FLAGS='$OLLVM_FLAGS'" >> $GITHUB_ENV
        
        # Also set the main compiler variables
        echo "CC=$OLLVM_CC" >> $GITHUB_ENV
        echo "CXX=$OLLVM_CXX" >> $GITHUB_ENV
        echo "AR=$OLLVM_AR" >> $GITHUB_ENV
        
        # Kernel build specific
        echo "LLVM=1" >> $GITHUB_ENV
        echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV
        
        # Set library paths if OLLVM has libraries
        if [ -d "$OLLVM_DIR/lib" ]; then
          echo "Setting OLLVM library paths..."
          echo "LD_LIBRARY_PATH=$OLLVM_DIR/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$OLLVM_DIR/lib:$LIBRARY_PATH" >> $GITHUB_ENV
        fi
        
        echo "✅ OLLVM setup complete!"

    # ==================================================
    # Build module with OLLVM clang
    # ==================================================
    - name: Build module with OLLVM clang
      env:
        # These will be overridden by GITHUB_ENV from previous step
        CC: ${{ env.OLLVM_CC }}
        CXX: ${{ env.OLLVM_CXX }}
        AR: ${{ env.OLLVM_AR }}
        OLLVM_FLAGS: ${{ env.OLLVM_FLAGS }}
        LLVM: ${{ env.LLVM }}
        CLANG_TRIPLE: ${{ env.CLANG_TRIPLE }}
      run: |
        echo "=== BUILDING MODULE WITH OLLVM CLANG ==="
        echo "Module directory: ${{ inputs.module_dir }}"
        echo "Kernel source: $KERNEL_SRC"
        echo "Using compiler: $CC"
        echo "OLLVM flags: $OLLVM_FLAGS"
        
        cd ${{ inputs.module_dir }}
        
        # Verify compiler is set
        echo ""
        echo "=== Verifying compiler setup ==="
        echo "CC: $CC"
        echo "which clang: $(which clang 2>/dev/null || echo 'not in PATH')"
        echo "ls -la \$CC: $(ls -la "$CC" 2>/dev/null || echo 'not found')"
        
        # Clean first
        echo ""
        echo "=== Cleaning previous build ==="
        make -C $KERNEL_SRC M=$PWD clean 2>&1 | tail -10 || true
        
        # Build with verbose output
        echo ""
        echo "=== Starting build ==="
        
        # First, let's see what the kernel build system uses
        echo "Checking kernel build configuration..."
        make -C $KERNEL_SRC M=$PWD V=1 dummy 2>&1 | grep -i "cc\|clang\|compiler" | head -5 || true
        
        # Build the module
        echo ""
        echo "Building module..."
        
        # Add OLLVM flags to kernel build flags
        export KBUILD_CFLAGS_MODULE="$OLLVM_FLAGS"
        
        make -C $KERNEL_SRC M=$PWD V=1 modules 2>&1 | tee build.log
        
        BUILD_STATUS=${PIPESTATUS[0]}
        
        # Check build result
        if [ $BUILD_STATUS -eq 0 ]; then
            echo "✅ Build completed successfully!"
        else
            echo "❌ Build failed"
            echo "Last 100 lines of build log:"
            tail -100 build.log
            exit 1
        fi
        
        # Check if OLLVM was used
        echo ""
        echo "=== Checking OLLVM usage ==="
        if grep -q "android-ollvm/bin/clang" build.log; then
            echo "✅ OLLVM clang was used in build"
            echo "Sample compile commands:"
            grep "android-ollvm/bin/clang" build.log | head -2
        else
            echo "⚠️ OLLVM clang not detected in build log"
            echo "Checking what compiler was used:"
            grep "clang" build.log | head -3 || echo "No clang commands found"
        fi
        
        # Find the kernel module
        KO_FILE=$(find . -name "*.ko" -type f | head -1)
        if [ -z "$KO_FILE" ]; then
            echo "❌ ERROR: No .ko file found!"
            exit 1
        fi
        
        echo ""
        echo "✅ Found kernel module: $KO_FILE"
        echo "Size: $(du -h "$KO_FILE" | cut -f1)"

    # ==================================================
    # Package the module
    # ==================================================
    - name: Package module
      run: |
        cd ${{ inputs.module_dir }}
        
        KO_FILE=$(find . -name "*.ko" -type f | head -1)
        if [ -z "$KO_FILE" ]; then
            echo "❌ No .ko file found!"
            exit 1
        fi
        
        # Create output directory
        mkdir -p /github/workspace/out
        
        # Generate output filename
        TS=$(date +'%Y%m%d-%H%M%S')
        OUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-${{ inputs.obfuscation_level }}-$TS.ko"
        OUT_PATH="/github/workspace/out/$OUT_NAME"
        
        # Copy module
        cp "$KO_FILE" "$OUT_PATH"
        
        # Strip debug symbols if possible
        echo "Before strip: $(du -h "$OUT_PATH" | cut -f1)"
        
        if command -v llvm-strip &> /dev/null; then
            llvm-strip -d "$OUT_PATH"
            echo "Stripped with llvm-strip"
        elif command -v strip &> /dev/null; then
            strip --strip-debug "$OUT_PATH"
            echo "Stripped with strip"
        else
            echo "No strip tool found"
        fi
        
        echo "After strip: $(du -h "$OUT_PATH" | cut -f1)"
        
        # Create build info
        BUILD_INFO="/github/workspace/out/build-info.txt"
        echo "Build Information" > "$BUILD_INFO"
        echo "================" >> "$BUILD_INFO"
        echo "Module: ${{ inputs.module_dir }}" >> "$BUILD_INFO"
        echo "KMI: ${{ matrix.kmi }}" >> "$BUILD_INFO"
        echo "OLLVM Level: ${{ inputs.obfuscation_level }}" >> "$BUILD_INFO"
        echo "Build Time: $(date)" >> "$BUILD_INFO"
        
        echo ""
        echo "✅ Module packaged: $OUT_NAME"

    # ==================================================
    # Upload artifact
    # ==================================================
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-${{ inputs.obfuscation_level }}
        path: |
          /github/workspace/out/*.ko
          /github/workspace/out/build-info.txt
        
    # ==================================================
    # Upload build logs
    # ==================================================
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-logs
        path: ${{ inputs.module_dir }}/build.log
