name: Build Kernel Module with OLLVM

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'exianb-dev'
      obfuscation_level:
        description: 'OLLVM obfuscation level'
        required: false
        default: 'medium'
        type: choice
        options:
        - none
        - light
        - medium
        - heavy
      use_custom_clang:
        description: 'Use custom OLLVM clang from ZIP'
        required: false
        default: 'false'
        type: boolean

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Install unzip in container
      run: |
        echo "=== Installing unzip ==="
        apt-get update && apt-get install -y unzip

    - name: Extract OLLVM Toolchain
      if: ${{ inputs.use_custom_clang }}
      run: |
        echo "=== Extracting OLLVM Toolchain ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Clean any existing ollvm directory
        rm -rf /usr/local/ollvm
        mkdir -p /usr/local/ollvm
        
        # Find all clang*.zip files
        echo "Looking for ZIP files in $MODULE_DIR/"
        ZIP_FILES=($(find "$MODULE_DIR" -name "clang*.zip" | sort))
        
        if [ ${#ZIP_FILES[@]} -eq 0 ]; then
          echo "❌ No clang*.zip files found!"
          exit 1
        fi
        
        echo "Found ${#ZIP_FILES[@]} ZIP file(s):"
        printf '%s\n' "${ZIP_FILES[@]}"
        
        # Extract each ZIP directly to /usr/local/ollvm
        for zip_file in "${ZIP_FILES[@]}"; do
          echo ""
          echo "=== Extracting $(basename "$zip_file") ==="
          
          # Extract preserving directory structure
          unzip -q "$zip_file" -d /usr/local/ollvm/
        done
        
        # Make everything in bin executable
        if [ -d "/usr/local/ollvm/bin" ]; then
          chmod -R +x /usr/local/ollvm/bin/ 2>/dev/null || true
        fi
        
        # Show final structure
        echo ""
        echo "=== Toolchain Structure ==="
        
        if [ -d "/usr/local/ollvm/bin" ]; then
          echo "Files in /usr/local/ollvm/bin/:"
          ls -la /usr/local/ollvm/bin/
        else
          echo "⚠️ No bin directory found!"
          exit 1
        fi
        
        # Test essential tools
        echo ""
        echo "=== Testing Essential Tools ==="
        
        ESSENTIAL_TOOLS=("clang" "ld.lld" "llvm-ar" "llvm-nm" "llvm-objcopy" "llvm-strip")
        for tool in "${ESSENTIAL_TOOLS[@]}"; do
          if [ -f "/usr/local/ollvm/bin/$tool" ]; then
            echo "✅ $tool: Found"
          else
            echo "❌ $tool: MISSING - This may cause build issues"
          fi
        done
        
        # Test clang
        echo ""
        echo "=== Testing clang ==="
        /usr/local/ollvm/bin/clang --version 2>&1 | head -2 || echo "❌ clang test failed"
        
        # Add to PATH
        echo 'export PATH=/usr/local/ollvm/bin:$PATH' >> /etc/profile.d/ollvm.sh
        export PATH=/usr/local/ollvm/bin:$PATH
        
        echo "OLLVM_TOOLCHAIN_INSTALLED=true" >> $GITHUB_ENV

    - name: Diagnostic - Test Toolchain Compatibility
      if: ${{ inputs.use_custom_clang }}
      run: |
        echo "=== Toolchain Compatibility Test ==="
        
        # Test basic compilation
        echo ""
        echo "1. Testing basic compilation:"
        echo 'int test() { return 0; }' > /tmp/simple.c
        if /usr/local/ollvm/bin/clang -c /tmp/simple.c -o /tmp/simple.o 2>&1; then
          echo "✅ Basic compilation works"
        else
          echo "❌ Basic compilation failed"
        fi
        
        # Test OLLVM flags
        echo ""
        echo "2. Testing OLLVM flags:"
        echo 'int test() { int x = 5; return x * 2; }' > /tmp/ollvm_test.c
        if /usr/local/ollvm/bin/clang -mllvm -fla -c /tmp/ollvm_test.c -o /tmp/ollvm_test.o 2>&1; then
          echo "✅ OLLVM flags work"
        else
          echo "❌ OLLVM flags failed"
        fi
        
        # Test linker
        echo ""
        echo "3. Testing linker:"
        if /usr/local/ollvm/bin/ld.lld --version 2>&1 | head -1; then
          echo "✅ Linker works"
        else
          echo "❌ Linker test failed"
        fi

    - name: Build with OLLVM Toolchain
      if: ${{ inputs.use_custom_clang }}
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko with OLLVM ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Verify essential tools
        if [ ! -f "/usr/local/ollvm/bin/clang" ]; then
          echo "❌ clang not found!"
          exit 1
        fi
        
        if [ ! -f "/usr/local/ollvm/bin/ld.lld" ]; then
          echo "⚠️ ld.lld not found - using system linker (may cause LTO issues)"
        fi
        
        # Set OLLVM flags
        case "${{ inputs.obfuscation_level }}" in
          "light")
            OLLVM_FLAGS="-mllvm -fla"
            echo "OLLVM Level: light (-fla)"
            ;;
          "medium")
            OLLVM_FLAGS="-mllvm -fla -mllvm -sub"
            echo "OLLVM Level: medium (-fla -sub)"
            ;;
          "heavy")
            OLLVM_FLAGS="-mllvm -fla -mllvm -sub -mllvm -bcf"
            echo "OLLVM Level: heavy (-fla -sub -bcf)"
            ;;
          *)
            OLLVM_FLAGS=""
            echo "OLLVM Level: none"
            ;;
        esac
        
        echo ""
        echo "=== Build Configuration ==="
        echo "Using OLLVM toolchain from: /usr/local/ollvm/bin/"
        echo "OLLVM Flags: $OLLVM_FLAGS"
        
        # Clean first
        make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" clean 2>/dev/null || true
        
        # Method 1: Use OLLVM toolchain with LTO disabled
        echo ""
        echo "=== Method 1: Build with LTO disabled ==="
        
        set +e
        make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules \
          CC="/usr/local/ollvm/bin/clang $OLLVM_FLAGS -fno-lto" \
          LD="/usr/local/ollvm/bin/ld.lld" \
          AR="/usr/local/ollvm/bin/llvm-ar" \
          NM="/usr/local/ollvm/bin/llvm-nm" \
          OBJCOPY="/usr/local/ollvm/bin/llvm-objcopy" \
          STRIP="/usr/local/ollvm/bin/llvm-strip" \
          HOSTCC="gcc" \
          HOSTCXX="g++" \
          -j$(nproc) 2>&1 | tee /tmp/build.log
        BUILD_EXIT=$?
        set -e
        
        echo ""
        echo "Build exit code: $BUILD_EXIT"
        
        if [ $BUILD_EXIT -ne 0 ] || [ ! -f "$MODULE_DIR"/*.ko ]; then
          echo "❌ Method 1 failed"
          
          # Method 2: Try with different approach
          echo ""
          echo "=== Method 2: Try alternative build ==="
          
          make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" clean 2>/dev/null || true
          
          # Sometimes we need to disable LTO at kernel config level
          make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules \
            CC="/usr/local/ollvm/bin/clang $OLLVM_FLAGS" \
            LD="/usr/local/ollvm/bin/ld.lld" \
            AR="/usr/local/ollvm/bin/llvm-ar" \
            CONFIG_LTO=n \
            CONFIG_LTO_CLANG=n \
            CONFIG_THINLTO=n \
            -j$(nproc) 2>&1 | tee /tmp/build_alt.log
          
          cp /tmp/build_alt.log /tmp/build.log
        fi

    - name: Build with Default Toolchain
      if: ${{ !inputs.use_custom_clang }}
      run: |
        echo "=== Building with Default Toolchain ==="
        MODULE_DIR="${{ inputs.module_dir }}"
        
        make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules -j$(nproc) 2>&1 | tee /tmp/build.log

    - name: Check Build Result
      run: |
        echo "=== Checking Build Result ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Find the .ko file
        KO_FILE=$(find "$MODULE_DIR" -name "*.ko" -type f | head -1)
        
        if [ -f "$KO_FILE" ]; then
          echo "✅ Build successful! Found: $KO_FILE"
          echo "FILE_EXISTS=true" >> $GITHUB_ENV
          echo "KO_FILE_PATH=$KO_FILE" >> $GITHUB_ENV
          
          # Show module info
          echo ""
          echo "=== Module Information ==="
          ls -lh "$KO_FILE"
          
          # Check OLLVM usage
          if [ "${{ inputs.use_custom_clang }}" = "true" ]; then
            echo ""
            echo "=== OLLVM Verification ==="
            if grep -q "mllvm" /tmp/build.log 2>/dev/null; then
              echo "✅ OLLVM flags were used in build"
              # Show which flags were used
              grep "mllvm" /tmp/build.log | head -2
            else
              echo "⚠️ No OLLVM flags found in build log"
            fi
            
            # Check which tools were used
            echo ""
            echo "=== Tool Usage ==="
            if grep -q "/usr/local/ollvm/bin/clang" /tmp/build.log 2>/dev/null; then
              echo "✅ OLLVM clang was used"
            fi
            if grep -q "/usr/local/ollvm/bin/ld.lld" /tmp/build.log 2>/dev/null; then
              echo "✅ OLLVM ld.lld was used"
            fi
          fi
        else
          echo "❌ Build failed! No .ko file found."
          echo "FILE_EXISTS=false" >> $GITHUB_ENV
          
          # Show error summary
          echo ""
          echo "=== Error Summary ==="
          tail -30 /tmp/build.log 2>/dev/null | grep -i "error\|fail\|warning" || echo "No specific errors found"
        fi

    - name: Process Successful Build
      if: env.FILE_EXISTS == 'true'
      run: |
        echo "=== Processing Successful Build ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        KO_FILE="${{ env.KO_FILE_PATH }}"
        
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        
        # Create descriptive filename
        if [ "${{ inputs.use_custom_clang }}" = "true" ]; then
          OUTPUT_NAME="$MODULE_DIR-${{ matrix.kmi }}-ollvm-${{ inputs.obfuscation_level }}-$TIMESTAMP.ko"
        else
          OUTPUT_NAME="$MODULE_DIR-${{ matrix.kmi }}-default-$TIMESTAMP.ko"
        fi
        
        mkdir -p /github/workspace/out
        cp "$KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
        
        # Create build info file
        BUILD_INFO="/github/workspace/out/build-info-$OUTPUT_NAME.txt"
        {
          echo "=== Build Information ==="
          echo "Module: $MODULE_DIR"
          echo "KMI: ${{ matrix.kmi }}"
          echo "Timestamp: $(date)"
          echo "Output: $OUTPUT_NAME"
          echo "Size: $(stat -c%s "/github/workspace/out/$OUTPUT_NAME") bytes"
          
          if [ "${{ inputs.use_custom_clang }}" = "true" ]; then
            echo ""
            echo "=== OLLVM Configuration ==="
            echo "OLLVM Level: ${{ inputs.obfuscation_level }}"
            echo "Toolchain: /usr/local/ollvm/bin/"
            echo "Clang Version: $(/usr/local/ollvm/bin/clang --version 2>&1 | head -1)"
            echo "LD Version: $(/usr/local/ollvm/bin/ld.lld --version 2>&1 | head -1 2>/dev/null || echo 'Not available')"
            
            # Check if OLLVM was actually used
            if grep -q "mllvm" /tmp/build.log 2>/dev/null; then
              echo "OLLVM Used: YES"
            else
              echo "OLLVM Used: NO (flags not found in build log)"
            fi
          fi
        } > "$BUILD_INFO"
        
        echo "✅ Module saved: $OUTPUT_NAME"
        echo "✅ Build info saved: build-info-$OUTPUT_NAME.txt"
        
        echo "ARTIFACT_PATH=/github/workspace/out/$OUTPUT_NAME" >> $GITHUB_ENV

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}
        path: |
          ${{ env.ARTIFACT_PATH }}
          /github/workspace/out/build-info-*.txt
        retention-days: 7
      if: env.FILE_EXISTS == 'true'

    - name: Upload Build Logs
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-logs
        path: /tmp/build*.log
        retention-days: 7
      if: always()
