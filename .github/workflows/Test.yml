name: Build Kernel Module with DeClang OLLVM

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - wuwa
        - hello-world
        default: 'wuwa'
      obfuscation_level:
        description: 'OLLVM obfuscation level'
        required: false
        default: 'medium'
        type: choice
        options:
        - none
        - light
        - medium
        - heavy
      use_declang:
        description: 'Use DeClang or default clang'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi: [android13-5.10, android14-5.15]

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - uses: actions/checkout@v4
    
    - name: Install unzip
      run: apt-get update && apt-get install -y unzip

    - name: Setup DECLANG_HOME Environment
      if: ${{ inputs.obfuscation_level != 'none' && inputs.use_declang == 'true' }}
      run: |
        echo "=== Setting up DECLANG_HOME ==="
        mkdir -p /tmp/.DeClang
        echo "DECLANG_HOME=/tmp/.DeClang" >> $GITHUB_ENV

    - name: Download and Setup DeClang
      if: ${{ inputs.obfuscation_level != 'none' && inputs.use_declang == 'true' }}
      env:
        DECLANG_HOME: /tmp/.DeClang
      run: |
        echo "=== Downloading DeClang ==="
        
        wget -q https://github.com/DeNA/DeClang/releases/download/swift5.10-v1.0.0/Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        unzip -q Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        
        DECLANG_CLANG="$(pwd)/Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang"
        chmod +x "$DECLANG_CLANG"
        
        echo "✅ DeClang path: $DECLANG_CLANG"
        echo "DECLANG_CLANG=$DECLANG_CLANG" >> $GITHUB_ENV
        
        # Test OLLVM flags
        echo ""
        echo "=== Testing DeClang OLLVM ==="
        echo 'int x;' | "$DECLANG_CLANG" -x c -c - -o /dev/null -mllvm -fla 2>&1 | \
          grep -v "Open logFile Failed" && echo "✅ -mllvm -fla works" || echo "❌ -mllvm -fla failed"

    - name: Test Your Uploaded Clang
      if: ${{ inputs.obfuscation_level != 'none' }}
      run: |
        echo "=== Checking for your uploaded DeClang ==="
        
        # Check if you uploaded your built clang
        if [ -f "${{ inputs.module_dir }}/clang" ]; then
          YOUR_CLANG="$(pwd)/${{ inputs.module_dir }}/clang"
          chmod +x "$YOUR_CLANG"
          
          echo "✅ Found your uploaded clang at: $YOUR_CLANG"
          
          # Test it
          echo ""
          echo "=== Testing your clang ==="
          "$YOUR_CLANG" --version 2>&1 | head -1
          echo 'int x;' | "$YOUR_CLANG" -x c -c - -o /dev/null -mllvm -fla 2>&1 | \
            grep -v "Open logFile Failed" && echo "✅ Your clang works!" || echo "❌ Your clang has issues"
          
          # Prefer your clang if it works
          echo "YOUR_CLANG=$YOUR_CLANG" >> $GITHUB_ENV
        else
          echo "⚠️ No uploaded clang found at ${{ inputs.module_dir }}/clang"
        fi

    - name: Build Module with OLLVM
      env:
        DECLANG_HOME: /tmp/.DeClang
        DECLANG_CLANG: ${{ env.DECLANG_CLANG }}
        YOUR_CLANG: ${{ env.YOUR_CLANG }}
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko ==="
        
        # Select compiler (prefer your uploaded clang if available)
        if ${{ inputs.use_declang == 'true' && inputs.obfuscation_level != 'none' }}; then
          if [ -n "$YOUR_CLANG" ]; then
            CC="$YOUR_CLANG"
            echo "Using: YOUR UPLOADED DeClang"
          elif [ -n "$DECLANG_CLANG" ]; then
            CC="$DECLANG_CLANG"
            echo "Using: SWIFT DeClang"
          else
            CC="clang"
            echo "Using: DDK clang (fallback)"
          fi
        else
          CC="clang"
          echo "Using: DDK clang (no DeClang)"
        fi
        
        echo "Compiler: $CC"
        
        # Set OLLVM variables for Makefile
        if ${{ inputs.obfuscation_level != 'none' }}; then
          OLLVM_VARS="OLLVM=1 OLLVM_LEVEL=${{ inputs.obfuscation_level }}"
          echo "OLLVM Level: ${{ inputs.obfuscation_level }}"
        else
          OLLVM_VARS="OLLVM=0"
          echo "No OLLVM obfuscation"
        fi
        
        echo ""
        echo "=== Starting Build ==="
        
        # Build using Makefile's OLLVM support
        make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} modules \
          CC="$CC" \
          $OLLVM_VARS
        
        echo ""
        echo "=== Build Result ==="
        
        KO_FILE=$(find "${{ inputs.module_dir }}" -name "*.ko" -type f | head -1)
        if [ -f "$KO_FILE" ]; then
          echo "✅ SUCCESS: $KO_FILE"
          echo "Size: $(du -h "$KO_FILE" | cut -f1)"
          
          # Check if OLLVM was applied
          echo ""
          echo "=== Checking OLLVM in binary ==="
          if [[ "$OLLVM_VARS" == *"OLLVM=1"* ]]; then
            strings "$KO_FILE" | grep -i "fla\|bcf\|sub" | head -5 && \
              echo "✅ OLLVM strings found in binary" || \
              echo "⚠️ No OLLVM strings found (may be stripped)"
          fi
          
          echo "BUILT_KO_FILE=$KO_FILE" >> $GITHUB_ENV
        else
          echo "❌ FAILED: No .ko file found"
          echo "Listing ${{ inputs.module_dir }}/:"
          ls -la "${{ inputs.module_dir }}/" || true
          exit 1
        fi

    - name: Create Artifact
      env:
        BUILT_KO_FILE: ${{ env.BUILT_KO_FILE }}
      run: |
        if [ -z "$BUILT_KO_FILE" ]; then exit 1; fi
        
        mkdir -p /github/workspace/out
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        
        # Determine artifact name
        if ${{ inputs.use_declang == 'true' && inputs.obfuscation_level != 'none' }}; then
          if [ -n "$YOUR_CLANG" ]; then
            CLANG_TYPE="your-declang"
          else
            CLANG_TYPE="swift-declang"
          fi
          OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-ollvm-${{ inputs.obfuscation_level }}-$CLANG_TYPE-$TIMESTAMP.ko"
        else
          OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-normal-$TIMESTAMP.ko"
        fi
        
        cp "$BUILT_KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
        echo "ARTIFACT_PATH=/github/workspace/out/$OUTPUT_NAME" >> $GITHUB_ENV

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}
        path: ${{ env.ARTIFACT_PATH }}
