name: Build Kernel Module with OLLVM

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'exianb-dev'
      obfuscation_level:
        description: 'OLLVM obfuscation level'
        required: false
        default: 'medium'
        type: choice
        options:
        - none
        - light
        - medium
        - heavy
      use_custom_clang:
        description: 'Use custom OLLVM clang from ZIP'
        required: false
        default: 'false'
        type: boolean

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Install unzip in container
      run: |
        echo "=== Installing unzip ==="
        if ! command -v unzip >/dev/null 2>&1; then
          apt-get update && apt-get install -y unzip >/dev/null 2>&1 || echo "⚠️ Could not install unzip"
        fi
        echo "✅ unzip available: $(command -v unzip)"

    - name: Setup OLLVM Clang (if requested)
      if: ${{ inputs.use_custom_clang == 'true' }}
      run: |
        echo "=== Setting up OLLVM Clang ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Check for clang.zip in module directory
        if [ -f "$MODULE_DIR/clang.zip" ]; then
          echo "Found clang.zip in $MODULE_DIR/"
          
          # Extract clang binary
          mkdir -p /tmp/ollvm-clang
          unzip -q "$MODULE_DIR/clang.zip" -d /tmp/ollvm-clang/
          
          # Find the clang binary (look for executable file)
          OLLVM_CLANG=$(find /tmp/ollvm-clang -type f -name "clang" -executable | head -1)
          
          if [ -z "$OLLVM_CLANG" ]; then
            echo "❌ No executable clang found in clang.zip"
            echo "Trying any clang file..."
            OLLVM_CLANG=$(find /tmp/ollvm-clang -type f -name "clang" | head -1)
            if [ -n "$OLLVM_CLANG" ]; then
              chmod +x "$OLLVM_CLANG"
            fi
          fi
          
          if [ -z "$OLLVM_CLANG" ]; then
            echo "❌ No clang binary found at all"
            exit 1
          fi
          
          echo "✅ OLLVM Clang found: $OLLVM_CLANG"
          
          # Test it
          echo ""
          echo "=== Testing OLLVM Clang ==="
          echo "Version:"
          "$OLLVM_CLANG" --version 2>&1 | head -3
          
          echo -n "Android target test: "
          echo 'int main(){return 0;}' | "$OLLVM_CLANG" --target=aarch64-linux-android \
            -x c -c - -o /dev/null 2>&1 && echo "✅" || echo "❌"
          
          # Install to system location
          mkdir -p /usr/local/ollvm/bin
          cp "$OLLVM_CLANG" /usr/local/ollvm/bin/clang
          chmod +x /usr/local/ollvm/bin/clang
          
          # Add to PATH
          echo 'export PATH=/usr/local/ollvm/bin:$PATH' >> ~/.bashrc
          export PATH=/usr/local/ollvm/bin:$PATH
          
          echo "✅ OLLVM Clang installed to /usr/local/ollvm/bin/clang"
          echo "OLLVM_CLANG=/usr/local/ollvm/bin/clang" >> $GITHUB_ENV
          
        else
          echo "❌ clang.zip not found in $MODULE_DIR/"
          echo "Looking for clang binary directly..."
          
          # Check for direct clang binary
          if [ -f "$MODULE_DIR/clang" ]; then
            OLLVM_CLANG="$PWD/$MODULE_DIR/clang"
            chmod +x "$OLLVM_CLANG"
            
            mkdir -p /usr/local/ollvm/bin
            cp "$OLLVM_CLANG" /usr/local/ollvm/bin/clang
            chmod +x /usr/local/ollvm/bin/clang
            
            export PATH=/usr/local/ollvm/bin:$PATH
            
            echo "✅ Using clang binary: /usr/local/ollvm/bin/clang"
            echo "OLLVM_CLANG=/usr/local/ollvm/bin/clang" >> $GITHUB_ENV
          else
            echo "⚠️ No custom clang found, will use container's clang"
            echo "OLLVM_CLANG=/usr/bin/clang" >> $GITHUB_ENV
          fi
        fi

    - name: Show build environment
      run: |
        echo "=== Build Environment ==="
        echo "Module directory: ${{ inputs.module_dir }}"
        echo "KMI: ${{ matrix.kmi }}"
        echo "KERNEL_SRC: $KERNEL_SRC"
        echo "ARCH: $ARCH"
        echo ""
        echo "Available compilers:"
        echo "Container clang: $(which clang) - $(clang --version 2>&1 | head -1)"
        if [ -f "/usr/local/ollvm/bin/clang" ]; then
          echo "OLLVM clang: /usr/local/ollvm/bin/clang - $(/usr/local/ollvm/bin/clang --version 2>&1 | head -1)"
        fi

    - name: Build module with OLLVM
      env:
        OLLVM_CLANG: ${{ env.OLLVM_CLANG || '/usr/bin/clang' }}
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Check module structure
        echo "Module structure:"
        ls -la "$MODULE_DIR/" 2>/dev/null || echo "Module directory not found"
        if [ -d "$MODULE_DIR/src" ]; then
          echo "✅ src/ directory exists"
          find "$MODULE_DIR/src" -type f -name "*.c" | head -5
        fi
        
        # Determine compiler and flags
        if [ "${{ inputs.use_custom_clang }}" = "true" ] && [ -f "/usr/local/ollvm/bin/clang" ]; then
          COMPILER="/usr/local/ollvm/bin/clang"
          echo "Using OLLVM Clang: $COMPILER"
          
          # Set OLLVM flags
          case "${{ inputs.obfuscation_level }}" in
            "none")
              OLLVM_FLAGS=""
              echo "OLLVM Level: none"
              ;;
            "light")
              OLLVM_FLAGS="-mllvm -fla"
              echo "OLLVM Level: light (-fla)"
              ;;
            "medium")
              OLLVM_FLAGS="-mllvm -fla -mllvm -sub"
              echo "OLLVM Level: medium (-fla -sub)"
              ;;
            "heavy")
              OLLVM_FLAGS="-mllvm -fla -mllvm -sub -mllvm -bcf"
              echo "OLLVM Level: heavy (-fla -sub -bcf)"
              ;;
          esac
          
          COMPILER_WITH_FLAGS="'$COMPILER' $OLLVM_FLAGS"
          echo "Compiler command: $COMPILER_WITH_FLAGS"
          
          # Test OLLVM flags
          echo ""
          echo "=== Testing OLLVM ==="
          TEST_CODE='int test(){int x=5; return x*2;}'
          echo "$TEST_CODE" | $COMPILER --target=aarch64-linux-android \
            $OLLVM_FLAGS -x c -c - -o /dev/null 2>&1 && \
            echo "✅ OLLVM test passed" || echo "⚠️ OLLVM test warning"
          
          # Build with OLLVM - override compiler in make command
          echo ""
          echo "=== Starting build ==="
          
          # Method: Direct kernel build (bypass module Makefile recursion)
          make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules \
            CC="$COMPILER $OLLVM_FLAGS" \
            LD="$COMPILER $OLLVM_FLAGS" \
            HOSTCC="gcc" \
            HOSTCXX="g++" \
            -j$(nproc)
            
        else
          # Use container's default compiler
          echo "Using container's default compiler"
          echo "OLLVM: Disabled"
          
          # Build normally
          make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules -j$(nproc)
        fi
        
        echo "=== Build completed ==="

    - name: Verify and process output
      run: |
        echo "=== Processing output ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Find the .ko file
        KO_FILE=$(find "$MODULE_DIR" -name "*.ko" -type f | head -1)
        
        if [ -z "$KO_FILE" ] || [ ! -f "$KO_FILE" ]; then
          echo "❌ ERROR: No .ko file found!"
          echo "Searching for build artifacts..."
          find "$MODULE_DIR" -type f \( -name "*.o" -o -name "*.mod" -o -name "*.mod.c" \) | head -10
          echo ""
          echo "Build logs (last 20 lines of each .cmd file):"
          find "$MODULE_DIR" -name "*.cmd" -type f | head -3 | while read cmd; do
            echo "=== $(basename "$cmd") ==="
            tail -20 "$cmd" 2>/dev/null | head -5
          done
          exit 1
        fi
        
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        
        # Create descriptive filename
        if [ "${{ inputs.use_custom_clang }}" = "true" ] && [ "${{ inputs.obfuscation_level }}" != "none" ]; then
          OUTPUT_NAME="$MODULE_DIR-${{ matrix.kmi }}-ollvm-${{ inputs.obfuscation_level }}-$TIMESTAMP.ko"
        else
          OUTPUT_NAME="$MODULE_DIR-${{ matrix.kmi }}-$TIMESTAMP.ko"
        fi
        
        # Create output directory
        mkdir -p /github/workspace/out
        
        # Copy and process the module
        cp "$KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
        echo "✅ Module built: $OUTPUT_NAME"
        
        ORIGINAL_SIZE=$(stat -c%s "/github/workspace/out/$OUTPUT_NAME")
        echo "Original size: $ORIGINAL_SIZE bytes ($((ORIGINAL_SIZE/1024)) KB)"
        
        # Strip debug symbols
        if command -v llvm-strip >/dev/null 2>&1; then
          llvm-strip -d "/github/workspace/out/$OUTPUT_NAME" 2>/dev/null || true
          STRIPPED_SIZE=$(stat -c%s "/github/workspace/out/$OUTPUT_NAME")
          REDUCTION=$((ORIGINAL_SIZE - STRIPPED_SIZE))
          REDUCTION_PCT=$((REDUCTION * 100 / ORIGINAL_SIZE))
          echo "Stripped size: $STRIPPED_SIZE bytes ($((STRIPPED_SIZE/1024)) KB)"
          echo "Reduction: $REDUCTION bytes ($REDUCTION_PCT%)"
        else
          echo "⚠️ llvm-strip not available, skipping strip"
          STRIPPED_SIZE=$ORIGINAL_SIZE
        fi
        
        # Show module info
        echo ""
        echo "=== Module info ==="
        file "/github/workspace/out/$OUTPUT_NAME"
        
        # Create build info file
        cat > "/github/workspace/out/build-info-$OUTPUT_NAME.txt" << EOF
        Module: $MODULE_DIR
        KMI: ${{ matrix.kmi }}
        Custom Clang: ${{ inputs.use_custom_clang }}
        OLLVM Level: ${{ inputs.obfuscation_level }}
        Build Time: $(date)
        Compiler Used: $(which clang 2>/dev/null || echo "unknown")
        Original Size: $ORIGINAL_SIZE bytes
        Stripped Size: $STRIPPED_SIZE bytes
        Size Reduction: $((ORIGINAL_SIZE - STRIPPED_SIZE)) bytes
        Module Structure:
        $(find "$MODULE_DIR" -type f -name "*.c" -o -name "*.h" | wc -l) source files
        $(find "$MODULE_DIR/src" -type d 2>/dev/null | wc -l) src subdirectories
        EOF
        
        echo "ARTIFACT_PATH=/github/workspace/out/$OUTPUT_NAME" >> $GITHUB_ENV

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-${{ github.run_number }}
        path: |
          ${{ env.ARTIFACT_PATH }}
          /github/workspace/out/build-info-*.txt
