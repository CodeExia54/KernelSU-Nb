name: Build Kernel Module with OLLVM

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'exianb-dev'
      obfuscation_level:
        description: 'OLLVM obfuscation level'
        required: false
        default: 'medium'
        type: choice
        options:
        - none
        - light
        - medium
        - heavy
      use_custom_clang:
        description: 'Use custom OLLVM clang from ZIP'
        required: false
        default: 'false'
        type: boolean

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Install unzip in container
      run: |
        echo "=== Installing unzip ==="
        apt-get update && apt-get install -y unzip file

    - name: Setup OLLVM Clang (if requested)
      if: ${{ inputs.use_custom_clang }}
      run: |
        echo "=== Setting up OLLVM Clang ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Check for clang.zip in module directory
        if [ -f "$MODULE_DIR/clang.zip" ]; then
          echo "Found clang.zip in $MODULE_DIR/"
          
          # Extract clang binary
          mkdir -p /tmp/ollvm-clang
          unzip -q "$MODULE_DIR/clang.zip" -d /tmp/ollvm-clang/
          
          # Find the clang binary
          OLLVM_CLANG=$(find /tmp/ollvm-clang -type f -name "clang" | head -1)
          
          if [ -z "$OLLVM_CLANG" ]; then
            echo "❌ No clang found in clang.zip"
            exit 1
          fi
          
          # Make it executable if not already
          chmod +x "$OLLVM_CLANG"
          
          echo "✅ OLLVM Clang found: $OLLVM_CLANG"
          
          # Test it
          echo ""
          echo "=== Testing OLLVM Clang ==="
          "$OLLVM_CLANG" --version 2>&1 | head -3 || true
          
          # Create OLLVM directory
          mkdir -p /usr/local/ollvm/bin
          
          # Copy just the clang binary
          cp "$OLLVM_CLANG" /usr/local/ollvm/bin/clang
          chmod +x /usr/local/ollvm/bin/clang
          
          # Add to PATH globally
          echo 'export PATH=/usr/local/ollvm/bin:$PATH' >> /etc/profile.d/ollvm.sh
          export PATH=/usr/local/ollvm/bin:$PATH
          
          # Verify installation
          echo ""
          echo "=== Verifying OLLVM installation ==="
          echo "PATH: $PATH"
          echo "Which clang: $(which clang)"
          /usr/local/ollvm/bin/clang --version 2>&1 | head -1
          
          # Test basic compilation without OLLVM flags first
          echo ""
          echo "=== Testing basic compilation ==="
          echo 'int test_func() { return 0; }' > /tmp/simple.c
          
          if /usr/local/ollvm/bin/clang --target=aarch64-linux-android \
            -c /tmp/simple.c -o /tmp/simple.o 2>&1; then
            echo "✅ Basic compilation successful"
          else
            echo "❌ Basic compilation failed"
            exit 1
          fi
          
          echo "OLLVM_INSTALLED=true" >> $GITHUB_ENV
          
        else
          echo "❌ clang.zip not found in $MODULE_DIR/"
          exit 1
        fi

    - name: Show build environment
      run: |
        echo "=== Build Environment ==="
        echo "Module directory: ${{ inputs.module_dir }}"
        echo "KMI: ${{ matrix.kmi }}"
        echo "KERNEL_SRC: $KERNEL_SRC"
        echo "ARCH: $ARCH"
        echo "Use custom clang: ${{ inputs.use_custom_clang }}"
        echo "OLLVM level: ${{ inputs.obfuscation_level }}"
        echo ""
        echo "=== PATH ==="
        echo $PATH
        echo ""
        echo "=== Available compilers ==="
        echo "Default container clang:"
        which clang
        /opt/ddk/clang/clang-r450784e/bin/clang --version 2>&1 | head -1
        echo ""
        echo "OLLVM clang:"
        if [ -f "/usr/local/ollvm/bin/clang" ]; then
          which clang
          /usr/local/ollvm/bin/clang --version 2>&1 | head -1
        else
          echo "Not installed"
        fi

    - name: Build module
      id: build_module
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Set compiler based on input
        if [ "${{ inputs.use_custom_clang }}" = "true" ] && [ -f "/usr/local/ollvm/bin/clang" ]; then
          echo "=== USING OLLVM COMPILER ==="
          
          # Force use of OLLVM clang by overriding PATH
          export PATH="/usr/local/ollvm/bin:$PATH"
          export CC="/usr/local/ollvm/bin/clang"
          export LD="/usr/local/ollvm/bin/clang"
          
          echo "CC: $(which $CC)"
          echo "LD: $(which $LD)"
          
          # Set OLLVM flags
          case "${{ inputs.obfuscation_level }}" in
            "light")
              OLLVM_FLAGS="-mllvm -fla"
              echo "OLLVM Level: light (-fla)"
              ;;
            "medium")
              OLLVM_FLAGS="-mllvm -fla -mllvm -sub"
              echo "OLLVM Level: medium (-fla -sub)"
              ;;
            "heavy")
              OLLVM_FLAGS="-mllvm -fla -mllvm -sub -mllvm -bcf"
              echo "OLLVM Level: heavy (-fla -sub -bcf)"
              ;;
            *)
              OLLVM_FLAGS=""
              echo "OLLVM Level: none"
              ;;
          esac
          
          echo "OLLVM Flags: $OLLVM_FLAGS"
          
          # Test compiler with kernel flags
          echo ""
          echo "=== Testing compiler with kernel flags ==="
          
          # Try a simple test with kernel-like flags
          TEST_CODE='#include <linux/types.h>\nint test_func(void) { return 0; }'
          echo -e "$TEST_CODE" > /tmp/kernel_test.c
          
          if /usr/local/ollvm/bin/clang --target=aarch64-linux-android \
            -nostdinc -isystem /opt/ddk/clang/clang-r450784e/include \
            -I$KERNEL_SRC/include \
            -I$KERNEL_SRC/arch/arm64/include \
            -D__KERNEL__ -D__aarch64__ \
            $OLLVM_FLAGS \
            -c /tmp/kernel_test.c -o /tmp/kernel_test.o 2>&1; then
            echo "✅ Kernel-style compilation successful"
          else
            echo "⚠️ Kernel-style compilation test failed (might still work with full build)"
          fi
          
          echo ""
          echo "=== Starting kernel module build ==="
          
          # Save the original build command
          BUILD_CMD="make -C \"$KERNEL_SRC\" M=\"$PWD/$MODULE_DIR\" modules"
          BUILD_CMD="$BUILD_CMD CC=\"$CC $OLLVM_FLAGS\""
          BUILD_CMD="$BUILD_CMD LD=\"$LD $OLLVM_FLAGS\""
          BUILD_CMD="$BUILD_CMD HOSTCC=\"gcc\" HOSTCXX=\"g++\""
          BUILD_CMD="$BUILD_CMD -j$(nproc)"
          
          echo "Build command: $BUILD_CMD"
          echo ""
          
          # Execute build and capture exit code
          set +e
          eval $BUILD_CMD 2>&1 | tee /tmp/build.log
          BUILD_EXIT=$?
          set -e
          
          echo ""
          echo "Build exit code: $BUILD_EXIT"
          
          if [ $BUILD_EXIT -ne 0 ]; then
            echo "❌ Build failed with OLLVM compiler"
            echo "Last 50 lines of build log:"
            tail -50 /tmp/build.log
            
            echo ""
            echo "=== Trying fallback: Build without OLLVM flags ==="
            # Try building without OLLVM flags but with OLLVM clang
            make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules \
              CC="$CC" \
              LD="$LD" \
              HOSTCC="gcc" \
              HOSTCXX="g++" \
              -j$(nproc) 2>&1 | tee /tmp/build_no_ollvm.log
          fi
          
        else
          echo "=== USING DEFAULT COMPILER ==="
          echo "Reason - custom clang requested: ${{ inputs.use_custom_clang }}"
          echo "Reason - OLLVM clang exists: $(if [ -f "/usr/local/ollvm/bin/clang" ]; then echo 'yes'; else echo 'no'; fi)"
          
          # Build normally with default compiler
          make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules -j$(nproc) 2>&1 | tee /tmp/build.log
        fi

    - name: Check build result
      run: |
        echo "=== Checking build result ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Find the .ko file
        KO_FILE=$(find "$MODULE_DIR" -name "*.ko" -type f | head -1)
        
        if [ -f "$KO_FILE" ]; then
          echo "✅ Build successful! Found: $KO_FILE"
          echo "FILE_EXISTS=true" >> $GITHUB_ENV
          echo "KO_FILE_PATH=$KO_FILE" >> $GITHUB_ENV
        else
          echo "❌ Build failed! No .ko file found."
          echo "FILE_EXISTS=false" >> $GITHUB_ENV
          
          # Show build errors
          echo ""
          echo "=== Build errors ==="
          grep -i "error\|warning\|failed" /tmp/build.log 2>/dev/null | tail -20 || echo "No error log found"
          
          # Check for specific issues
          echo ""
          echo "=== Checking for common issues ==="
          
          if grep -i "unrecognized.*option.*mllvm" /tmp/build.log 2>/dev/null; then
            echo "⚠️ OLLVM flags not supported by this clang version"
          fi
          
          if grep -i "clang.*not found" /tmp/build.log 2>/dev/null; then
            echo "⚠️ Clang compiler not found"
          fi
          
          if grep -i "target.*not supported" /tmp/build.log 2>/dev/null; then
            echo "⚠️ Target architecture not supported"
          fi
        fi

    - name: Process successful build
      if: env.FILE_EXISTS == 'true'
      run: |
        echo "=== Processing successful build ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        KO_FILE="${{ env.KO_FILE_PATH }}"
        
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        
        # Determine build type
        if [ "${{ inputs.use_custom_clang }}" = "true" ] && [ -f "/usr/local/ollvm/bin/clang" ]; then
          BUILD_TYPE="ollvm-${{ inputs.obfuscation_level }}"
          OUTPUT_NAME="$MODULE_DIR-${{ matrix.kmi }}-ollvm-${{ inputs.obfuscation_level }}-$TIMESTAMP.ko"
        else
          BUILD_TYPE="default"
          OUTPUT_NAME="$MODULE_DIR-${{ matrix.kmi }}-default-$TIMESTAMP.ko"
        fi
        
        # Create output directory
        mkdir -p /github/workspace/out
        
        # Copy the module
        cp "$KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
        echo "✅ Module saved: $OUTPUT_NAME"
        
        # Get file info
        ORIGINAL_SIZE=$(stat -c%s "/github/workspace/out/$OUTPUT_NAME")
        echo "Size: $ORIGINAL_SIZE bytes ($((ORIGINAL_SIZE/1024)) KB)"
        
        # Strip if possible
        if command -v llvm-strip >/dev/null 2>&1; then
          llvm-strip -d "/github/workspace/out/$OUTPUT_NAME" 2>/dev/null || true
          STRIPPED_SIZE=$(stat -c%s "/github/workspace/out/$OUTPUT_NAME")
          echo "Stripped size: $STRIPPED_SIZE bytes"
        fi
        
        # Create detailed build info
        BUILD_INFO_FILE="/github/workspace/out/build-info-$OUTPUT_NAME.txt"
        {
          echo "========================================="
          echo "BUILD INFORMATION"
          echo "========================================="
          echo "Module: $MODULE_DIR"
          echo "KMI: ${{ matrix.kmi }}"
          echo "Build Type: $BUILD_TYPE"
          echo "Use Custom Clang: ${{ inputs.use_custom_clang }}"
          echo "OLLVM Level: ${{ inputs.obfuscation_level }}"
          echo "Timestamp: $(date)"
          echo ""
          echo "COMPILER INFORMATION:"
          echo "Default Clang: $(which clang)"
          echo "Default Clang Version: $(/opt/ddk/clang/clang-r450784e/bin/clang --version 2>&1 | head -1)"
          echo ""
          echo "OLLVM STATUS:"
          if [ -f "/usr/local/ollvm/bin/clang" ]; then
            echo "OLLVM Clang Installed: YES"
            echo "OLLVM Clang Path: /usr/local/ollvm/bin/clang"
            echo "OLLVM Clang Version: $(/usr/local/ollvm/bin/clang --version 2>&1 | head -1)"
          else
            echo "OLLVM Clang Installed: NO"
            echo "OLLVM Clang Path: N/A"
            echo "OLLVM Clang Version: N/A"
          fi
          echo ""
          echo "BUILD OUTPUT:"
          echo "Original File: $KO_FILE"
          echo "Output File: $OUTPUT_NAME"
          echo "Original Size: $ORIGINAL_SIZE bytes"
          echo "Stripped Size: ${STRIPPED_SIZE:-$ORIGINAL_SIZE} bytes"
          echo ""
          echo "BUILD LOG SUMMARY:"
          echo "Last 5 lines of build log:"
          tail -5 /tmp/build.log 2>/dev/null || echo "No build log"
          echo "========================================="
        } > "$BUILD_INFO_FILE"
        
        echo "ARTIFACT_PATH=/github/workspace/out/$OUTPUT_NAME" >> $GITHUB_ENV

    - name: Process failed build
      if: env.FILE_EXISTS == 'false'
      run: |
        echo "=== Processing failed build ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        
        # Create output directory
        mkdir -p /github/workspace/out
        
        # Create error report
        ERROR_FILE="/github/workspace/out/build-error-$MODULE_DIR-${{ matrix.kmi }}-$TIMESTAMP.txt"
        {
          echo "========================================="
          echo "BUILD FAILURE REPORT"
          echo "========================================="
          echo "Module: $MODULE_DIR"
          echo "KMI: ${{ matrix.kmi }}"
          echo "Use Custom Clang: ${{ inputs.use_custom_clang }}"
          echo "OLLVM Level: ${{ inputs.obfuscation_level }}"
          echo "Timestamp: $(date)"
          echo "Status: BUILD FAILED"
          echo ""
          echo "COMPILER INFORMATION:"
          echo "Default Clang: $(which clang)"
          if [ -f "/usr/local/ollvm/bin/clang" ]; then
            echo "OLLVM Clang: /usr/local/ollvm/bin/clang"
            echo "OLLVM Clang Version: $(/usr/local/ollvm/bin/clang --version 2>&1 | head -1)"
          fi
          echo ""
          echo "BUILD LOG (last 100 lines):"
          echo "-----------------------------------------"
          tail -100 /tmp/build.log 2>/dev/null || echo "No build log available"
          echo "========================================="
        } > "$ERROR_FILE"
        
        echo "Created error report: $ERROR_FILE"

    - name: Upload successful artifact
      if: env.FILE_EXISTS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-success
        path: |
          ${{ env.ARTIFACT_PATH }}
          /github/workspace/out/build-info-*.txt
        retention-days: 7

    - name: Upload error report
      if: env.FILE_EXISTS == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-error
        path: |
          /github/workspace/out/build-error-*.txt
        retention-days: 7
