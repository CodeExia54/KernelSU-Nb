name: Build Obfuscated Kernel Module with DeClang

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'exianb-dev'

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Download and setup DeClang
      run: |
        echo "=== Downloading and Installing DeClang ==="
        apt-get update && apt-get install -y unzip 2>/dev/null || true
        wget -q https://github.com/DeNA/DeClang/releases/download/swift5.10-v1.0.0/Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        unzip -q Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        chmod +x Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang
        mkdir -p /opt/declang
        cp -r Release-Linux-swift5.10-v1.0.0-ubuntu2204/* /opt/declang/
        echo "✅ DeClang installed"

    - name: Analyze module functions for obfuscation targeting
      run: |
        echo "=== Analyzing module functions ==="
        
        # Find all .c files in your module
        find "${{ inputs.module_dir }}" -name "*.c" -type f | while read c_file; do
            echo "Analyzing: $c_file"
            # Extract function names (simple grep for function definitions)
            grep -n "^\s*[a-zA-Z_][a-zA-Z0-9_]*\s*[a-zA-Z_][a-zA-Z0-9_]*\s*(" "$c_file" | \
                head -10 | sed 's/^/  /'
        done
        
        # Also check for init/exit functions (common in kernel modules)
        echo ""
        echo "=== Looking for module_init/module_exit functions ==="
        find "${{ inputs.module_dir }}" -name "*.c" -type f -exec grep -l "module_init\|module_exit" {} \; | head -5

    - name: Configure DeClang for Kernel Module Obfuscation
      run: |
        echo "=== Configuring DeClang for Kernel Modules ==="
        
        mkdir -p ~/.DeClang /opt/declang/.DeClang
        
        # CRITICAL FIX: Target specific kernel module functions
        # Instead of ".*" which might filter to main functions,
        # target common kernel module function patterns
        cat > ~/.DeClang/config.pre.json << 'EOF'
        {
          "build_seed": "ddk_kernel_$(date +%s)",
          "overall_obfuscation": 80,
          "flatten": [
            {
              "name": "wuwa_.*",
              "seed": "deadbeefcafebabe",
              "split_level": 2,
              "enable_obfuscation": 1
            },
            {
              "name": ".*init$",
              "seed": "cafebabedeadbeef",
              "split_level": 1,
              "enable_obfuscation": 1
            },
            {
              "name": ".*exit$",
              "seed": "beefdeadbabecafe",
              "split_level": 1,
              "enable_obfuscation": 1
            }
          ]
        }
        EOF
        
        # Generate config with aggressive settings
        if [ -f "/opt/declang/gen_config.sh" ]; then
            /opt/declang/gen_config.sh -path /opt/declang -seed "ddk_kernel_$(date +%s)_aggressive"
        else
            cp ~/.DeClang/config.pre.json ~/.DeClang/config.json
        fi
        
        touch /opt/declang/.DeClang/log.txt
        
        echo "=== Generated Configuration ==="
        cat ~/.DeClang/config.json 2>/dev/null || cat ~/.DeClang/config.pre.json

    - name: Build with Experimental Obfuscation Flags
      run: |
        echo "=== Building with Experimental Obfuscation ==="
        
        export CC="/opt/declang/compiler/bin/clang"
        export DECLANG_HOME="/opt/declang"
        
        # EXPERIMENTAL: Try different optimization levels and flags
        # DeClang might need specific optimization to trigger passes
        export CFLAGS="-O3 -mllvm -flatten -mllvm -bcf"
        export KCFLAGS="-O3 -mllvm -flatten -mllvm -bcf"
        
        echo "Using aggressive flags: $CFLAGS"
        
        # First, clean previous build
        make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} clean 2>/dev/null || true
        
        # Build with verbose output to see if passes are applied
        echo ""
        echo "=== Verbose Build Output (looking for obfuscation) ==="
        make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} modules V=1 2>&1 | \
            grep -i "flatten\|obfuscat\|pass\|llvm" | head -20 || \
            echo "No obfuscation-related output found"
        
        # Now build normally
        echo ""
        echo "=== Final Build ==="
        make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} modules
        
        echo "=== Build completed ==="
        
        # Verification
        mkdir -p /github/workspace/out
        KO_FILE=$(find "${{ inputs.module_dir }}" -name "*.ko" -type f | head -1)
        
        if [ -n "$KO_FILE" ] && [ -f "$KO_FILE" ]; then
            TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
            OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-obfuscated-$TIMESTAMP.ko"
            cp "$KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
            
            # COMPREHENSIVE VERIFICATION
            echo ""
            echo "=== COMPREHENSIVE OBFUSCATION ANALYSIS ==="
            
            # 1. File comparison
            echo "1. File Info:"
            file "$KO_FILE"
            ORIG_SIZE=$(stat -c%s "$KO_FILE")
            echo "   Size: $ORIG_SIZE bytes ($((ORIG_SIZE/1024)) KB)"
            
            # 2. String analysis
            echo ""
            echo "2. String Analysis:"
            TOTAL_STRINGS=$(strings "$KO_FILE" | wc -l)
            READABLE_STRINGS=$(strings "$KO_FILE" | grep -E "(gpl|license|wuwa|init|exit|module)" | wc -l)
            echo "   Total strings: $TOTAL_STRINGS"
            echo "   Readable keywords: $READABLE_STRINGS"
            echo "   Sample strings:"
            strings "$KO_FILE" | head -10 | sed 's/^/     /'
            
            # 3. Symbol analysis
            echo ""
            echo "3. Symbol Analysis (first 10):"
            nm "$KO_FILE" 2>/dev/null | grep " T " | head -10 | sed 's/^/     /' || \
                echo "   nm not available or no symbols"
            
            # 4. Test with llvm-objdump
            echo ""
            echo "4. Checking for control flow complexity:"
            if command -v llvm-objdump >/dev/null 2>&1; then
                llvm-objdump -d "$KO_FILE" 2>/dev/null | grep -c "jmp\|call\|ret" | \
                    xargs echo "   Total jumps/calls/ret: " || true
            fi
            
            # 5. Compare with non-obfuscated version
            echo ""
            echo "5. Building comparison (non-obfuscated)..."
            make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} clean 2>/dev/null || true
            unset CC DECLANG_HOME CFLAGS KCFLAGS
            make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} modules 2>&1 | tail -5
            ORIG_KO=$(find "${{ inputs.module_dir }}" -name "*.ko" -type f | head -1)
            if [ -f "$ORIG_KO" ]; then
                ORIG_SIZE=$(stat -c%s "$ORIG_KO")
                OBF_SIZE=$(stat -c%s "$KO_FILE")
                SIZE_DIFF=$((OBF_SIZE - ORIG_SIZE))
                echo "   Non-obfuscated size: $ORIG_SIZE bytes"
                echo "   Obfuscated size: $OBF_SIZE bytes"
                echo "   Size difference: $SIZE_DIFF bytes"
                if [ $SIZE_DIFF -gt 10000 ]; then
                    echo "   ✅ SIGNIFICANT SIZE INCREASE - OBFUSCATION WORKING!"
                elif [ $SIZE_DIFF -gt 0 ]; then
                    echo "   ⚠️  Small size increase ($SIZE_DIFF bytes)"
                else
                    echo "   ❌ NO SIZE INCREASE - Obfuscation likely not applied"
                fi
            fi
            
            # Strip and finalize
            llvm-strip -d "/github/workspace/out/$OUTPUT_NAME"
            
        else
            echo "❌ ERROR: Build failed - no .ko file produced"
            exit 1
        fi

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-obfuscated-${{ github.run_id }}
        path: /github/workspace/out/${{ inputs.module_dir }}-${{ matrix.kmi }}-obfuscated-*.ko

    - name: Debug DeClang if Still Not Working
      if: failure()
      run: |
        echo "=== DEBUGGING DeClang ==="
        echo "1. Testing DeClang compiler directly:"
        /opt/declang/compiler/bin/clang --version
        echo ""
        echo "2. Checking if obfuscation passes are available:"
        /opt/declang/compiler/bin/clang -cc1 -help 2>&1 | grep -i "obfuscat\|flatten" | head -10 || \
            echo "No obfuscation flags in help"
        echo ""
        echo "3. Creating test to verify DeClang works:"
        cat > /tmp/test_declang.c << 'EOF'
        int test_function(int x) {
            int result = 0;
            for(int i = 0; i < 100; i++) {
                if (x == i) result = 1;
            }
            return result;
        }
        EOF
        /opt/declang/compiler/bin/clang -O3 -mllvm -flatten -S -o /tmp/test_declang.s /tmp/test_declang.c 2>&1 | \
            head -10
        echo "Test assembly generated. Check for complexity."
