name: Build Obfuscated Module with DeClang

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'hello-world'

jobs:
  build-obfuscated:
    name: Build ${{ inputs.module_dir }} with DeClang
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android14-6.1

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Install tools
      run: |
        apt-get update
        apt-get install -y wget unzip qemu-user-static
        
    - name: Download and setup DeClang
      run: |
        echo "=== Downloading DeClang ==="
        wget -q https://github.com/DeNA/DeClang/releases/download/swift5.10-v1.0.0/Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        
        echo "=== Extracting ==="
        unzip -q Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        
        echo "=== Fixing permissions ==="
        # Make ALL binaries in Release/bin executable
        find Release/bin -type f -exec chmod +x {} \;
        
        echo "=== Checking structure ==="
        echo "Release/bin contents:"
        ls -la Release/bin/
        
        echo "=== Testing DeClang ==="
        # Try running DeClang
        if ./Release/bin/clang --version; then
            echo "✓ DeClang runs natively"
        else
            echo "⚠ DeClang may need QEMU"
            # Try with QEMU
            qemu-x86_64 ./Release/bin/clang --version && echo "✓ Works with QEMU" || echo "✗ QEMU also fails"
        fi
        
    - name: Backup and replace DDK compiler
      run: |
        echo "=== Replacing DDK compiler with DeClang ==="
        
        DDK_BIN_DIR="/opt/ddk/clang/clang-r487747c/bin"
        
        echo "DDK bin directory: $DDK_BIN_DIR"
        echo "Contents before:"
        ls -la "$DDK_BIN_DIR/" | grep -E "clang|ld|lld"
        
        # Backup originals
        backup_dir="/tmp/ddk_backup_$(date +%s)"
        mkdir -p "$backup_dir"
        cp "$DDK_BIN_DIR/clang" "$backup_dir/clang.orig"
        
        # Create wrapper script
        cat > "$DDK_BIN_DIR/clang" << 'EOF'
        #!/bin/bash
        # DeClang wrapper script
        
        # Path to DeClang (relative to workspace)
        DECLANG_BIN="/github/workspace/Release/bin/clang"
        
        # Obfuscation flags - start conservative for kernel modules
        OBF_FLAGS="-mllvm -fla -mllvm -sub"
        
        # Add more flags for specific functions if needed
        for arg in "$@"; do
            if [[ "$arg" == *"kernel"* ]] || [[ "$arg" == *"module"* ]]; then
                # Kernel-specific flags
                OBF_FLAGS="-mllvm -fla"
                break
            fi
        done
        
        # Execute with obfuscation
        exec "$DECLANG_BIN" "$@" $OBF_FLAGS
        EOF
        
        chmod +x "$DDK_BIN_DIR/clang"
        
        # Also replace the Android cross-compiler
        if [ -f "$DDK_BIN_DIR/aarch64-linux-android-clang" ]; then
            cp "$DDK_BIN_DIR/aarch64-linux-android-clang" "$backup_dir/aarch64-linux-android-clang.orig"
            ln -sf "clang" "$DDK_BIN_DIR/aarch64-linux-android-clang"
        fi
        
        # Replace linker if DeClang has one
        if [ -f "/github/workspace/Release/bin/ld.lld" ]; then
            cp "$DDK_BIN_DIR/ld.lld" "$backup_dir/ld.lld.orig" 2>/dev/null || true
            cp "/github/workspace/Release/bin/ld.lld" "$DDK_BIN_DIR/ld.lld"
            chmod +x "$DDK_BIN_DIR/ld.lld"
        fi
        
        echo "✓ Compiler replaced"
        echo "Backups saved to: $backup_dir"
        echo "Contents after:"
        ls -la "$DDK_BIN_DIR/" | grep -E "clang|ld|lld"
        
    - name: Build kernel module
      env:
        KERNEL_SRC: /opt/ddk/kdir/android14-6.1
      run: |
        echo "=== Building ${{ inputs.module_dir }} ==="
        echo "Using KERNEL_SRC: $KERNEL_SRC"
        
        # Test compiler
        echo "--- Testing compiler ---"
        which clang
        clang --version || echo "Compiler test failed"
        
        # Build the module
        echo "--- Building module ---"
        cd "${{ inputs.module_dir }}"
        
        # Clean first
        make clean 2>/dev/null || true
        
        # Build with some debug info
        set -x
        make -C "$KERNEL_SRC" M="$(pwd)" modules \
            CC="clang" \
            LD="ld.lld" \
            V=1 \
            2>&1 | tee build.log | tail -50
        set +x
        
        # Check for output
        KO_FILE=$(find . -name "*.ko" -type f | head -1)
        if [ -f "$KO_FILE" ]; then
            echo "✓ SUCCESS: Built $KO_FILE"
            echo "File info:"
            file "$KO_FILE"
            
            # Copy to output directory
            mkdir -p /github/workspace/out
            cp "$KO_FILE" "/github/workspace/out/obfuscated-${{ inputs.module_dir }}.ko"
            
            # Optional: Strip debug symbols
            if command -v llvm-strip >/dev/null; then
                llvm-strip -d "/github/workspace/out/obfuscated-${{ inputs.module_dir }}.ko"
            fi
        else
            echo "✗ FAILED: No .ko file produced"
            echo "Build log tail:"
            tail -100 build.log
            echo "Full build log saved as build.log"
            exit 1
        fi
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: obfuscated-${{ inputs.module_dir }}-${{ matrix.kmi }}
        path: /github/workspace/out/obfuscated-*.ko
        retention-days: 7
        
    - name: Debug info (on failure)
      if: failure()
      run: |
        echo "=== Debug Information ==="
        echo "Current directory: $(pwd)"
        echo "Module dir: ${{ inputs.module_dir }}"
        ls -la "${{ inputs.module_dir }}" || echo "Module dir not found"
        
        echo "Compiler info:"
        which clang
        file $(which clang) || true
        
        echo "DDK structure:"
        ls -la /opt/ddk/clang/clang-r487747c/bin/
        
        echo "DeClang structure:"
        ls -la /github/workspace/Release/bin/
