name: Build Kernel Module with OLLVM

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'exianb-dev'
      obfuscation_level:
        description: 'OLLVM obfuscation level'
        required: false
        default: 'medium'
        type: choice
        options:
        - none
        - light
        - medium
        - heavy
      use_custom_clang:
        description: 'Use custom OLLVM clang from ZIP'
        required: false
        default: 'false'
        type: boolean

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Install unzip in container
      run: |
        echo "=== Installing unzip ==="
        apt-get update && apt-get install -y unzip file

    - name: Setup OLLVM Clang (if requested)
      if: ${{ inputs.use_custom_clang }}
      run: |
        echo "=== Setting up OLLVM Clang ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Check for clang.zip in module directory
        if [ -f "$MODULE_DIR/clang.zip" ]; then
          echo "Found clang.zip in $MODULE_DIR/"
          
          # Extract clang binary
          mkdir -p /tmp/ollvm-clang
          unzip -q "$MODULE_DIR/clang.zip" -d /tmp/ollvm-clang/
          
          # Find the clang binary
          OLLVM_CLANG=$(find /tmp/ollvm-clang -type f -name "clang" | head -1)
          
          if [ -z "$OLLVM_CLANG" ]; then
            echo "❌ No clang found in clang.zip"
            exit 1
          fi
          
          # Make it executable if not already
          chmod +x "$OLLVM_CLANG"
          
          echo "✅ OLLVM Clang found: $OLLVM_CLANG"
          
          # Test it
          echo ""
          echo "=== Testing OLLVM Clang ==="
          "$OLLVM_CLANG" --version 2>&1 | head -3 || true
          
          # Create OLLVM directory
          mkdir -p /usr/local/ollvm/bin
          
          # Copy just the clang binary
          cp "$OLLVM_CLANG" /usr/local/ollvm/bin/clang
          chmod +x /usr/local/ollvm/bin/clang
          
          echo "OLLVM_INSTALLED=true" >> $GITHUB_ENV
          
        else
          echo "❌ clang.zip not found in $MODULE_DIR/"
          exit 1
        fi

    - name: Show build environment
      run: |
        echo "=== Build Environment ==="
        echo "Module directory: ${{ inputs.module_dir }}"
        echo "KMI: ${{ matrix.kmi }}"
        echo "KERNEL_SRC: $KERNEL_SRC"
        echo "ARCH: $ARCH"
        echo "Use custom clang: ${{ inputs.use_custom_clang }}"
        echo "OLLVM level: ${{ inputs.obfuscation_level }}"
        echo ""
        echo "=== Toolchain information ==="
        echo "Default clang: $(which clang)"
        echo "Default ld.lld: $(which ld.lld 2>/dev/null || echo 'not found')"
        echo "Default ar: $(which llvm-ar 2>/dev/null || which ar)"
        echo "Default nm: $(which llvm-nm 2>/dev/null || which nm)"
        echo "Default objcopy: $(which llvm-objcopy 2>/dev/null || which objcopy)"
        echo "Default strip: $(which llvm-strip 2>/dev/null || which strip)"
        
        if [ -f "/usr/local/ollvm/bin/clang" ]; then
          echo ""
          echo "OLLVM clang: /usr/local/ollvm/bin/clang"
          echo "OLLVM clang version:"
          /usr/local/ollvm/bin/clang --version 2>&1 | head -1
        fi

    - name: Build module with OLLVM clang only
      id: build_module
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Set compiler based on input
        if [ "${{ inputs.use_custom_clang }}" = "true" ] && [ -f "/usr/local/ollvm/bin/clang" ]; then
          echo "=== USING OLLVM CLANG ONLY ==="
          echo "Using OLLVM clang for compilation, original toolchain for everything else"
          
          # Set OLLVM flags
          case "${{ inputs.obfuscation_level }}" in
            "light")
              OLLVM_FLAGS="-mllvm -fla"
              echo "OLLVM Level: light (-fla)"
              ;;
            "medium")
              OLLVM_FLAGS="-mllvm -fla -mllvm -sub"
              echo "OLLVM Level: medium (-fla -sub)"
              ;;
            "heavy")
              OLLVM_FLAGS="-mllvm -fla -mllvm -sub -mllvm -bcf"
              echo "OLLVM Level: heavy (-fla -sub -bcf)"
              ;;
            *)
              OLLVM_FLAGS=""
              echo "OLLVM Level: none"
              ;;
          esac
          
          # IMPORTANT: Only override CC with OLLVM clang
          # Let make use the default LD, AR, NM, OBJCOPY, STRIP from the container
          
          echo "=== Build configuration ==="
          echo "CC (compiler): /usr/local/ollvm/bin/clang $OLLVM_FLAGS"
          echo "LD (linker): Using default from container"
          echo "AR, NM, OBJCOPY, STRIP: Using defaults from container"
          
          # Test OLLVM clang
          echo ""
          echo "=== Testing OLLVM clang ==="
          /usr/local/ollvm/bin/clang --version 2>&1 | head -1
          
          echo ""
          echo "=== Starting build ==="
          
          # Build with ONLY CC overridden to OLLVM clang
          # Let all other tools (LD, AR, NM, etc.) use defaults
          set +e
          make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules \
            CC="/usr/local/ollvm/bin/clang $OLLVM_FLAGS" \
            -j$(nproc) 2>&1 | tee /tmp/build.log
          BUILD_EXIT=$?
          set -e
          
          echo ""
          echo "Build exit code: $BUILD_EXIT"
          
          if [ $BUILD_EXIT -ne 0 ]; then
            echo "❌ Build failed with OLLVM clang"
            echo "=== Build errors ==="
            grep -i "error\|failed" /tmp/build.log 2>/dev/null | tail -20 || echo "No errors found"
            
            # Try alternative: Use OLLVM flags in CFLAGS instead
            echo ""
            echo "=== Trying alternative: Pass OLLVM flags via CFLAGS ==="
            make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules \
              CFLAGS_MODULE="$OLLVM_FLAGS" \
              -j$(nproc) 2>&1 | tee /tmp/build_cflags.log
          fi
          
        else
          echo "=== USING DEFAULT COMPILER ==="
          
          # Build normally
          make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules -j$(nproc) 2>&1 | tee /tmp/build.log
        fi

    - name: Check build result
      run: |
        echo "=== Checking build result ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Find the .ko file
        KO_FILE=$(find "$MODULE_DIR" -name "*.ko" -type f | head -1)
        
        if [ -f "$KO_FILE" ]; then
          echo "✅ Build successful! Found: $KO_FILE"
          echo "FILE_EXISTS=true" >> $GITHUB_ENV
          echo "KO_FILE_PATH=$KO_FILE" >> $GITHUB_ENV
          
          # Verify OLLVM usage
          if [ "${{ inputs.use_custom_clang }}" = "true" ] && [ -f "/tmp/build.log" ]; then
            echo ""
            echo "=== OLLVM Usage Check ==="
            if grep -q "mllvm" /tmp/build.log 2>/dev/null; then
              echo "✅ OLLVM flags were used in build"
            else
              echo "⚠️ No OLLVM flags found in build log"
            fi
          fi
        else
          echo "❌ Build failed! No .ko file found."
          echo "FILE_EXISTS=false" >> $GITHUB_ENV
          
          # Show what's in the module directory
          echo ""
          echo "=== Module directory contents ==="
          ls -la "$MODULE_DIR/" 2>/dev/null || echo "Directory not found"
          
          # Show build artifacts that were created
          echo ""
          echo "=== Build artifacts found ==="
          find "$MODULE_DIR" -type f \( -name "*.o" -o -name "*.mod" -o -name "*.mod.c" \) 2>/dev/null | head -10
        fi

    - name: Process successful build
      if: env.FILE_EXISTS == 'true'
      run: |
        echo "=== Processing successful build ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        KO_FILE="${{ env.KO_FILE_PATH }}"
        
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        
        # Determine build type
        if [ "${{ inputs.use_custom_clang }}" = "true" ] && [ -f "/usr/local/ollvm/bin/clang" ]; then
          OUTPUT_NAME="$MODULE_DIR-${{ matrix.kmi }}-ollvm-${{ inputs.obfuscation_level }}-$TIMESTAMP.ko"
          BUILD_TYPE="OLLVM-${{ inputs.obfuscation_level }}"
        else
          OUTPUT_NAME="$MODULE_DIR-${{ matrix.kmi }}-default-$TIMESTAMP.ko"
          BUILD_TYPE="default"
        fi
        
        # Create output directory
        mkdir -p /github/workspace/out
        
        # Copy the module
        cp "$KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
        echo "✅ Module saved: $OUTPUT_NAME"
        
        # Get file info
        ORIGINAL_SIZE=$(stat -c%s "/github/workspace/out/$OUTPUT_NAME")
        echo "Size: $ORIGINAL_SIZE bytes ($((ORIGINAL_SIZE/1024)) KB)"
        
        # Strip if possible
        if command -v llvm-strip >/dev/null 2>&1; then
          llvm-strip -d "/github/workspace/out/$OUTPUT_NAME" 2>/dev/null || true
          STRIPPED_SIZE=$(stat -c%s "/github/workspace/out/$OUTPUT_NAME")
          echo "Stripped size: $STRIPPED_SIZE bytes ($((STRIPPED_SIZE/1024)) KB)"
        fi
        
        # Create simple build info
        BUILD_INFO_FILE="/github/workspace/out/build-info-$OUTPUT_NAME.txt"
        echo "Build Type: $BUILD_TYPE" > "$BUILD_INFO_FILE"
        echo "Module: $MODULE_DIR" >> "$BUILD_INFO_FILE"
        echo "KMI: ${{ matrix.kmi }}" >> "$BUILD_INFO_FILE"
        echo "OLLVM Level: ${{ inputs.obfuscation_level }}" >> "$BUILD_INFO_FILE"
        echo "Timestamp: $(date)" >> "$BUILD_INFO_FILE"
        echo "Size: $ORIGINAL_SIZE bytes" >> "$BUILD_INFO_FILE"
        echo "Compiler: $(if [ -f "/usr/local/ollvm/bin/clang" ]; then echo 'OLLVM clang'; else echo 'Default clang'; fi)" >> "$BUILD_INFO_FILE"
        
        echo "ARTIFACT_PATH=/github/workspace/out/$OUTPUT_NAME" >> $GITHUB_ENV

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}
        path: |
          ${{ env.ARTIFACT_PATH }}
          /github/workspace/out/build-info-*.txt
        retention-days: 7
      if: env.FILE_EXISTS == 'true'

    - name: Upload error log
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-error
        path: |
          /tmp/build.log
        retention-days: 7
      if: env.FILE_EXISTS == 'false'
