name: Build Kernel Module with OLLVM (CFI Safe)

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
          - exianb-dev
          - exianb
          - ovo
          - prctl-fd
          - prctl-hook
          - offset
          - hello-world
          - wuwa
          - panic
        default: 'exianb-dev'

      obfuscation_level:
        description: 'OLLVM obfuscation level'
        required: false
        default: 'medium'
        type: choice
        options:
          - none
          - light
          - medium
          - heavy

      use_custom_clang:
        description: 'Use custom OLLVM clang from ZIP'
        required: false
        default: true
        type: boolean

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Install tools
      run: |
        apt-get update
        apt-get install -y unzip file

    # -------------------------------------------------------
    # Extract OLLVM toolchain
    # -------------------------------------------------------
    - name: Extract OLLVM Toolchain
      if: inputs.use_custom_clang
      run: |
        echo "=== Installing OLLVM toolchain ==="

        rm -rf /usr/local/ollvm
        mkdir -p /usr/local/ollvm/bin

        for zip in "${{ inputs.module_dir }}"/clang*.zip; do
          [ -f "$zip" ] || continue
          echo "Extracting $zip"
          unzip -oq "$zip" -d /usr/local/ollvm
        done

        # Move binaries to bin/
        find /usr/local/ollvm -type f -executable \
          \( -name "clang*" -o -name "llvm-*" -o -name "ld.lld" \) \
          -exec mv {} /usr/local/ollvm/bin/ \; 2>/dev/null || true

        chmod -R +x /usr/local/ollvm/bin
        echo "PATH=/usr/local/ollvm/bin:$PATH" >> $GITHUB_ENV

        echo "=== OLLVM clang ==="
        clang --version | head -2

    # -------------------------------------------------------
    # Build with OLLVM + ThinLTO (CFI SAFE)
    # -------------------------------------------------------
    - name: Build module with OLLVM (ThinLTO)
      if: inputs.use_custom_clang
      run: |
        set -e

        MODULE="${{ inputs.module_dir }}"

        # ---------------------------------
        # OLLVM flags
        # ---------------------------------
        case "${{ inputs.obfuscation_level }}" in
          light)
            OLLVM="-mllvm -fla"
            ;;
          medium)
            OLLVM="-mllvm -fla -mllvm -sub"
            ;;
          heavy)
            OLLVM="-mllvm -fla -mllvm -sub -mllvm -bcf"
            ;;
          *)
            OLLVM=""
            ;;
        esac

        # ---------------------------------
        # Android CFI requires LTO
        # ---------------------------------
        KCFLAGS="$OLLVM -flto=thin"

        echo "KCFLAGS=$KCFLAGS"

        make -C "$KERNEL_SRC" M="$PWD/$MODULE" clean || true

        make -C "$KERNEL_SRC" M="$PWD/$MODULE" modules \
          CC=clang \
          LD=ld.lld \
          AR=llvm-ar \
          NM=llvm-nm \
          OBJCOPY=llvm-objcopy \
          STRIP=llvm-strip \
          KCFLAGS="$KCFLAGS" \
          -j$(nproc) \
          2>&1 | tee /tmp/build.log

    # -------------------------------------------------------
    # Fallback: default toolchain
    # -------------------------------------------------------
    - name: Build with default toolchain
      if: ${{ !inputs.use_custom_clang }}
      run: |
        make -C "$KERNEL_SRC" M="$PWD/${{ inputs.module_dir }}" modules \
          -j$(nproc) 2>&1 | tee /tmp/build.log

    # -------------------------------------------------------
    # Check result
    # -------------------------------------------------------
    - name: Check build result
      run: |
        KO=$(find "${{ inputs.module_dir }}" -name "*.ko" | head -1)

        if [ -f "$KO" ]; then
          echo "✅ Built: $KO"
          echo "KO_FILE=$KO" >> $GITHUB_ENV
          echo "FILE_EXISTS=true" >> $GITHUB_ENV
        else
          echo "❌ Build failed"
          tail -50 /tmp/build.log || true
          echo "FILE_EXISTS=false" >> $GITHUB_ENV
        fi

    # -------------------------------------------------------
    # Process artifact
    # -------------------------------------------------------
    - name: Prepare artifact
      if: env.FILE_EXISTS == 'true'
      run: |
        TS=$(date +%Y%m%d-%H%M%S)
        OUT="out/${{ inputs.module_dir }}-${{ matrix.kmi }}-ollvm-${{ inputs.obfuscation_level }}-$TS.ko"

        mkdir -p out
        cp "$KO_FILE" "$OUT"

        llvm-strip -d "$OUT" || strip --strip-debug "$OUT" || true

        echo "ARTIFACT=$OUT" >> $GITHUB_ENV
        du -h "$OUT"

    - name: Upload module
      if: env.FILE_EXISTS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}
        path: ${{ env.ARTIFACT }}
        retention-days: 7

    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-logs
        path: /tmp/build.log
        retention-days: 7
