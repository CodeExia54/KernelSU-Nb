name: Check DeClang Actual Capabilities

on:
  workflow_dispatch

jobs:
  check-declang:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ylarod/ddk:android13-5.15

    steps:
    - name: Download and extract DeClang
      run: |
        apt-get update && apt-get install -y unzip wget 2>/dev/null || true
        wget -q https://github.com/DeNA/DeClang/releases/download/swift5.10-v1.0.0/Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        unzip -q Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        chmod +x Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang

    - name: Check ALL Help Outputs
      run: |
        echo "=== COMPREHENSIVE HELP CHECK ==="
        CLANG="./Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang"
        
        echo "1. Basic --help:"
        $CLANG --help 2>&1 | grep -i "obfuscat\|flatten\|declang\|mllvm" | head -20
        
        echo ""
        echo "2. -cc1 --help (LLVM frontend):"
        $CLANG -cc1 --help 2>&1 | grep -i "obfuscat\|flatten\|pass" | head -20
        
        echo ""
        echo "3. -mllvm --help (ALL options):"
        $CLANG -mllvm --help 2>&1 > /tmp/mllvm_full.txt
        echo "Total -mllvm options: $(grep -c '^  -' /tmp/mllvm_full.txt)"
        echo "First 50 options:"
        head -100 /tmp/mllvm_full.txt
        
        echo ""
        echo "4. Searching for obfuscation in ALL help:"
        $CLANG --help 2>&1 | grep -B2 -A2 "mllvm" || echo "No mllvm in main help"
        
        echo ""
        echo "5. Check environment variables:"
        echo "Trying with DECLANG_HOME set:"
        export DECLANG_HOME=$(pwd)/Release-Linux-swift5.10-v1.0.0-ubuntu2204
        $CLANG --help 2>&1 | grep -i "declang" | head -5 || echo "No DeClang-specific output"

    - name: Check What Flags Are Actually Accepted
      run: |
        echo "=== TESTING ACTUAL FLAG ACCEPTANCE ==="
        CLANG="./Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang"
        
        # Create test file
        cat > /tmp/test.c << 'EOF'
        int main() { return 0; }
        EOF
        
        echo "Testing which flags don't cause errors:"
        
        # Test common obfuscation flag patterns
        FLAGS=(
            "-mllvm -flatten"
            "-mllvm -bcf" 
            "-mllvm -boguscf"
            "-mllvm -sub"
            "-mllvm -obfuscate"
            "-mllvm -irobf"
            "-mllvm --irobf-cff"
            "-mllvm --irobf-bcf"
            "-mllvm --irobf-cse"
            "-fobfuscate"
            "-fllvm-obfuscate"
            "-Xclang -load -Xclang *Obfuscation*"
        )
        
        for flag in "${FLAGS[@]}"; do
            echo -n "Testing $flag: "
            $CLANG $flag -c /tmp/test.c -o /tmp/test.o 2>&1 | grep -q "error\|unknown\|unrecognized" && \
                echo "❌ REJECTED" || echo "✅ ACCEPTED (or different error)"
        done

    - name: Check gen_config.sh Output
      run: |
        echo "=== ANALYZING gen_config.sh ==="
        
        if [ -f "./Release-Linux-swift5.10-v1.0.0-ubuntu2204/gen_config.sh" ]; then
            echo "gen_config.sh found. Checking what it generates:"
            
            mkdir -p ~/.DeClang
            ./Release-Linux-swift5.10-v1.0.0-ubuntu2204/gen_config.sh -path ./Release-Linux-swift5.10-v1.0.0-ubuntu2204 -seed "test123"
            
            echo "Generated config:"
            cat ~/.DeClang/config.json 2>/dev/null || \
                find ~/.DeClang -name "*.json" -type f | xargs cat 2>/dev/null || \
                echo "No config generated"
        fi

    - name: Look for Hidden Options
      run: |
        echo "=== SEARCHING FOR HIDDEN OPTIONS ==="
        
        # Search in all files
        find ./Release-Linux-swift5.10-v1.0.0-ubuntu2204 -type f \( -name "*.txt" -o -name "*.md" -o -name "*.rst" -o -name "*.help" \) | \
            xargs grep -l "obfuscat\|flatten\|bcf" 2>/dev/null || echo "No documentation files found"
        
        echo ""
        echo "Checking for plugin .so files:"
        find ./Release-Linux-swift5.10-v1.0.0-ubuntu2204 -name "*.so" -type f | head -10
