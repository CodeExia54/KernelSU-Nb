name: Build Kernel Module with DeClang OLLVM

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'wuwa'
      obfuscation_level:
        description: 'OLLVM obfuscation level'
        required: false
        default: 'medium'
        type: choice
        options:
        - none
        - light
        - medium
        - heavy

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Install unzip (container doesn't have it)
      run: |
        echo "Installing unzip..."
        apt-get update && apt-get install -y unzip
        echo "✅ unzip installed"

    - name: Step 1: Environment Setup
      run: |
        echo "=== Environment Setup ==="
        echo "Container: ${{ matrix.kmi }}"
        echo "Module: ${{ inputs.module_dir }}"
        echo "Obfuscation: ${{ inputs.obfuscation_level }}"
        echo ""
        echo "=== DDK Toolchain ==="
        which clang && clang --version | head -1 || echo "No clang found"
        echo ""
        echo "=== Kernel Source ==="
        echo "KERNEL_SRC: $KERNEL_SRC"
        [ -d "$KERNEL_SRC" ] && echo "✅ Kernel source exists" || echo "❌ Kernel source missing"

    - name: Step 2: Download and Setup DeClang
      if: ${{ inputs.obfuscation_level != 'none' }}
      run: |
        echo "=== Downloading DeClang ==="
        
        # Clean any previous downloads
        rm -rf Release-Linux-swift5.10-v1.0.0-ubuntu2204*
        
        # Download
        echo "Downloading DeClang..."
        wget -q https://github.com/DeNA/DeClang/releases/download/swift5.10-v1.0.0/Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        echo "✅ Download complete"
        
        # Extract
        echo "Extracting..."
        unzip -q Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        echo "✅ Extraction complete"
        
        # Set paths
        DECLANG_CLANG="$(pwd)/Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang"
        
        echo ""
        echo "=== Path Verification ==="
        echo "DeClang path: $DECLANG_CLANG"
        
        if [ ! -f "$DECLANG_CLANG" ]; then
          echo "❌ ERROR: DeClang clang not found!"
          exit 1
        fi
        
        chmod +x "$DECLANG_CLANG"
        echo "✅ DeClang clang is executable"
        
        # Test basic functionality
        echo ""
        echo "=== Basic Function Test ==="
        "$DECLANG_CLANG" --version | head -1
        echo 'int main(){return 0;}' | "$DECLANG_CLANG" -x c -o /dev/null - && \
          echo "✅ Basic compilation works" || echo "❌ Basic compilation failed"
        
        # Save path
        echo "DECLANG_CLANG=$DECLANG_CLANG" >> $GITHUB_ENV

    - name: Step 3: Check OLLVM Support
      if: ${{ inputs.obfuscation_level != 'none' }}
      env:
        DECLANG_CLANG: ${{ env.DECLANG_CLANG }}
      run: |
        echo "=== Checking OLLVM Support ==="
        
        echo "1. Testing -mllvm flag:"
        if "$DECLANG_CLANG" -x c -o /dev/null -mllvm -fla - <<<'int main(){return 0;}' 2>/dev/null; then
          echo "   ✅ -mllvm flag supported"
        else
          echo "   ❌ -mllvm flag NOT supported"
          exit 1
        fi
        
        echo ""
        echo "2. Setting OLLVM flags:"
        
        case "${{ inputs.obfuscation_level }}" in
          "light")
            OLLVM_FLAGS="-mllvm -fla"
            ;;
          "medium")
            OLLVM_FLAGS="-mllvm -fla -mllvm -sub"
            ;;
          "heavy")
            OLLVM_FLAGS="-mllvm -fla -mllvm -sub -mllvm -bcf"
            ;;
        esac
        
        echo "   Selected flags: $OLLVM_FLAGS"
        
        # Test the flag combination
        echo 'int main(){return 0;}' | "$DECLANG_CLANG" -x c -o /dev/null $OLLVM_FLAGS 2>/dev/null && \
          echo "✅ OLLVM flags work" || echo "❌ OLLVM flags failed"
        
        echo "OLLVM_FLAGS=$OLLVM_FLAGS" >> $GITHUB_ENV

    - name: Step 4: Build Module
      env:
        DECLANG_CLANG: ${{ env.DECLANG_CLANG }}
        OLLVM_FLAGS: ${{ env.OLLVM_FLAGS }}
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko ==="
        
        # Select compiler
        if ${{ inputs.obfuscation_level != 'none' }} && [ -n "$DECLANG_CLANG" ]; then
          CC="$DECLANG_CLANG"
          echo "Using: DeClang with ${{ inputs.obfuscation_level }} obfuscation"
          echo "OLLVM Flags: $OLLVM_FLAGS"
        else
          CC="clang"
          OLLVM_FLAGS=""
          echo "Using: DDK default clang (no obfuscation)"
        fi
        
        echo "Compiler: $CC"
        
        # Build
        make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} modules \
          CC="$CC" \
          EXTRA_CFLAGS="$OLLVM_FLAGS"
        
        echo ""
        echo "=== Build Result ==="
        
        # Find the .ko file
        KO_FILE=$(find "${{ inputs.module_dir }}" -name "*.ko" -type f | head -1)
        if [ -z "$KO_FILE" ] || [ ! -f "$KO_FILE" ]; then
          echo "❌ BUILD FAILED: No .ko file found!"
          exit 1
        fi
        
        echo "✅ BUILD SUCCESS: $KO_FILE"
        echo "Size: $(du -h "$KO_FILE" | cut -f1)"
        
        # Quick verification of obfuscation
        if ${{ inputs.obfuscation_level != 'none' }}; then
          echo ""
          echo "=== Quick Obfuscation Check ==="
          JUMP_COUNT=$(objdump -d "$KO_FILE" 2>/dev/null | grep -c "jmp\|je\|jne" || echo 0)
          echo "Jump instructions: $JUMP_COUNT"
          
          if [ $JUMP_COUNT -gt 20 ]; then
            echo "✅ High jump count (obfuscation likely working)"
          fi
        fi
        
        echo "BUILT_KO_FILE=$KO_FILE" >> $GITHUB_ENV

    - name: Step 5: Create Artifact
      env:
        BUILT_KO_FILE: ${{ env.BUILT_KO_FILE }}
      run: |
        echo "=== Creating Artifact ==="
        
        if [ -z "$BUILT_KO_FILE" ] || [ ! -f "$BUILT_KO_FILE" ]; then
          echo "❌ No .ko file to package"
          exit 1
        fi
        
        # Create output directory
        mkdir -p /github/workspace/out
        
        # Generate artifact name
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        if ${{ inputs.obfuscation_level != 'none' }}; then
          OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-ollvm-$TIMESTAMP.ko"
        else
          OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-normal-$TIMESTAMP.ko"
        fi
        
        # Copy file
        cp "$BUILT_KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
        
        echo "Artifact: $OUTPUT_NAME"
        echo "Size: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"
        
        # Strip debug symbols
        if command -v llvm-strip >/dev/null 2>&1; then
          llvm-strip -d "/github/workspace/out/$OUTPUT_NAME" 2>/dev/null || true
        fi
        
        echo "ARTIFACT_PATH=/github/workspace/out/$OUTPUT_NAME" >> $GITHUB_ENV

    - name: Step 6: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-${{ inputs.obfuscation_level }}
        path: ${{ env.ARTIFACT_PATH }}
        retention-days: 7
