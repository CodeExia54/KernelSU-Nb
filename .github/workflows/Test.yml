name: Analyze Kernel Clang Configuration

on:
  workflow_dispatch:
    inputs:
      target_kmi:
        description: 'Target KMI'
        required: true
        type: choice
        options:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
        default: 'android12-5.10'

jobs:
  analyze:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ylarod/ddk:${{ inputs.target_kmi }}

    steps:
    - name: Analyze Clang Config
      run: |
        echo "=== CLANG CONFIGURATION ANALYSIS ==="
        
        # Get clang path
        CLANG=$(make -C "$KERNEL_SRC" -n V=1 2>&1 | grep -o "/[^ ]*/clang[^ ]*" | head -1)
        [ -z "$CLANG" ] && CLANG=$(which clang)
        echo "CLANG_PATH=$CLANG"
        
        # Get version
        VERSION=$($CLANG --version | head -1)
        echo "VERSION=$VERSION"
        
        # Get target
        TARGET=$($CLANG -dumpmachine)
        echo "TARGET=$TARGET"
        
        # Check features
        echo "FEATURES:"
        $CLANG -mllvm -help 2>&1 | grep -q "LLVM" && echo "HAS_MLLVM=yes" || echo "HAS_MLLVM=no"
        $CLANG -flto=thin -c -o /dev/null /dev/null 2>&1 | grep -q "error" && echo "HAS_THINLTO=no" || echo "HAS_THINLTO=yes"
        $CLANG -fsanitize=cfi -c -o /dev/null /dev/null 2>&1 | grep -q "error" && echo "HAS_CFI=no" || echo "HAS_CFI=yes"
        
        # Save to file
        {
          echo "CLANG_PATH=$CLANG"
          echo "VERSION=$VERSION"
          echo "TARGET=$TARGET"
          $CLANG -mllvm -help 2>&1 | grep -q "LLVM" && echo "HAS_MLLVM=yes" || echo "HAS_MLLVM=no"
          $CLANG -flto=thin -c -o /dev/null /dev/null 2>&1 | grep -q "error" && echo "HAS_THINLTO=no" || echo "HAS_THINLTO=yes"
          $CLANG -fsanitize=cfi -c -o /dev/null /dev/null 2>&1 | grep -q "error" && echo "HAS_CFI=no" || echo "HAS_CFI=yes"
        } > /tmp/clang_config.txt

    - name: Upload Config
      uses: actions/upload-artifact@v4
      with:
        name: clang-config-${{ inputs.target_kmi }}
        path: /tmp/clang_config.txt
