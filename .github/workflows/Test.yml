name: Build Kernel Module with OLLVM

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'exianb-dev'
      obfuscation_level:
        description: 'OLLVM obfuscation level'
        required: false
        default: 'medium'
        type: choice
        options:
        - none
        - light
        - medium
        - heavy
      use_custom_clang:
        description: 'Use custom OLLVM clang from ZIP'
        required: false
        default: 'false'
        type: boolean

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Install unzip in container
      run: |
        apt-get update && apt-get install -y unzip file

    - name: Extract OLLVM Toolchain
      if: ${{ inputs.use_custom_clang }}
      run: |
        echo "=== Extracting OLLVM Toolchain ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Clean any existing ollvm directory
        rm -rf /usr/local/ollvm
        mkdir -p /usr/local/ollvm
        
        # Find and extract ZIP files
        ZIP_COUNT=0
        for zip_file in "$MODULE_DIR"/clang*.zip; do
          if [ -f "$zip_file" ]; then
            ZIP_COUNT=$((ZIP_COUNT + 1))
            echo "=== Extracting $(basename "$zip_file") ==="
            unzip -q "$zip_file" -d /usr/local/ollvm/
          fi
        done
        
        if [ $ZIP_COUNT -eq 0 ]; then
          echo "❌ No clang*.zip files found in $MODULE_DIR/"
          echo "Available files:"
          ls -la "$MODULE_DIR"/ || echo "Directory doesn't exist"
          exit 1
        fi
        
        # Organize binaries
        echo ""
        echo "=== Organizing Binaries ==="
        
        # Create bin directory
        mkdir -p /usr/local/ollvm/bin
        
        # Move all executables to bin/
        find /usr/local/ollvm -type f -executable -exec mv {} /usr/local/ollvm/bin/ \; 2>/dev/null || true
        
        # Also look for clang/llvm specifically
        find /usr/local/ollvm -type f -name "clang*" -exec mv {} /usr/local/ollvm/bin/ \; 2>/dev/null || true
        find /usr/local/ollvm -type f -name "llvm-*" -exec mv {} /usr/local/ollvm/bin/ \; 2>/dev/null || true
        find /usr/local/ollvm -type f -name "ld.lld" -exec mv {} /usr/local/ollvm/bin/ \; 2>/dev/null || true
        find /usr/local/ollvm -type f -name "lld" -exec mv {} /usr/local/ollvm/bin/ \; 2>/dev/null || true
        
        # Make everything executable
        chmod -R +x /usr/local/ollvm/bin/ 2>/dev/null || true
        
        # Check what we have
        echo ""
        echo "=== Toolchain Contents ==="
        echo "Binaries in /usr/local/ollvm/bin/:"
        ls -la /usr/local/ollvm/bin/ || echo "No binaries found"
        
        # Test clang
        echo ""
        echo "=== Testing OLLVM Clang ==="
        if [ -f "/usr/local/ollvm/bin/clang" ]; then
          echo "✅ OLLVM clang found"
          /usr/local/ollvm/bin/clang --version | head -3
          
          # Check if it's actually OLLVM
          if /usr/local/ollvm/bin/clang --version 2>&1 | grep -i "ollvm\|obfuscator"; then
            echo "✅ This is OLLVM/obfuscator version"
          else
            echo "⚠️ This doesn't appear to be OLLVM (no 'ollvm' or 'obfuscator' in version)"
          fi
        else
          echo "❌ clang not found in /usr/local/ollvm/bin/"
          echo "Looking for any clang binary..."
          find /usr/local/ollvm -name "*clang*" -type f | head -10
          exit 1
        fi
        
        # Add to PATH
        export PATH=/usr/local/ollvm/bin:$PATH
        echo 'export PATH=/usr/local/ollvm/bin:$PATH' >> /etc/profile.d/ollvm.sh
        
        echo "OLLVM_TOOLCHAIN_INSTALLED=true" >> $GITHUB_ENV

    - name: Build with OLLVM
      if: ${{ inputs.use_custom_clang }}
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko with OLLVM ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Set OLLVM flags based on level
        case "${{ inputs.obfuscation_level }}" in
          "light")
            OLLVM_FLAGS="-mllvm -fla"
            echo "OLLVM Level: light (flags: -fla)"
            ;;
          "medium")
            OLLVM_FLAGS="-mllvm -fla -mllvm -sub"
            echo "OLLVM Level: medium (flags: -fla -sub)"
            ;;
          "heavy")
            OLLVM_FLAGS="-mllvm -fla -mllvm -sub -mllvm -bcf"
            echo "OLLVM Level: heavy (flags: -fla -sub -bcf)"
            ;;
          *)
            OLLVM_FLAGS=""
            echo "OLLVM Level: none"
            ;;
        esac
        
        # CRITICAL: Disable LTO and CFI for Android kernels
        # Android kernels enable CFI which requires LTO
        DISABLE_LTO_CFI_FLAGS="-fno-lto -fno-sanitize=cfi"
        
        echo ""
        echo "=== Build Configuration ==="
        echo "OLLVM flags: $OLLVM_FLAGS"
        echo "LTO/CFI flags: $DISABLE_LTO_CFI_FLAGS"
        echo "Module directory: $MODULE_DIR"
        echo "Kernel source: $KERNEL_SRC"
        echo "KMI: ${{ matrix.kmi }}"
        
        # Clean first
        echo ""
        echo "=== Cleaning previous build ==="
        make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" clean 2>/dev/null || true
        
        # Try multiple approaches
        echo ""
        echo "=== Attempt 1: Simple KCFLAGS approach ==="
        
        set +e
        make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules \
          KCFLAGS="$OLLVM_FLAGS $DISABLE_LTO_CFI_FLAGS" \
          -j$(nproc) 2>&1 | tee /tmp/build_attempt1.log
        ATTEMPT1_EXIT=$?
        set -e
        
        if [ $ATTEMPT1_EXIT -eq 0 ] && [ -f "$MODULE_DIR"/*.ko ]; then
          echo "✅ Attempt 1 successful!"
        else
          echo "❌ Attempt 1 failed, trying Attempt 2..."
          
          # Clean again
          make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" clean 2>/dev/null || true
          
          echo ""
          echo "=== Attempt 2: More comprehensive LTO/CFI disable ==="
          
          # More comprehensive LTO/CFI disable flags
          COMPREHENSIVE_DISABLE_FLAGS=" \
            -fno-lto \
            -fno-sanitize=cfi \
            -fno-sanitize=cfi-icall \
            -fno-sanitize=cfi-nvcall \
            -fno-sanitize=cfi-derived-cast \
            -fno-sanitize=cfi-unrelated-cast"
          
          set +e
          make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules \
            KCFLAGS="$OLLVM_FLAGS $COMPREHENSIVE_DISABLE_FLAGS" \
            -j$(nproc) 2>&1 | tee /tmp/build_attempt2.log
          ATTEMPT2_EXIT=$?
          set -e
          
          if [ $ATTEMPT2_EXIT -eq 0 ] && [ -f "$MODULE_DIR"/*.ko ]; then
            echo "✅ Attempt 2 successful!"
          else
            echo "❌ Attempt 2 failed, trying Attempt 3..."
            
            # Clean again
            make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" clean 2>/dev/null || true
            
            echo ""
            echo "=== Attempt 3: CC override approach ==="
            
            # Try overriding the compiler directly
            set +e
            make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules \
              CC="/usr/local/ollvm/bin/clang" \
              KCFLAGS="$OLLVM_FLAGS $DISABLE_LTO_CFI_FLAGS" \
              HOSTCC="gcc" \
              HOSTCXX="g++" \
              -j$(nproc) 2>&1 | tee /tmp/build_attempt3.log
            ATTEMPT3_EXIT=$?
            set -e
            
            if [ $ATTEMPT3_EXIT -ne 0 ] || [ ! -f "$MODULE_DIR"/*.ko ]; then
              echo "❌ Attempt 3 failed, trying final attempt..."
              
              # Clean again
              make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" clean 2>/dev/null || true
              
              echo ""
              echo "=== Final Attempt: Kernel build flags approach ==="
              
              # Set environment variables that the kernel build system respects
              export KCFLAGS="$OLLVM_FLAGS $DISABLE_LTO_CFI_FLAGS"
              export CC="/usr/local/ollvm/bin/clang"
              
              set +e
              make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules -j$(nproc) 2>&1 | tee /tmp/build_final.log
              FINAL_EXIT=$?
              set -e
              
              if [ $FINAL_EXIT -ne 0 ] || [ ! -f "$MODULE_DIR"/*.ko ]; then
                echo "❌ All attempts failed!"
                echo "=== Last 50 lines of build log ==="
                tail -50 /tmp/build_final.log || tail -50 /tmp/build_attempt3.log || tail -50 /tmp/build_attempt2.log || tail -50 /tmp/build_attempt1.log
                exit 1
              fi
            fi
          fi
        fi
        
        echo "✅ Build completed successfully!"

    - name: Build with Default Toolchain
      if: ${{ !inputs.use_custom_clang }}
      run: |
        echo "=== Building with Default Toolchain ==="
        MODULE_DIR="${{ inputs.module_dir }}"
        
        make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules -j$(nproc) 2>&1 | tee /tmp/build.log

    - name: Check Build Result
      run: |
        echo "=== Checking Build Result ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Find the .ko file
        KO_FILE=$(find "$MODULE_DIR" -name "*.ko" -type f | head -1)
        
        if [ -f "$KO_FILE" ]; then
          echo "✅ Build successful! Found: $KO_FILE"
          echo "File size: $(du -h "$KO_FILE" | cut -f1)"
          echo "File type:"
          file "$KO_FILE"
          
          # Check for OLLVM patterns if OLLVM was used
          if [ "${{ inputs.use_custom_clang }}" = "true" ]; then
            echo ""
            echo "=== Checking for OLLVM obfuscation ==="
            
            # Check .comment section for OLLVM markers
            if readelf -p .comment "$KO_FILE" 2>/dev/null | grep -i "fla\|sub\|bcf\|ollvm\|obfuscator"; then
              echo "✅ OLLVM obfuscation detected in .comment section"
            else
              echo "⚠️ No OLLVM markers in .comment section"
              
              # Try checking for obfuscated code patterns
              echo "Checking for control flow flattening patterns..."
              if objdump -d "$KO_FILE" 2>/dev/null | head -100 | grep -i "switch\|jump\|indirect"; then
                echo "⚠️ Potential obfuscation patterns found (needs manual verification)"
              fi
            fi
          fi
          
          echo "FILE_EXISTS=true" >> $GITHUB_ENV
          echo "KO_FILE_PATH=$KO_FILE" >> $GITHUB_ENV
        else
          echo "❌ Build failed! No .ko file found in $MODULE_DIR/"
          echo "Directory contents:"
          ls -la "$MODULE_DIR"/ 2>/dev/null || echo "Directory doesn't exist"
          echo "FILE_EXISTS=false" >> $GITHUB_ENV
        fi

    - name: Process Successful Build
      if: env.FILE_EXISTS == 'true'
      run: |
        MODULE_DIR="${{ inputs.module_dir }}"
        KO_FILE="${{ env.KO_FILE_PATH }}"
        
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        
        # Create output name based on build type
        if [ "${{ inputs.use_custom_clang }}" = "true" ]; then
          OUTPUT_NAME="$MODULE_DIR-${{ matrix.kmi }}-ollvm-${{ inputs.obfuscation_level }}-$TIMESTAMP.ko"
        else
          OUTPUT_NAME="$MODULE_DIR-${{ matrix.kmi }}-default-$TIMESTAMP.ko"
        fi
        
        mkdir -p /github/workspace/out
        cp "$KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
        
        # Optional: Strip debug symbols to reduce size
        echo "Stripping debug symbols..."
        llvm-strip -d "/github/workspace/out/$OUTPUT_NAME" 2>/dev/null || \
        strip --strip-debug "/github/workspace/out/$OUTPUT_NAME" 2>/dev/null || \
        echo "Warning: Could not strip debug symbols"
        
        echo "Final size: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"
        echo "ARTIFACT_PATH=/github/workspace/out/$OUTPUT_NAME" >> $GITHUB_ENV

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}
        path: ${{ env.ARTIFACT_PATH }}
        retention-days: 7
      if: env.FILE_EXISTS == 'true'

    - name: Upload Build Logs
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-logs
        path: /tmp/build*.log
        retention-days: 7
      if: always()
