name: Build Kernel Module ddk (OLLVM Levels)

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory'
        required: true
        type: choice
        options:
          - wuwa
        default: 'wuwa'

      # OLLVM Configuration Options
      obfuscation_level:
        description: 'OLLVM obfuscation strength'
        required: true
        type: choice
        options:
          - easy
          - medium
          - hard
          - extreme
        default: easy

      enable_fla:
        description: 'Enable Control Flow Flattening'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'yes'

      enable_split:
        description: 'Enable Basic Block Splitting'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

      split_num:
        description: 'Splitting iterations (1-5)'
        required: true
        type: string
        default: '3'

      enable_sub:
        description: 'Enable Instruction Substitution'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

      sub_loop:
        description: 'Substitution iterations (1-5)'
        required: true
        type: string
        default: '2'

      enable_bcf:
        description: 'Enable Bogus Control Flow'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

      bcf_loop:
        description: 'BCF iterations (1-5)'
        required: true
        type: string
        default: '2'

      bcf_prob:
        description: 'BCF probability (1-100)'
        required: true
        type: string
        default: '40'

      enable_sobf:
        description: 'Enable String Obfuscation'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }} (${{ inputs.obfuscation_level }}) for ${{ matrix.kmi }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    # ==================================================
    # Install unzip and required tools
    # ==================================================
    - name: Install required tools
      run: |
        apt-get update
        apt-get install -y unzip file binutils

    # ==================================================
    # Extract OLLVM toolchain directly
    # ==================================================
    - name: Extract OLLVM toolchain
      run: |
        set -e
        cd ${{ inputs.module_dir }}
        
        echo "=== Current directory structure ==="
        ls -la
        
        echo "=== Extracting OLLVM ZIPs ==="
        
        # Extract first ZIP directly
        echo "Extracting android-ollvm.zip..."
        unzip -q android-ollvm.zip
        
        # Extract second ZIP directly (will merge with first)
        echo "Extracting android-ollvm1.zip..."
        unzip -q -o android-ollvm1.zip
        
        echo "=== After extraction structure ==="
        ls -la android-ollvm/
        ls -la android-ollvm/bin/
        
        # Fix permissions on clang binary
        echo "=== Fixing permissions ==="
        chmod 755 android-ollvm/bin/clang
        chmod 755 android-ollvm/bin/clang++
        chmod 755 android-ollvm/bin/llvm-ar
        
        echo "OLLVM clang version:"
        ./android-ollvm/bin/clang --version | head -5

    # ==================================================
    # WORKING SOLUTION: Manual OLLVM compilation
    # ==================================================
    - name: Build module with manual OLLVM
      run: |
        echo "=== WORKING SOLUTION: Manual OLLVM Compilation ==="
        echo "Module directory: ${{ inputs.module_dir }}"
        echo "Kernel source: $KERNEL_SRC"
        
        cd ${{ inputs.module_dir }}
        
        # STEP 1: Build OLLVM flags from user inputs
        OLLVM_FLAGS=""
        OLLVM_DESCRIPTION=""
        
        # Control Flow Flattening
        if [ "${{ inputs.enable_fla }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -fla"
          OLLVM_DESCRIPTION="$OLLVM_DESCRIPTION, Control Flow Flattening"
        fi
        
        # Basic Block Splitting
        if [ "${{ inputs.enable_split }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -split -mllvm -split_num=${{ inputs.split_num }}"
          OLLVM_DESCRIPTION="$OLLVM_DESCRIPTION, Basic Block Splitting (iterations: ${{ inputs.split_num }})"
        fi
        
        # Instruction Substitution
        if [ "${{ inputs.enable_sub }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -sub -mllvm -sub_loop=${{ inputs.sub_loop }}"
          OLLVM_DESCRIPTION="$OLLVM_DESCRIPTION, Instruction Substitution (iterations: ${{ inputs.sub_loop }})"
        fi
        
        # Bogus Control Flow
        if [ "${{ inputs.enable_bcf }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -bcf -mllvm -bcf_loop=${{ inputs.bcf_loop }} -mllvm -bcf_prob=${{ inputs.bcf_prob }}"
          OLLVM_DESCRIPTION="$OLLVM_DESCRIPTION, Bogus Control Flow (iterations: ${{ inputs.bcf_loop }}, probability: ${{ inputs.bcf_prob }}%)"
        fi
        
        # String Obfuscation
        if [ "${{ inputs.enable_sobf }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -sobf"
          OLLVM_DESCRIPTION="$OLLVM_DESCRIPTION, String Obfuscation"
        fi
        
        # Remove leading comma and space
        OLLVM_DESCRIPTION=${OLLVM_DESCRIPTION#, }
        
        echo "Custom OLLVM Flags: $OLLVM_FLAGS"
        if [ -n "$OLLVM_DESCRIPTION" ]; then
          echo "OLLVM Features: $OLLVM_DESCRIPTION"
        fi
        
        # Also apply predefined level for backward compatibility
        OLLVM_LEVEL="${{ inputs.obfuscation_level }}"
        
        # STEP 2: Verify OLLVM clang works
        echo ""
        echo "=== STEP 2: Verifying OLLVM Clang ==="
        
        # Create a simple test file
        echo 'int test() { return 42; }' > test_ollvm.c
        
        if ./android-ollvm/bin/clang -mllvm -fla -c test_ollvm.c -o test_ollvm.o 2>&1 | grep -q "Unknown command line argument"; then
          echo "❌ ERROR: OLLVM clang doesn't support -fla flag!"
          echo "This is not a real OLLVM clang!"
          exit 1
        else
          echo "✅ OLLVM clang verified"
          rm -f test_ollvm.c test_ollvm.o
        fi
        
        # STEP 3: Get the exact compiler flags from kernel build system
        echo ""
        echo "=== STEP 3: Getting kernel compiler flags ==="
        
        # First, clean everything
        make -C $KERNEL_SRC M=$PWD clean 2>&1 >/dev/null || true
        
        # Build one file with V=1 to see the exact command
        echo "Building one file to capture compiler flags..."
        make -C $KERNEL_SRC M=$PWD V=1 src/core/wuwa.o 2>&1 | grep "clang.*wuwa.c" | head -1 > compile_command.txt || true
        
        if [ -s compile_command.txt ]; then
          COMPILE_CMD=$(cat compile_command.txt)
          echo "Captured compile command:"
          echo "$COMPILE_CMD"
          
          # Extract just the flags (remove the input/output files)
          # Remove everything after -c and before -o
          FLAGS_PART=$(echo "$COMPILE_CMD" | sed 's/-c.*//')
          echo "Flags part: $FLAGS_PART"
        else
          echo "⚠️ Could not capture compile command, using default flags"
          FLAGS_PART="clang --target=aarch64-linux-gnu -D__KERNEL__ -I$KERNEL_SRC/include -I$KERNEL_SRC/arch/arm64/include"
        fi
        
        # STEP 4: Manually compile OLLVM objects with OLLVM clang
        echo ""
        echo "=== STEP 4: Manually compiling OLLVM objects ==="
        
        # OLLVM source files
        OLLVM_SOURCES=(
          "src/core/wuwa.c"
          "src/utils/wuwa_utils.c"
          "src/mm/wuwa_page_walk.c"
          "src/mm/wuwa_bindproc.c"
        )
        
        # Common OLLVM flags
        OLLVM_COMMON_FLAGS="-fno-lto -fno-sanitize=cfi -fno-sanitize=shadow-call-stack"
        
        echo "Compiling ${#OLLVM_SOURCES[@]} files with OLLVM clang..."
        
        for src in "${OLLVM_SOURCES[@]}"; do
          obj="${src%.c}.o"
          echo ""
          echo "--- Compiling $src ---"
          
          # Build the command
          CMD="./android-ollvm/bin/clang"
          CMD="$CMD -c $src -o $obj"
          CMD="$CMD --target=aarch64-linux-gnu"
          CMD="$CMD -D__KERNEL__"
          CMD="$CMD -I$KERNEL_SRC/include"
          CMD="$CMD -I$KERNEL_SRC/arch/arm64/include"
          CMD="$CMD -I$KERNEL_SRC/arch/arm64/include/generated"
          CMD="$CMD -I./src/core -I./src/net -I./src/ioctl -I./src/mm -I./src/inlinehook -I./src/hook -I./src/proc -I./src/utils"
          CMD="$CMD -Wno-implicit-function-declaration -Wno-strict-prototypes -Wno-int-conversion"
          CMD="$CMD -Wno-gcc-compat -Wno-declaration-after-statement -Wno-unused-function"
          CMD="$CMD -Wno-unused-variable -Wno-unused-label"
          CMD="$CMD -DHIDE_SELF_MODULE -DBUILD_HIDE_SIGNAL -DBUILD_NO_CFI -DENABLE_WUWA_LOGS"
          CMD="$CMD $OLLVM_COMMON_FLAGS"
          CMD="$CMD $OLLVM_FLAGS"
          
          # For kernel module specific flags
          CMD="$CMD -fno-PIE -fno-pic -fshort-wchar -fno-strict-aliasing"
          CMD="$CMD -fno-common -mgeneral-regs-only -std=gnu89"
          
          echo "Command (short): ./android-ollvm/bin/clang ... $OLLVM_FLAGS -c $src -o $obj"
          
          # Execute
          if eval "$CMD" 2>&1; then
            if [ -f "$obj" ]; then
              SIZE=$(du -h "$obj" | cut -f1)
              echo "✅ Compiled: $obj ($SIZE)"
            else
              echo "❌ Object file not created"
            fi
          else
            echo "❌ Compilation failed"
            # Try without problematic flags
            echo "Trying with just -mllvm -fla..."
            SIMPLE_CMD="./android-ollvm/bin/clang -c $src -o $obj --target=aarch64-linux-gnu -D__KERNEL__ -I$KERNEL_SRC/include -mllvm -fla"
            eval "$SIMPLE_CMD" 2>&1 || echo "Simple compilation also failed"
          fi
        done
        
        # STEP 5: Create dummy .c files to prevent kernel from recompiling
        echo ""
        echo "=== STEP 5: Preventing kernel recompilation ==="
        
        for src in "${OLLVM_SOURCES[@]}"; do
          if [ -f "${src%.c}.o" ]; then
            echo "Creating dummy file for: $src"
            echo "/* Pre-compiled with OLLVM - see ${src%.c}.o */" > "$src.dummy"
            mv "$src" "$src.backup"
            mv "$src.dummy" "$src"
          fi
        done
        
        # STEP 6: Build the rest with kernel build system
        echo ""
        echo "=== STEP 6: Building rest with kernel build system ==="
        
        # Clean any other .o files (non-OLLVM ones will be rebuilt)
        find . -name "*.o" ! -name "wuwa.o" ! -name "wuwa_utils.o" ! -name "wuwa_page_walk.o" ! -name "wuwa_bindproc.o" -delete 2>/dev/null || true
        
        echo "Building module (kernel will use our pre-compiled .o files)..."
        make -C $KERNEL_SRC M=$PWD modules 2>&1 | tee build.log
        
        # Check if build succeeded
        if [ $? -ne 0 ]; then
          echo "❌ Build failed!"
          echo "Last 50 lines:"
          tail -50 build.log
          
          # Restore backup files before exiting
          echo "Restoring original source files..."
          for src in "${OLLVM_SOURCES[@]}"; do
            if [ -f "$src.backup" ]; then
              mv "$src.backup" "$src"
            fi
          done
          exit 1
        fi
        
        # STEP 7: Restore original source files
        echo ""
        echo "=== STEP 7: Restoring original source files ==="
        for src in "${OLLVM_SOURCES[@]}"; do
          if [ -f "$src.backup" ]; then
            mv "$src.backup" "$src"
            echo "Restored: $src"
          fi
        done
        
        # STEP 8: Verify and package the module
        echo ""
        echo "=== STEP 8: Final verification ==="
        
        KO_FILE=$(find . -name "*.ko" -type f | head -1)
        if [ -z "$KO_FILE" ]; then
          echo "❌ ERROR: No .ko file found!"
          exit 1
        fi
        
        echo "✅ Found kernel module: $KO_FILE"
        echo "File type: $(file "$KO_FILE")"
        
        # Check object file sizes
        echo ""
        echo "=== Object File Analysis ==="
        echo "OLLVM objects (should be larger):"
        OLLVM_SIZE_TOTAL=0
        OLLVM_COUNT=0
        for obj in src/core/wuwa.o src/utils/wuwa_utils.o src/mm/wuwa_page_walk.o src/mm/wuwa_bindproc.o; do
          if [ -f "$obj" ]; then
            SIZE=$(stat -c%s "$obj" 2>/dev/null || stat -f%z "$obj")
            OLLVM_SIZE_TOTAL=$((OLLVM_SIZE_TOTAL + SIZE))
            OLLVM_COUNT=$((OLLVM_COUNT + 1))
            echo "  $(basename "$obj"): $((SIZE/1024)) KB"
          fi
        done
        
        echo ""
        echo "Non-OLLVM objects (for comparison):"
        NON_OLLVM_SIZE_TOTAL=0
        NON_OLLVM_COUNT=0
        for obj in src/net/wuwa_sock.o src/ioctl/wuwa_ioctl.o; do
          if [ -f "$obj" ]; then
            SIZE=$(stat -c%s "$obj" 2>/dev/null || stat -f%z "$obj")
            NON_OLLVM_SIZE_TOTAL=$((NON_OLLVM_SIZE_TOTAL + SIZE))
            NON_OLLVM_COUNT=$((NON_OLLVM_COUNT + 1))
            echo "  $(basename "$obj"): $((SIZE/1024)) KB"
          fi
        done
        
        if [ $OLLVM_COUNT -gt 0 ] && [ $NON_OLLVM_COUNT -gt 0 ]; then
          OLLVM_AVG=$((OLLVM_SIZE_TOTAL / OLLVM_COUNT))
          NON_OLLVM_AVG=$((NON_OLLVM_SIZE_TOTAL / NON_OLLVM_COUNT))
          RATIO=$(( (OLLVM_AVG * 100) / NON_OLLVM_AVG ))
          
          echo ""
          echo "Size comparison:"
          echo "  OLLVM objects average: $((OLLVM_AVG/1024)) KB"
          echo "  Non-OLLVM objects average: $((NON_OLLVM_AVG/1024)) KB"
          echo "  Ratio: OLLVM is ${RATIO}% of non-OLLVM size"
          
          if [ $RATIO -gt 110 ]; then
            echo "  ✅ OLLVM objects are larger (obfuscation likely working)"
          elif [ $RATIO -gt 90 ]; then
            echo "  ⚠️  Similar sizes (obfuscation might not be applied)"
          else
            echo "  ❌ OLLVM objects are smaller (unexpected)"
          fi
        fi
        
        # Create output
        mkdir -p /github/workspace/out
        TS=$(date +'%Y%m%d-%H%M%S')
        OUT="/github/workspace/out/${{ inputs.module_dir }}-${{ matrix.kmi }}-$OLLVM_LEVEL-$TS.ko"
        
        cp "$KO_FILE" "$OUT"
        
        echo ""
        echo "=== Module Info ==="
        echo "Before strip: $(du -h "$OUT")"
        
        if command -v llvm-strip &> /dev/null; then
          llvm-strip -d "$OUT"
        elif command -v strip &> /dev/null; then
          strip --strip-debug "$OUT"
        fi
        
        echo "After strip: $(du -h "$OUT")"
        
        echo ""
        echo "✅ BUILD COMPLETED SUCCESSFULLY!"
        echo "Output: $OUT"
        echo ""
        echo "=== OLLVM Configuration Used ==="
        echo "Level: $OLLVM_LEVEL"
        echo "Flags: $OLLVM_FLAGS"
        echo "Features: $OLLVM_DESCRIPTION"
        echo ""
        echo "=== Verification ==="
        echo "✓ 4 OLLVM objects manually compiled with OLLVM clang"
        echo "✓ Other objects compiled with container clang"
        echo "✓ Module successfully linked"

    # ==================================================
    # Upload artifact
    # ==================================================
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-${{ inputs.obfuscation_level }}
        path: /github/workspace/out/*.ko
        
    # ==================================================
    # Upload build logs
    # ==================================================
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-logs
        path: ${{ inputs.module_dir }}/build.log
