name: Build Kernel Module ddk with OLLVM

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'wuwa'
      
      obfuscation_level:
        description: 'OLLVM obfuscation level'
        required: false
        default: 'medium'
        type: choice
        options:
          - none
          - light
          - medium
          - heavy

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Debug system info
      run: |
        echo "=== System Information ==="
        echo "Container: ${{ matrix.kmi }}"
        echo "Current directory: $(pwd)"
        echo "Home directory: $HOME"
        echo "PATH: $PATH"
        
        echo ""
        echo "=== Checking existing clang installations ==="
        which clang || echo "clang not in PATH"
        find /usr -name "clang" -type f 2>/dev/null | head -10
        find /opt -name "clang" -type f 2>/dev/null | head -10
        
        echo ""
        echo "=== Checking toolchain directory ==="
        if [ -d "$KERNEL_SRC" ]; then
          echo "KERNEL_SRC exists: $KERNEL_SRC"
          find "$KERNEL_SRC" -name "clang" -type f 2>/dev/null | head -5
        fi

    - name: Install required packages
      run: |
        echo "=== Installing required packages ==="
        apt-get update
        apt-get install -y unzip file

    - name: Install OLLVM Clang
      run: |
        echo "=== Installing OLLVM Clang ==="
        
        mkdir -p /opt/ollvm-clang
        
        echo "Searching for clang.zip..."
        CLANG_ZIP=$(find . -name "clang.zip" | head -1)
        
        if [ -z "$CLANG_ZIP" ] && [ -d "${{ inputs.module_dir }}" ]; then
          echo "Searching in module directory..."
          CLANG_ZIP=$(find "${{ inputs.module_dir }}" -name "clang.zip" | head -1)
        fi
        
        if [ -f "$CLANG_ZIP" ]; then
          echo "✅ Found clang.zip: $CLANG_ZIP"
          echo "Extracting to /opt/ollvm-clang/"
          unzip -q "$CLANG_ZIP" -d /opt/ollvm-clang/
          
          CLANG_BIN=$(find /opt/ollvm-clang -name "clang" -type f | head -1)
          
          if [ -f "$CLANG_BIN" ]; then
            chmod +x "$CLANG_BIN"
            echo "✅ OLLVM clang installed at: $CLANG_BIN"
            
            echo "=== OLLVM Clang Version ==="
            if "$CLANG_BIN" --version > /tmp/ollvm_version.txt 2>&1; then
              echo "✅ OLLVM clang works!"
              cat /tmp/ollvm_version.txt
            else
              echo "❌ OLLVM clang failed to run"
              cat /tmp/ollvm_version.txt
            fi
            
            echo "CLANG_PATH=$CLANG_BIN" >> $GITHUB_ENV
          else
            echo "❌ ERROR: No clang binary found!"
            exit 1
          fi
        else
          echo "❌ ERROR: No clang.zip found!"
          exit 1
        fi
        
        echo ""
        echo "=== Comparing with system clang ==="
        SYSTEM_CLANG=$(which clang || echo "No system clang in PATH")
        echo "System clang: $SYSTEM_CLANG"

    - name: Debug build environment
      run: |
        echo "=== Build Environment Debug ==="
        echo "CLANG_PATH: $CLANG_PATH"
        
        if [ -f "$CLANG_PATH" ]; then
          echo "✅ Our OLLVM clang exists"
        else
          echo "❌ ERROR: CLANG_PATH not found!"
          exit 1
        fi
        
        echo ""
        echo "=== Module Directory ==="
        if [ -d "${{ inputs.module_dir }}" ]; then
          echo "Module directory exists: ${{ inputs.module_dir }}"
        else
          echo "❌ Module directory not found!"
          exit 1
        fi
        
        echo ""
        echo "=== Kernel Source ==="
        echo "KERNEL_SRC: $KERNEL_SRC"
        if [ ! -d "$KERNEL_SRC" ]; then
          echo "❌ KERNEL_SRC not found!"
          exit 1
        fi

    - name: Build ${{ inputs.module_dir }}.ko with OLLVM
      env:
        CLANG_PATH: ${{ env.CLANG_PATH }}
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko for KMI: ${{ matrix.kmi }} ==="
        echo "Using OLLVM clang: $CLANG_PATH"
        
        if [ ! -f "$CLANG_PATH" ]; then
          echo "❌ ERROR: CLANG_PATH does not exist!"
          exit 1
        fi
        
        case "${{ inputs.obfuscation_level }}" in
          light)
            OLLVM_FLAGS="-mllvm -fla"
            ;;
          medium)
            OLLVM_FLAGS="-mllvm -fla -mllvm -sub"
            ;;
          heavy)
            OLLVM_FLAGS="-mllvm -fla -mllvm -sub -mllvm -bcf"
            ;;
          *)
            OLLVM_FLAGS=""
            ;;
        esac
        
        echo "OLLVM flags: $OLLVM_FLAGS"
        
        echo "=== Cleaning previous build ==="
        make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} clean 2>&1 | head -20 || true
        
        echo ""
        echo "=== Starting build ==="
        echo "Build start: $(date)"
        
        # Simple test of compiler first
        echo "=== Testing compiler ==="
        echo 'int main(){return 0;}' > /tmp/simple.c
        $CLANG_PATH /tmp/simple.c -o /tmp/simple_test 2>&1 && echo "✅ Compiler test passed" || echo "⚠️ Compiler test had issues"
        
        echo ""
        echo "=== Building module ==="
        
        # Build with tracing
        PS4='+[${LINENO}]: '
        set -x
        make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} modules \
          CC="$CLANG_PATH" \
          LD=ld.lld \
          AR=llvm-ar \
          NM=llvm-nm \
          OBJCOPY=llvm-objcopy \
          STRIP=llvm-strip \
          EXTRA_CFLAGS="$OLLVM_FLAGS" \
          KCFLAGS="-flto=thin" \
          V=1 \
          2>&1 | tee /tmp/build.log
        set +x
        
        BUILD_RESULT=${PIPESTATUS[0]}
        
        echo "Build end: $(date)"
        
        echo ""
        echo "=== BUILD ANALYSIS ==="
        
        echo "1. Checking which clang was used..."
        if grep -q "$CLANG_PATH" /tmp/build.log; then
          echo "✅ Our OLLVM clang was used!"
          grep "$CLANG_PATH" /tmp/build.log | head -2
        else
          echo "⚠️ Our clang path not found in logs"
          echo "Found these clang references:"
          grep -i "clang" /tmp/build.log | head -5 || echo "No clang found"
        fi
        
        echo ""
        echo "2. Checking for OLLVM flags..."
        if [ -n "$OLLVM_FLAGS" ]; then
          if grep -q "mllvm" /tmp/build.log; then
            echo "✅ OLLVM flags found in build"
            grep -i "mllvm" /tmp/build.log | head -3
          else
            echo "⚠️ OLLVM flags not found in build log"
          fi
        fi
        
        echo ""
        echo "3. Checking build result..."
        if [ $BUILD_RESULT -eq 0 ]; then
          echo "✅ Build successful"
        else
          echo "❌ Build failed with code: $BUILD_RESULT"
          echo "Last 50 lines of build log:"
          tail -50 /tmp/build.log
        fi
        
        echo ""
        echo "=== Looking for output ==="
        
        mkdir -p /github/workspace/out
        KO_FILE=$(find "${{ inputs.module_dir }}" -name "*.ko" -type f | head -1)
        
        if [ -n "$KO_FILE" ] && [ -f "$KO_FILE" ]; then
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-ollvm-${{ inputs.obfuscation_level }}-$TIMESTAMP.ko"
          
          cp "$KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
          echo "✅ Module built: $OUTPUT_NAME"
          echo "Size: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"
          
          # Save build log
          cp /tmp/build.log "/github/workspace/out/$OUTPUT_NAME.log"
        else
          echo "❌ No .ko file found!"
          exit 1
        fi

    - name: Upload ${{ inputs.module_dir }}.ko artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-${{ inputs.obfuscation_level }}-${{ github.run_id }}
        path: /github/workspace/out/${{ inputs.module_dir }}-${{ matrix.kmi }}-ollvm-*.ko

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-logs
        path: |
          /tmp/build.log
          /tmp/ollvm_version.txt
          /github/workspace/out/*.log
