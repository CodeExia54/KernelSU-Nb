name: Build Obfuscated Kernel Module with DeClang

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'exianb-dev'

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Download and setup DeClang
      run: |
        echo "=== Downloading and Installing DeClang ==="
        apt-get update && apt-get install -y unzip 2>/dev/null || true
        
        # Download the pre-built DeClang compiler
        wget -q https://github.com/DeNA/DeClang/releases/download/swift5.10-v1.0.0/Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        
        # Extract (creates Release-Linux-swift5.10-v1.0.0-ubuntu2204/ directory)
        unzip -q Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        
        # Make clang executable and copy to /opt/declang
        chmod +x Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang
        mkdir -p /opt/declang
        cp -r Release-Linux-swift5.10-v1.0.0-ubuntu2204/* /opt/declang/
        
        echo "✅ DeClang installed to /opt/declang"

    - name: Configure DeClang for Obfuscation
      run: |
        echo "=== Configuring DeClang Obfuscation ==="
        
        # Create essential directories
        mkdir -p ~/.DeClang /opt/declang/.DeClang
        
        # Create the main configuration file - FIXED SYNTAX
        # flatten is now an ARRAY containing objects
        cat > ~/.DeClang/config.pre.json << 'EOF'
{
  "build_seed": "ddk_kernel_$(date +%s)",
  "overall_obfuscation": 50,
  "flatten": [
    {
      "name": ".*",
      "seed": "deadbeefcafebabe",
      "split_level": 1,
      "enable_obfuscation": 1
    }
  ]
}
EOF
        
        # Generate the final config.json
        if [ -f "/opt/declang/gen_config.sh" ]; then
            echo "Generating DeClang configuration..."
            /opt/declang/gen_config.sh -path /opt/declang -seed "ddk_kernel_$(date +%s)"
        else
            echo "Using direct configuration (gen_config.sh not found)"
            cp ~/.DeClang/config.pre.json ~/.DeClang/config.json
        fi
        
        # Create log file to prevent "Open logFile Failed" warning
        touch /opt/declang/.DeClang/log.txt
        
        echo "✅ DeClang configuration created"
        echo "Config location: ~/.DeClang/config.json"

    - name: Build ${{ inputs.module_dir }}.ko with Obfuscation
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko for KMI: ${{ matrix.kmi }} ==="
        echo "Using DeClang with obfuscation enabled"
        
        # Set DeClang as the compiler
        export CC="/opt/declang/compiler/bin/clang"
        export DECLANG_HOME="/opt/declang"
        
        # CRITICAL: Enable optimization to trigger LLVM obfuscation passes
        # DeClang documentation states obfuscation won't work without optimization
        export CFLAGS="-O2"
        export KCFLAGS="-O2"
        
        echo "Compiler: $CC"
        echo "DECLANG_HOME: $DECLANG_HOME"
        echo "CFLAGS: $CFLAGS"
        
        # Build the kernel module
        make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} modules
        
        echo "=== Build completed ==="
        
        # Create output directory
        mkdir -p /github/workspace/out
        
        # Find the .ko file
        KO_FILE=$(find "${{ inputs.module_dir }}" -name "*.ko" -type f | head -1)
        
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-obfuscated-$TIMESTAMP.ko"
        
        if [ -n "$KO_FILE" ] && [ -f "$KO_FILE" ]; then
            cp "$KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
            echo "✅ SUCCESS: Copied $KO_FILE -> /github/workspace/out/$OUTPUT_NAME"
            
            # Obfuscation verification
            echo ""
            echo "=== Obfuscation Verification ==="
            ORIG_SIZE=$(stat -c%s "$KO_FILE")
            echo "1. Module size: $ORIG_SIZE bytes"
            
            echo ""
            echo "2. String analysis (should show few readable strings):"
            strings "$KO_FILE" | grep -i "gpl\|license\|author\|description" | head -5 || echo "   ✅ Good: No clear strings found"
            
            echo ""
            echo "3. Simple complexity check:"
            STRING_COUNT=$(strings "$KO_FILE" | wc -l)
            echo "   Total readable strings: $STRING_COUNT"
            
            # Strip debug symbols
            llvm-strip -d "/github/workspace/out/$OUTPUT_NAME"
            STRIPPED_SIZE=$(stat -c%s "/github/workspace/out/$OUTPUT_NAME")
            echo ""
            echo "4. Size after stripping debug symbols: $STRIPPED_SIZE bytes"
            
        else
            echo "❌ ERROR: No .ko file found in ${{ inputs.module_dir }}/!"
            echo "Available files:"
            ls -la "${{ inputs.module_dir }}/" || echo "Directory doesn't exist"
            exit 1
        fi

    - name: Upload Obfuscated Module Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-obfuscated-${{ github.run_id }}
        path: /github/workspace/out/${{ inputs.module_dir }}-${{ matrix.kmi }}-obfuscated-*.ko
