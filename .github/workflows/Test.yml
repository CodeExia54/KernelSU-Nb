name: Build Kernel Module with DeClang OLLVM

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'wuwa'
      obfuscation_level:
        description: 'OLLVM obfuscation level'
        required: false
        default: 'medium'
        type: choice
        options:
        - none
        - light
        - medium
        - heavy

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: üèóÔ∏è Step 1: Environment Check
      run: |
        echo "=== STEP 1: Environment Verification ==="
        echo "Container: ${{ matrix.kmi }}"
        echo "Module: ${{ inputs.module_dir }}"
        echo "Obfuscation: ${{ inputs.obfuscation_level }}"
        echo "Architecture: $(uname -m)"
        echo ""
        echo "=== DDK Default Toolchain ==="
        DDK_CLANG=$(which clang)
        echo "DDK clang path: $DDK_CLANG"
        clang --version 2>/dev/null | head -3 || echo "No clang found"
        echo ""
        echo "=== Kernel Source ==="
        echo "KERNEL_SRC: $KERNEL_SRC"
        [ -d "$KERNEL_SRC" ] && echo "‚úÖ Kernel source exists" || echo "‚ùå Kernel source missing"

    - name: üì• Step 2: Download DeClang
      if: ${{ inputs.obfuscation_level != 'none' }}
      run: |
        echo "=== STEP 2: Downloading DeClang ==="
        
        # Clean any previous downloads
        rm -rf Release-Linux-swift5.10-v1.0.0-ubuntu2204*
        
        # Download
        echo "Downloading DeClang Swift release..."
        wget -q https://github.com/DeNA/DeClang/releases/download/swift5.10-v1.0.0/Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        echo "‚úÖ Download complete"
        
        # Extract
        echo "Extracting..."
        unzip -q Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        echo "‚úÖ Extraction complete"
        
        # Verify structure
        echo ""
        echo "=== DeClang Structure ==="
        find Release-Linux-swift5.10-v1.0.0-ubuntu2204 -type f -name "clang*" | head -5
        
        # Set paths
        DECLANG_CLANG="$(pwd)/Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang"
        DECLANG_CXX="$(pwd)/Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang++"
        
        echo ""
        echo "=== Path Verification ==="
        echo "DeClang clang: $DECLANG_CLANG"
        echo "DeClang clang++: $DECLANG_CXX"
        
        if [ ! -f "$DECLANG_CLANG" ]; then
          echo "‚ùå ERROR: DeClang clang not found at expected path!"
          echo "Available files:"
          find Release-Linux-swift5.10-v1.0.0-ubuntu2204 -type f | head -20
          exit 1
        fi
        
        chmod +x "$DECLANG_CLANG"
        echo "‚úÖ DeClang clang exists and is executable"
        
        # Save paths
        echo "DECLANG_CLANG=$DECLANG_CLANG" >> $GITHUB_ENV
        echo "DECLANG_CXX=$DECLANG_CXX" >> $GITHUB_ENV

    - name: üîç Step 3: Verify DeClang Binary
      if: ${{ inputs.obfuscation_level != 'none' }}
      env:
        DECLANG_CLANG: ${{ env.DECLANG_CLANG }}
      run: |
        echo "=== STEP 3: DeClang Binary Verification ==="
        
        echo "1. File type:"
        file "$DECLANG_CLANG"
        
        echo ""
        echo "2. Version info:"
        "$DECLANG_CLANG" --version | head -5
        
        echo ""
        echo "3. Architecture compatibility:"
        BINARY_ARCH=$(file "$DECLANG_CLANG" | grep -o "x86-64\|ARM\|aarch64" || echo "unknown")
        HOST_ARCH=$(uname -m)
        echo "   Binary: $BINARY_ARCH"
        echo "   Host: $HOST_ARCH"
        
        if [[ "$BINARY_ARCH" == *"x86-64"* ]] && [[ "$HOST_ARCH" == *"x86_64"* ]]; then
          echo "   ‚úÖ Architecture compatible (x86_64)"
        elif [[ "$BINARY_ARCH" == *"ARM"* ]] && [[ "$HOST_ARCH" == *"arm"* || "$HOST_ARCH" == *"aarch64"* ]]; then
          echo "   ‚úÖ Architecture compatible (ARM)"
        else
          echo "   ‚ö†Ô∏è  Architecture mismatch - binary may not run"
        fi
        
        echo ""
        echo "4. Basic compilation test:"
        echo 'int main(){return 42;}' | "$DECLANG_CLANG" -x c -o /tmp/test_basic - && \
          echo "   ‚úÖ Basic compilation works" || echo "   ‚ùå Basic compilation failed"

    - name: ‚öôÔ∏è Step 4: OLLVM Support Check
      if: ${{ inputs.obfuscation_level != 'none' }}
      env:
        DECLANG_CLANG: ${{ env.DECLANG_CLANG }}
      run: |
        echo "=== STEP 4: OLLVM Support Verification ==="
        
        echo "1. Checking -mllvm flag support:"
        if "$DECLANG_CLANG" --help 2>&1 | grep -q "mllvm"; then
          echo "   ‚úÖ -mllvm flag supported"
        else
          echo "   ‚ùå -mllvm flag NOT supported - OLLVM may not be built in"
        fi
        
        echo ""
        echo "2. Testing individual OLLVM flags:"
        
        # Test each flag
        for FLAG in "-fla" "-sub" "-bcf" "-split"; do
          echo -n "   Testing -mllvm $FLAG: "
          if echo 'int main(){return 0;}' | "$DECLANG_CLANG" -x c -o /dev/null -mllvm $FLAG 2>/dev/null; then
            echo "‚úÖ Supported"
          else
            echo "‚ùå Not supported"
          fi
        done
        
        echo ""
        echo "3. Setting OLLVM flags based on selected level:"
        
        case "${{ inputs.obfuscation_level }}" in
          "light")
            OLLVM_FLAGS="-mllvm -fla"
            ;;
          "medium")
            OLLVM_FLAGS="-mllvm -fla -mllvm -sub"
            ;;
          "heavy")
            OLLVM_FLAGS="-mllvm -fla -mllvm -sub -mllvm -bcf -mllvm -split"
            ;;
          *)
            OLLVM_FLAGS="-mllvm -fla -mllvm -sub"
            ;;
        esac
        
        echo "   Selected flags: $OLLVM_FLAGS"
        
        echo ""
        echo "4. Testing complete OLLVM flag set:"
        if echo 'int main(){return 0;}' | "$DECLANG_CLANG" -x c -o /dev/null $OLLVM_FLAGS 2>/dev/null; then
          echo "   ‚úÖ All OLLVM flags work together"
        else
          echo "   ‚ùå OLLVM flag combination failed"
        fi
        
        # Save for build step
        echo "OLLVM_FLAGS=$OLLVM_FLAGS" >> $GITHUB_ENV

    - name: üõ°Ô∏è Step 5: Kernel Compatibility Check
      if: ${{ inputs.obfuscation_level != 'none' }}
      env:
        DECLANG_CLANG: ${{ env.DECLANG_CLANG }}
        OLLVM_FLAGS: ${{ env.OLLVM_FLAGS }}
      run: |
        echo "=== STEP 5: Kernel Module Compatibility ==="
        
        echo "1. Testing kernel compilation flags:"
        
        # Create minimal kernel test
        cat > /tmp/kernel_test.c << 'EOF'
        int kernel_func(int x) {
            return x * 2;
        }
        EOF
        
        # Test without OLLVM
        echo "   Without OLLVM:"
        if "$DECLANG_CLANG" -c /tmp/kernel_test.c -o /tmp/kernel_normal.o \
          -fno-stack-protector -fno-PIC 2>/dev/null; then
          echo "     ‚úÖ Kernel flags work"
        else
          echo "     ‚ùå Kernel flags failed"
        fi
        
        # Test with OLLVM
        echo "   With OLLVM:"
        if "$DECLANG_CLANG" -c /tmp/kernel_test.c -o /tmp/kernel_ollvm.o \
          -fno-stack-protector -fno-PIC $OLLVM_FLAGS 2>/dev/null; then
          echo "     ‚úÖ Kernel flags + OLLVM work"
        else
          echo "     ‚ùå Kernel flags + OLLVM failed"
        fi
        
        echo ""
        echo "2. Comparing output (should show OLLVM effect):"
        "$DECLANG_CLANG" -S /tmp/kernel_test.c -o /tmp/kernel_normal.s -fno-stack-protector 2>/dev/null
        "$DECLANG_CLANG" -S /tmp/kernel_test.c -o /tmp/kernel_ollvm.s -fno-stack-protector $OLLVM_FLAGS 2>/dev/null
        
        NORMAL_SIZE=$(wc -l < /tmp/kernel_normal.s 2>/dev/null || echo 0)
        OLLVM_SIZE=$(wc -l < /tmp/kernel_ollvm.s 2>/dev/null || echo 0)
        
        echo "   Normal assembly: $NORMAL_SIZE lines"
        echo "   OLLVM assembly: $OLLVM_SIZE lines"
        
        if [ $OLLVM_SIZE -gt $NORMAL_SIZE ]; then
          DIFF=$((OLLVM_SIZE - NORMAL_SIZE))
          echo "   ‚úÖ OLLVM adds $DIFF lines (obfuscation working)"
        else
          echo "   ‚ö†Ô∏è  No size increase - check OLLVM configuration"
        fi

    - name: üî® Step 6: Build Module with OLLVM
      env:
        DECLANG_CLANG: ${{ env.DECLANG_CLANG }}
        OLLVM_FLAGS: ${{ env.OLLVM_FLAGS }}
      run: |
        echo "=== STEP 6: Building ${{ inputs.module_dir }}.ko ==="
        
        # Select compiler
        if ${{ inputs.obfuscation_level != 'none' }} && [ -n "$DECLANG_CLANG" ]; then
          CC="$DECLANG_CLANG"
          echo "Using: DeClang with ${{ inputs.obfuscation_level }} obfuscation"
          echo "Flags: $OLLVM_FLAGS"
        else
          CC="clang"
          OLLVM_FLAGS=""
          echo "Using: DDK default clang (no obfuscation)"
        fi
        
        echo "Compiler path: $CC"
        echo "Compiler version:"
        "$CC" --version | head -1
        
        echo ""
        echo "=== Build Command ==="
        echo "make -C \$KERNEL_SRC M=\$PWD/${{ inputs.module_dir }} \\"
        echo "  CC=\"$CC\" \\"
        echo "  EXTRA_CFLAGS=\"$OLLVM_FLAGS\""
        
        echo ""
        echo "Starting build..."
        
        # Clean first
        make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} clean 2>/dev/null || true
        
        # Build with selected compiler
        make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} modules \
          CC="$CC" \
          EXTRA_CFLAGS="$OLLVM_FLAGS"
        
        echo ""
        echo "=== Build Result ==="
        
        # Find the .ko file
        KO_FILE=$(find "${{ inputs.module_dir }}" -name "*.ko" -type f | head -1)
        if [ -z "$KO_FILE" ] || [ ! -f "$KO_FILE" ]; then
          echo "‚ùå BUILD FAILED: No .ko file found!"
          echo "Checking directory:"
          ls -la "${{ inputs.module_dir }}/" 2>/dev/null || echo "Directory not found"
          exit 1
        fi
        
        echo "‚úÖ BUILD SUCCESS: $KO_FILE"
        echo "   Size: $(du -h "$KO_FILE" | cut -f1)"
        echo "   Date: $(stat -c %y "$KO_FILE" 2>/dev/null || echo "N/A")"
        
        # Save for next steps
        echo "BUILT_KO_FILE=$KO_FILE" >> $GITHUB_ENV

    - name: üìä Step 7: Obfuscation Analysis
      if: ${{ inputs.obfuscation_level != 'none' }}
      env:
        BUILT_KO_FILE: ${{ env.BUILT_KO_FILE }}
        OLLVM_FLAGS: ${{ env.OLLVM_FLAGS }}
      run: |
        echo "=== STEP 7: Obfuscation Analysis ==="
        
        if [ -z "$BUILT_KO_FILE" ] || [ ! -f "$BUILT_KO_FILE" ]; then
          echo "‚ùå No .ko file for analysis"
          exit 1
        fi
        
        echo "Analyzing: $BUILT_KO_FILE"
        echo "OLLVM flags used: $OLLVM_FLAGS"
        
        echo ""
        echo "=== Quick Analysis ==="
        
        # 1. Basic file info
        echo "1. File Information:"
        FILE_SIZE=$(stat -c%s "$BUILT_KO_FILE")
        echo "   Size: $FILE_SIZE bytes"
        
        # 2. Jump instruction count (Control Flow Flattening indicator)
        echo "2. Control Flow Analysis:"
        JUMP_COUNT=$(objdump -d "$BUILT_KO_FILE" 2>/dev/null | grep -c "jmp\|je\|jne\|jg\|jl\|ja\|jb" || echo 0)
        echo "   Jump instructions: $JUMP_COUNT"
        
        if [ $JUMP_COUNT -gt 50 ]; then
          echo "   ‚úÖ High jump count (good for obfuscation)"
        elif [ $JUMP_COUNT -gt 20 ]; then
          echo "   ‚ö†Ô∏è  Moderate jump count"
        else
          echo "   ‚ùå Low jump count - FLA may not be working"
        fi
        
        # 3. String obfuscation check
        echo "3. String Analysis:"
        STRING_COUNT=$(strings "$BUILT_KO_FILE" | wc -l)
        echo "   Visible strings: $STRING_COUNT"
        
        if [ $STRING_COUNT -lt 100 ]; then
          echo "   ‚úÖ Low string count (good for obfuscation)"
        else
          echo "   ‚ö†Ô∏è  High string count - consider adding more obfuscation"
        fi
        
        # 4. OLLVM pattern detection
        echo "4. OLLVM Pattern Detection:"
        
        # Look for indirect jumps (common in FLA)
        INDIRECT_JUMPS=$(objdump -d "$BUILT_KO_FILE" 2>/dev/null | grep -c "jmp.*\*" || echo 0)
        echo "   Indirect jumps: $INDIRECT_JUMPS"
        
        # Look for switch patterns
        SWITCH_PATTERNS=$(objdump -d "$BUILT_KO_FILE" 2>/dev/null | grep -c "switch\|case" || echo 0)
        echo "   Switch/case patterns: $SWITCH_PATTERNS"
        
        echo ""
        echo "=== Obfuscation Summary ==="
        if [[ "$OLLVM_FLAGS" == *"-fla"* ]] && [ $JUMP_COUNT -gt 30 ]; then
          echo "‚úÖ CONTROL FLOW FLATTENING: WORKING"
        elif [[ "$OLLVM_FLAGS" == *"-fla"* ]]; then
          echo "‚ö†Ô∏è  CONTROL FLOW FLATTENING: WEAK OR NOT WORKING"
        fi
        
        if [[ "$OLLVM_FLAGS" == *"-sub"* ]] && [ $STRING_COUNT -lt 150 ]; then
          echo "‚úÖ INSTRUCTION SUBSTITUTION: WORKING"
        elif [[ "$OLLVM_FLAGS" == *"-sub"* ]]; then
          echo "‚ö†Ô∏è  INSTRUCTION SUBSTITUTION: MAY BE WORKING"
        fi
        
        if [[ "$OLLVM_FLAGS" == *"-bcf"* ]] && [ $INDIRECT_JUMPS -gt 0 ]; then
          echo "‚úÖ BOGUS CONTROL FLOW: WORKING"
        elif [[ "$OLLVM_FLAGS" == *"-bcf"* ]]; then
          echo "‚ö†Ô∏è  BOGUS CONTROL FLOW: MAY NOT BE WORKING"
        fi

    - name: üì¶ Step 8: Create Artifact
      env:
        BUILT_KO_FILE: ${{ env.BUILT_KO_FILE }}
      run: |
        echo "=== STEP 8: Creating Artifact ==="
        
        if [ -z "$BUILT_KO_FILE" ] || [ ! -f "$BUILT_KO_FILE" ]; then
          echo "‚ùå No .ko file to package"
          exit 1
        fi
        
        # Create output directory
        mkdir -p /github/workspace/out
        
        # Generate artifact name
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        if ${{ inputs.obfuscation_level != 'none' }}; then
          OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-ollvm-${{ inputs.obfuscation_level }}-$TIMESTAMP.ko"
        else
          OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-normal-$TIMESTAMP.ko"
        fi
        
        # Copy file
        cp "$BUILT_KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
        
        echo "Artifact: $OUTPUT_NAME"
        echo "Original: $BUILT_KO_FILE"
        echo "Size: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"
        
        # Optional strip
        if command -v llvm-strip >/dev/null 2>&1; then
          llvm-strip -d "/github/workspace/out/$OUTPUT_NAME" 2>/dev/null && \
            echo "Stripped debug symbols" || echo "Strip failed or not needed"
        fi
        
        echo "ARTIFACT_PATH=/github/workspace/out/$OUTPUT_NAME" >> $GITHUB_ENV

    - name: ‚¨ÜÔ∏è Step 9: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-${{ inputs.obfuscation_level }}-${{ github.run_number }}
        path: ${{ env.ARTIFACT_PATH }}
        retention-days: 7

    - name: ‚úÖ Step 10: Final Report
      if: always()
      run: |
        echo "=== BUILD COMPLETE ==="
        echo "Module: ${{ inputs.module_dir }}"
        echo "Kernel: ${{ matrix.kmi }}"
        echo "Obfuscation: ${{ inputs.obfuscation_level }}"
        echo "Status: ${{ job.status }}"
        echo ""
        
        if ${{ inputs.obfuscation_level != 'none' }}; then
          echo "=== OLLVM STATUS ==="
          echo "DeClang: $([ -n \"${{ env.DECLANG_CLANG }}\" ] && echo \"Loaded\" || echo \"Not used\")"
          echo "Flags: ${{ env.OLLVM_FLAGS || 'None' }}"
          echo ""
          echo "Next steps:"
          echo "1. Download artifact from above"
          echo "2. Test module on target device"
          echo "3. Verify reverse engineering difficulty increased"
        else
          echo "Build completed without obfuscation"
        fi
