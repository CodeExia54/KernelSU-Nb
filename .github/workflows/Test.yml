name: Build Kernel Module with DeClang

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'exianb-dev'

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Setup DeClang
      run: |
        apt-get update && apt-get install -y wget unzip
        wget -q https://github.com/DeNA/DeClang/releases/download/swift5.10-v1.0.0/Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        unzip -q Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        chmod +x Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/*

    - name: Build with DeClang
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko for KMI: ${{ matrix.kmi }} ==="
        
        DECLANG_CLANG="$PWD/Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang"
        DECLANG_CLANGPP="$PWD/Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang++"
        
        # Create simple wrapper that fixes all issues
        mkdir -p /tmp/declang-fixed
        
        # Create clang wrapper
        echo '#!/bin/bash' > /tmp/declang-fixed/clang
        echo 'args=()' >> /tmp/declang-fixed/clang
        echo 'for a in "$@"; do' >> /tmp/declang-fixed/clang
        echo '    case "$a" in' >> /tmp/declang-fixed/clang
        echo '        *enable-trivial-auto-var-init*) continue ;;' >> /tmp/declang-fixed/clang
        echo '        *debug-compression*) continue ;;' >> /tmp/declang-fixed/clang
        echo '        -gz*) continue ;;' >> /tmp/declang-fixed/clang
        echo '        *) args+=("$a") ;;' >> /tmp/declang-fixed/clang
        echo '    esac' >> /tmp/declang-fixed/clang
        echo 'done' >> /tmp/declang-fixed/clang
        echo 'args+=("-O2")' >> /tmp/declang-fixed/clang
        echo "exec \"$DECLANG_CLANG\" \"\${args[@]}\"" >> /tmp/declang-fixed/clang
        chmod +x /tmp/declang-fixed/clang
        
        # Create clang++ wrapper
        echo '#!/bin/bash' > /tmp/declang-fixed/clang++
        echo 'args=()' >> /tmp/declang-fixed/clang++
        echo 'for a in "$@"; do' >> /tmp/declang-fixed/clang++
        echo '    case "$a" in' >> /tmp/declang-fixed/clang++
        echo '        *enable-trivial-auto-var-init*) continue ;;' >> /tmp/declang-fixed/clang++
        echo '        *debug-compression*) continue ;;' >> /tmp/declang-fixed/clang++
        echo '        -gz*) continue ;;' >> /tmp/declang-fixed/clang++
        echo '        *) args+=("$a") ;;' >> /tmp/declang-fixed/clang++
        echo '    esac' >> /tmp/declang-fixed/clang++
        echo 'done' >> /tmp/declang-fixed/clang++
        echo 'args+=("-O2")' >> /tmp/declang-fixed/clang++
        echo "exec \"$DECLANG_CLANGPP\" \"\${args[@]}\"" >> /tmp/declang-fixed/clang++
        chmod +x /tmp/declang-fixed/clang++
        
        # Build
        make -C $KERNEL_SRC \
            M=$PWD/${{ inputs.module_dir }} \
            CC="/tmp/declang-fixed/clang" \
            CXX="/tmp/declang-fixed/clang++" \
            LD="/tmp/declang-fixed/clang" \
            modules
        
        echo "=== Build completed ==="

        # Output handling
        mkdir -p /github/workspace/out
        KO_FILE=$(find "${{ inputs.module_dir }}" -name "*.ko" -type f | head -1)
        
        if [ -n "$KO_FILE" ] && [ -f "$KO_FILE" ]; then
            TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
            OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-$TIMESTAMP.ko"
            cp "$KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
            echo "✅ Build successful: $OUTPUT_NAME"
            
            # Strip if possible
            if command -v llvm-strip >/dev/null 2>&1; then
                llvm-strip -d "/github/workspace/out/$OUTPUT_NAME" 2>/dev/null || true
            fi
        else
            echo "❌ ERROR: No .ko file found!"
            exit 1
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-${{ github.run_id }}
        path: /github/workspace/out/${{ inputs.module_dir }}-${{ matrix.kmi }}-*.ko
