name: Build Kernel Module ddk

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'exianb-dev'

jobs:
  compatibility-check:
    name: Check DeClang compatibility
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android14-5.15  # Test with one version first

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    outputs:
      is_compatible: ${{ steps.check.outputs.is_compatible }}
      missing_deps: ${{ steps.check.outputs.missing_deps }}

    steps:
    - name: Check DeClang compatibility with DDK
      id: check
      run: |
        echo "=== Checking DeClang compatibility with DDK ${{ matrix.kmi }} ==="
        
        # Create a temporary directory for testing
        TEST_DIR=/tmp/declang_test
        mkdir -p $TEST_DIR
        cd $TEST_DIR
        
        # Download DeClang
        echo "Downloading DeClang..."
        wget -q https://github.com/DeNA/DeClang/releases/download/swift5.10-v1.0.0/Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        unzip -q Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        
        # Check 1: Binary is executable
        if [ ! -x Release/bin/clang ]; then
            echo "ERROR: DeClang binary is not executable"
            echo "is_compatible=false" >> $GITHUB_OUTPUT
            echo "missing_deps=binary_not_executable" >> $GITHUB_OUTPUT
            exit 0
        fi
        
        # Check 2: Library dependencies
        echo "Checking library dependencies..."
        MISSING_LIBS=$(ldd Release/bin/clang 2>/dev/null | grep "not found" || true)
        if [ -n "$MISSING_LIBS" ]; then
            echo "WARNING: Missing libraries:"
            echo "$MISSING_LIBS"
            echo "missing_deps=$MISSING_LIBS" >> $GITHUB_OUTPUT
        else
            echo "missing_deps=none" >> $GITHUB_OUTPUT
        fi
        
        # Check 3: Basic compilation test
        echo "Testing basic compilation..."
        cat > test_basic.c << 'EOF'
        int main() { return 0; }
        EOF
        
        if ! Release/bin/clang test_basic.c -o test_basic 2>/dev/null; then
            echo "ERROR: Basic compilation failed"
            echo "is_compatible=false" >> $GITHUB_OUTPUT
            exit 0
        fi
        
        # Check 4: Kernel header test
        echo "Testing kernel header compatibility..."
        cat > test_kernel.c << 'EOF'
        #include <linux/module.h>
        EOF
        
        if ! Release/bin/clang -c test_kernel.c -I$KERNEL_SRC/include -o /dev/null 2>&1; then
            echo "ERROR: Cannot compile kernel headers"
            echo "is_compatible=false" >> $GITHUB_OUTPUT
            exit 0
        fi
        
        # Check 5: Test kernel module build
        echo "Testing kernel module build..."
        mkdir -p test_module
        cd test_module
        
        cat > test_module.c << 'EOF'
        #include <linux/module.h>
        MODULE_LICENSE("GPL");
        static int __init test_init(void) { return 0; }
        static void __exit test_exit(void) { }
        module_init(test_init);
        module_exit(test_exit);
        EOF
        
        cat > Makefile << 'EOF'
        obj-m += test_module.o
        EOF
        
        export CC=$TEST_DIR/Release/bin/clang
        export DECLANG_HOME=$TEST_DIR/Release
        
        if make -C $KERNEL_SRC M=$(pwd) modules 2>&1 | grep -q "Error\|error"; then
            echo "ERROR: Kernel module build failed"
            echo "is_compatible=false" >> $GITHUB_OUTPUT
        else
            if [ -f "test_module.ko" ]; then
                echo "SUCCESS: DeClang can build kernel modules!"
                echo "Module type: $(file test_module.ko)"
                echo "is_compatible=true" >> $GITHUB_OUTPUT
            else
                echo "ERROR: No .ko file generated"
                echo "is_compatible=false" >> $GITHUB_OUTPUT
            fi
        fi

  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    needs: compatibility-check
    if: ${{ needs.compatibility-check.outputs.is_compatible == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Check compatibility result
      run: |
        echo "=== Compatibility Check Results ==="
        echo "DeClang compatible: ${{ needs.compatibility-check.outputs.is_compatible }}"
        echo "Missing dependencies: ${{ needs.compatibility-check.outputs.missing_deps }}"
        echo ""
        echo "Proceeding with DeClang obfuscated build..."

    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Setup DeClang
      run: |
        echo "=== Setting up DeClang ==="
        
        # Download DeClang
        wget -q https://github.com/DeNA/DeClang/releases/download/swift5.10-v1.0.0/Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        unzip -q Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        
        # Install to /opt/declang
        mv Release /opt/declang
        
        # Create DeClang configuration
        mkdir -p ~/.DeClang
        cat > ~/.DeClang/config.pre.json << 'EOF'
        {
          "build_seed": "ddk_$(date +%s)",
          "overall_obfuscation": 50,
          "flatten": {
            "name": ".*",
            "seed": "a1b2c3d4e5f67890",
            "split_level": 1,
            "enable_obfuscation": 1
          }
        }
        EOF
        
        # Generate config if script exists
        if [ -f /opt/declang/gen_config.sh ]; then
            /opt/declang/gen_config.sh -path /opt/declang -seed "ddk_$(date +%s)"
        fi
        
        echo "DeClang setup complete"
        echo "Compiler: /opt/declang/bin/clang"

    - name: Build ${{ inputs.module_dir }}.ko with DeClang
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko for KMI: ${{ matrix.kmi }} ==="
        echo "Using DeClang with obfuscation"
        
        # Set DeClang as compiler
        export CC="/opt/declang/bin/clang"
        export CXX="/opt/declang/bin/clang++"
        export DECLANG_HOME=/opt/declang
        
        # Build the module with DeClang obfuscation
        make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} modules
        
        echo "=== DeClang build completed ==="

        # Create output directory
        mkdir -p /github/workspace/out
        
        # Find the first .ko file in the module directory
        KO_FILE=$(find "${{ inputs.module_dir }}" -name "*.ko" -type f | head -1)
        
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-declang-$TIMESTAMP.ko"
        if [ -n "$KO_FILE" ] && [ -f "$KO_FILE" ]; then
            cp "$KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
            echo "Copied: $KO_FILE -> /github/workspace/out/$OUTPUT_NAME"
            echo "Size: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"
            
            # Verify it's ARM64
            echo "Module architecture:"
            file "/github/workspace/out/$OUTPUT_NAME"
            
            # Check for obfuscation indicators
            echo ""
            echo "Obfuscation check (should show few readable strings):"
            strings "/github/workspace/out/$OUTPUT_NAME" | head -5 || echo "Strings might be encrypted"
            
            llvm-strip -d "/github/workspace/out/$OUTPUT_NAME"
            echo "Size after stripping: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"
        else
            echo "ERROR: No .ko file found in ${{ inputs.module_dir }}/!"
            echo "Available files in ${{ inputs.module_dir }}/:"
            ls -la "${{ inputs.module_dir }}/" || echo "Directory doesn't exist"
            exit 1
        fi

    - name: Upload ${{ inputs.module_dir }}.ko artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-declang-${{ github.run_id }}
        path: /github/workspace/out/${{ inputs.module_dir }}-${{ matrix.kmi }}-declang-*.ko

  fallback-build:
    name: Fallback build (if DeClang incompatible)
    needs: compatibility-check
    if: ${{ needs.compatibility-check.outputs.is_compatible == 'false' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Check compatibility failure
      run: |
        echo "=== DeClang Compatibility Check Failed ==="
        echo "Reason: ${{ needs.compatibility-check.outputs.missing_deps }}"
        echo "Falling back to original compiler (no obfuscation)"
        echo "Proceeding with standard build..."

    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Build ${{ inputs.module_dir }}.ko (original)
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko for KMI: ${{ matrix.kmi }} ==="
        echo "Using original compiler (no obfuscation)"

        # Build the module with original compiler
        make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} modules
        
        echo "=== Build completed ==="

        # Create output directory
        mkdir -p /github/workspace/out
        
        # Find the first .ko file in the module directory
        KO_FILE=$(find "${{ inputs.module_dir }}" -name "*.ko" -type f | head -1)
        
        TIMESTAMP=$(date +'%Ym%d-%H%M%S')
        OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-original-$TIMESTAMP.ko"
        if [ -n "$KO_FILE" ] && [ -f "$KO_FILE" ]; then
            cp "$KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
            echo "Copied: $KO_FILE -> /github/workspace/out/$OUTPUT_NAME"
            echo "Size: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"
            llvm-strip -d "/github/workspace/out/$OUTPUT_NAME"
            echo "Size after stripping: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"
        else
            echo "ERROR: No .ko file found in ${{ inputs.module_dir }}/!"
            echo "Available files in ${{ inputs.module_dir }}/:"
            ls -la "${{ inputs.module_dir }}/" || echo "Directory doesn't exist"
            exit 1
        fi

    - name: Upload ${{ inputs.module_dir }}.ko artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-original-${{ github.run_id }}
        path: /github/workspace/out/${{ inputs.module_dir }}-${{ matrix.kmi }}-original-*.ko
