name: Build Kernel Module with OLLVM (CFI Safe, Forced)

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
          - exianb-dev
          - exianb
          - ovo
          - prctl-fd
          - prctl-hook
          - offset
          - hello-world
          - wuwa
          - panic
        default: 'wuwa'

      obfuscation_level:
        description: 'OLLVM obfuscation level'
        required: true
        default: 'medium'
        type: choice
        options:
          - none
          - light
          - medium

jobs:
  build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        kmi:
          - android13-5.15

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    # ------------------------------------------------------------
    # Checkout
    # ------------------------------------------------------------
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Install tools
      run: |
        apt-get update
        apt-get install -y unzip file binutils llvm

    # ------------------------------------------------------------
    # Install OLLVM toolchain
    # ------------------------------------------------------------
    - name: Install OLLVM clang (absolute path)
      run: |
        set -e
        echo "=== Installing OLLVM toolchain ==="

        rm -rf /usr/local/ollvm
        mkdir -p /usr/local/ollvm/bin

        for zip in "${{ inputs.module_dir }}"/clang*.zip; do
          [ -f "$zip" ] || continue
          echo "Extracting $zip"
          unzip -oq "$zip" -d /usr/local/ollvm
        done

        find /usr/local/ollvm -type f -executable \
          \( -name "clang*" -o -name "llvm-*" -o -name "ld.lld" \) \
          -exec mv {} /usr/local/ollvm/bin/ \; || true

        chmod -R +x /usr/local/ollvm/bin

        echo "=== OLLVM clang version ==="
        /usr/local/ollvm/bin/clang --version

    # ------------------------------------------------------------
    # HARD FAIL if this is not OLLVM
    # ------------------------------------------------------------
    - name: Verify OLLVM patches exist (FAIL FAST)
      run: |
        echo "=== Verifying OLLVM passes ==="
        /usr/local/ollvm/bin/clang -mllvm -help | grep -E "fla|sub" || {
          echo "❌ OLLVM passes NOT found — wrong clang!"
          exit 1
        }
        echo "✅ OLLVM passes detected"

    # ------------------------------------------------------------
    # Build module (FORCED compiler)
    # ------------------------------------------------------------
    - name: Build module with OLLVM (FORCED)
      run: |
        set -e

        MODULE="${{ inputs.module_dir }}"

        # ------------------------------
        # OLLVM flags (KERNEL SAFE)
        # ------------------------------
        case "${{ inputs.obfuscation_level }}" in
          light)
            OLLVM_FLAGS="-mllvm -fla"
            ;;
          medium)
            OLLVM_FLAGS="-mllvm -fla -mllvm -sub"
            ;;
          *)
            OLLVM_FLAGS=""
            ;;
        esac

        # ------------------------------
        # Android CFI REQUIRES LTO
        # ------------------------------
        KCFLAGS="$OLLVM_FLAGS -flto=thin -fno-inline-functions"

        echo "KCFLAGS=$KCFLAGS"

        make -C "$KERNEL_SRC" M="$PWD/$MODULE" clean || true

        make -C "$KERNEL_SRC" M="$PWD/$MODULE" modules \
          CC=/usr/local/ollvm/bin/clang \
          LD=/usr/local/ollvm/bin/ld.lld \
          AR=/usr/local/ollvm/bin/llvm-ar \
          NM=/usr/local/ollvm/bin/llvm-nm \
          OBJCOPY=/usr/local/ollvm/bin/llvm-objcopy \
          STRIP=/usr/local/ollvm/bin/llvm-strip \
          KCFLAGS="$KCFLAGS" \
          -j$(nproc) \
          2>&1 | tee /tmp/build.log

    # ------------------------------------------------------------
    # VERIFY compiler used (CRITICAL)
    # ------------------------------------------------------------
    - name: Verify compiler actually used
      run: |
        echo "=== Compiler verification ==="
        grep -E "You are using:" /tmp/build.log || true

        if grep -q "github.com/llvm/llvm-project" /tmp/build.log; then
          echo "❌ Upstream clang detected — build INVALID"
          exit 1
        fi

        echo "✅ Android / OLLVM clang used"

    # ------------------------------------------------------------
    # Analyze obfuscation (PROOF)
    # ------------------------------------------------------------
    - name: Analyze obfuscation
      run: |
        KO=$(find "${{ inputs.module_dir }}" -name "*.ko" | head -1)
        echo "KO=$KO"

        echo "=== Module size ==="
        size "$KO"

        echo "=== CFG sample ==="
        llvm-objdump -d "$KO" | head -80

        echo "=== Branch density ==="
        llvm-objdump -d "$KO" | grep -E "br|cmp|jmp" | head -30

        echo "KO_FILE=$KO" >> $GITHUB_ENV

    # ------------------------------------------------------------
    # Package artifact
    # ------------------------------------------------------------
    - name: Package artifact
      run: |
        TS=$(date +%Y%m%d-%H%M%S)
        OUT="out/${{ inputs.module_dir }}-${{ matrix.kmi }}-ollvm-${{ inputs.obfuscation_level }}-$TS.ko"

        mkdir -p out
        cp "$KO_FILE" "$OUT"

        llvm-strip -d "$OUT" || strip --strip-debug "$OUT" || true

        echo "ARTIFACT=$OUT" >> $GITHUB_ENV
        du -h "$OUT"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}
        path: ${{ env.ARTIFACT }}
        retention-days: 7

    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs
        path: /tmp/build.log
        retention-days: 7
