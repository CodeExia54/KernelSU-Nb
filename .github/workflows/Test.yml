name: Build Kernel Module ddk (OLLVM Levels)

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory'
        required: true
        type: choice
        options:
          - wuwa
        default: 'wuwa'

      obfuscation_level:
        description: 'OLLVM obfuscation strength'
        required: true
        type: choice
        options:
          - easy
          - medium
          - hard
        default: easy

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }} (${{ inputs.obfuscation_level }}) for ${{ matrix.kmi }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Extract OLLVM toolchain
      run: |
        set -e
        cd ${{ inputs.module_dir }}

        mkdir -p .ollvm
        unzip -q android-ollvm.zip  -d .ollvm
        unzip -q android-ollvm1.zip -d .ollvm

        .ollvm/android-ollvm/bin/clang --version
        .ollvm/android-ollvm/bin/clang -print-resource-dir

        test -f .ollvm/android-ollvm/lib/clang/*/include/stdint.h

    - name: Build module
      run: |
        echo "=== Building with OLLVM level: ${{ inputs.obfuscation_level }} ==="

        make -C $KERNEL_SRC \
          M=$PWD/${{ inputs.module_dir }} \
          OLLVM=1 \
          OLLVM_LEVEL=${{ inputs.obfuscation_level }} \
          modules

        mkdir -p /github/workspace/out

        KO_FILE=$(find "${{ inputs.module_dir }}" -name "*.ko" | head -1)
        TS=$(date +'%Y%m%d-%H%M%S')
        OUT="/github/workspace/out/${{ inputs.module_dir }}-${{ matrix.kmi }}-${{ inputs.obfuscation_level }}-$TS.ko"

        cp "$KO_FILE" "$OUT"
        llvm-strip -d "$OUT"

        echo "Built: $OUT"
        du -h "$OUT"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-${{ inputs.obfuscation_level }}
        path: /github/workspace/out/*.ko
