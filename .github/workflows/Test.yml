name: Build Kernel Module ddk (OLLVM Levels)

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory'
        required: true
        type: choice
        options:
          - wuwa
        default: 'wuwa'

      # OLLVM Configuration Options
      obfuscation_level:
        description: 'OLLVM obfuscation strength'
        required: true
        type: choice
        options:
          - easy
          - medium
          - hard
          - extreme
        default: easy

      enable_fla:
        description: 'Enable Control Flow Flattening'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'yes'

      enable_split:
        description: 'Enable Basic Block Splitting'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

      split_num:
        description: 'Splitting iterations (1-5)'
        required: true
        type: string
        default: '3'

      enable_sub:
        description: 'Enable Instruction Substitution'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

      sub_loop:
        description: 'Substitution iterations (1-5)'
        required: true
        type: string
        default: '2'

      enable_bcf:
        description: 'Enable Bogus Control Flow'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

      bcf_loop:
        description: 'BCF iterations (1-5)'
        required: true
        type: string
        default: '2'

      bcf_prob:
        description: 'BCF probability (1-100)'
        required: true
        type: string
        default: '40'

      enable_sobf:
        description: 'Enable String Obfuscation'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'no'

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }} (${{ inputs.obfuscation_level }}) for ${{ matrix.kmi }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    # ==================================================
    # Install unzip
    # ==================================================
    - name: Install required tools
      run: |
        apt-get update
        apt-get install -y unzip

    # ==================================================
    # Extract OLLVM toolchain directly
    # ==================================================
    - name: Extract OLLVM toolchain
      run: |
        set -e
        cd ${{ inputs.module_dir }}
        
        echo "=== Current directory structure ==="
        ls -la
        
        echo "=== Extracting OLLVM ZIPs ==="
        
        # Extract first ZIP directly
        echo "Extracting android-ollvm.zip..."
        unzip -q android-ollvm.zip
        
        # Extract second ZIP directly (will merge with first)
        echo "Extracting android-ollvm1.zip..."
        unzip -q -o android-ollvm1.zip
        
        echo "=== After extraction structure ==="
        ls -la android-ollvm/
        ls -la android-ollvm/bin/
        
        # Fix permissions on clang binary
        echo "=== Fixing permissions ==="
        chmod 755 android-ollvm/bin/clang
        chmod 755 android-ollvm/bin/clang++
        chmod 755 android-ollvm/bin/llvm-ar
        
        echo "OLLVM clang version:"
        ./android-ollvm/bin/clang --version || echo "Version check might fail, continuing..."

    # ==================================================
    # Build kernel module with MIXED toolchain
    # ==================================================
    - name: Build module
      run: |
        echo "=== Building with MIXED TOOLCHAIN ==="
        echo "Module directory: ${{ inputs.module_dir }}"
        echo "Kernel source: $KERNEL_SRC"
        
        # Build OLLVM flags from user inputs
        OLLVM_FLAGS=""
        
        # Control Flow Flattening
        if [ "${{ inputs.enable_fla }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -fla"
        fi
        
        # Basic Block Splitting
        if [ "${{ inputs.enable_split }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -split -mllvm -split_num=${{ inputs.split_num }}"
        fi
        
        # Instruction Substitution
        if [ "${{ inputs.enable_sub }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -sub -mllvm -sub_loop=${{ inputs.sub_loop }}"
        fi
        
        # Bogus Control Flow
        if [ "${{ inputs.enable_bcf }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -bcf -mllvm -bcf_loop=${{ inputs.bcf_loop }} -mllvm -bcf_prob=${{ inputs.bcf_prob }}"
        fi
        
        # String Obfuscation
        if [ "${{ inputs.enable_sobf }}" = "yes" ]; then
          OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -sobf"
        fi
        
        echo "Custom OLLVM Flags: $OLLVM_FLAGS"
        echo ""
        
        # Verify OLLVM clang works with these flags
        echo "=== Verifying OLLVM Clang ==="
        cd ${{ inputs.module_dir }}
        
        # Test if OLLVM clang recognizes the flags
        echo "Testing OLLVM clang with -mllvm -fla flag..."
        if ./android-ollvm/bin/clang -mllvm -fla --version 2>&1 | grep -q "Unknown command line argument"; then
          echo "❌ ERROR: OLLVM clang does NOT recognize -fla flag!"
          echo "This means it's not a real OLLVM clang!"
          echo ""
          echo "Checking what clang this really is:"
          ./android-ollvm/bin/clang --version
          exit 1
        else
          echo "✅ OLLVM clang recognizes the flag"
        fi
        
        # Get container's clang path for linking
        echo ""
        echo "=== Container Clang Info ==="
        CONTAINER_CLANG=$(which clang)
        echo "Container clang path: $CONTAINER_CLANG"
        $CONTAINER_CLANG --version | head -3
        
        # Also apply predefined level for backward compatibility
        OLLVM_LEVEL="${{ inputs.obfuscation_level }}"
        
        # Build the module with mixed toolchain
        echo ""
        echo "=== Starting Build (Mixed Toolchain) ==="
        echo "OLLVM clang will compile: wuwa.o, wuwa_utils.o, wuwa_page_walk.o, wuwa_bindproc.o"
        echo "Container clang will compile: everything else AND handle linking"
        
        # Build with verbose output
        make -C $KERNEL_SRC \
          M=$PWD \
          OLLVM=1 \
          OLLVM_LEVEL=$OLLVM_LEVEL \
          OLLVM_CUSTOM_FLAGS="$OLLVM_FLAGS" \
          OLLVM_CLANG_PATH="$PWD/android-ollvm/bin/clang" \
          CONTAINER_CLANG_PATH="$CONTAINER_CLANG" \
          V=1 \
          modules 2>&1 | tee build.log
        
        # Check for compiler usage in build log
        echo ""
        echo "=== Checking Compiler Usage ==="
        
        # Count OLLVM clang usage
        OLLVM_COUNT=$(grep -c "android-ollvm/bin/clang" build.log || echo "0")
        echo "OLLVM clang usage count: $OLLVM_COUNT"
        
        # Count container clang usage
        CONTAINER_COUNT=$(grep -c "$CONTAINER_CLANG" build.log || echo "0")
        echo "Container clang usage count: $CONTAINER_COUNT"
        
        if [ "$OLLVM_COUNT" -ge 4 ]; then
          echo "✅ OLLVM clang was used for obfuscated objects"
        else
          echo "⚠️  OLLVM clang was not used enough (expected at least 4 times)"
        fi
        
        # Check if build succeeded
        if grep -q "Error" build.log || grep -q "error:" build.log; then
          echo "❌ Build failed with errors!"
          echo "=== Last 50 lines of build log ==="
          tail -50 build.log
          exit 1
        fi
        
        # Find and copy the kernel module
        KO_FILE=$(find . -name "*.ko" -type f | head -1)
        if [ -z "$KO_FILE" ]; then
          echo "ERROR: No .ko file found!"
          exit 1
        fi
        
        echo "Found KO file: $KO_FILE"
        
        # Create output directory
        mkdir -p /github/workspace/out
        
        # Generate timestamp with parameters
        TS=$(date +'%Y%m%d-%H%M%S')
        OUT="/github/workspace/out/${{ inputs.module_dir }}-${{ matrix.kmi }}-$OLLVM_LEVEL-$TS.ko"
        
        # Copy and strip
        cp "$KO_FILE" "$OUT"
        
        echo "=== Module Info ==="
        echo "Before strip:"
        du -h "$OUT"
        file "$OUT"
        
        # Try to strip debug symbols
        if command -v llvm-strip &> /dev/null; then
          llvm-strip -d "$OUT" && echo "Stripped with llvm-strip"
        elif command -v strip &> /dev/null; then
          strip --strip-debug "$OUT" && echo "Stripped with GNU strip"
        else
          echo "No strip command found, skipping"
        fi
        
        echo "After strip:"
        du -h "$OUT"
        file "$OUT"
        
        echo "Build completed successfully!"
        echo "Output: $OUT"
        echo ""
        echo "=== TOOLCHAIN SUMMARY ==="
        echo "OLLVM Level: $OLLVM_LEVEL"
        echo "OLLVM Flags: $OLLVM_FLAGS"
        echo "OLLVM Objects: 4 files compiled with OLLVM clang"
        echo "Non-OLLVM Objects: 7 files compiled with container clang"
        echo "Linking: Done with container clang"

    # ==================================================
    # Upload artifact
    # ==================================================
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-${{ inputs.obfuscation_level }}
        path: /github/workspace/out/*.ko
        
    # ==================================================
    # Optional: Upload build logs for debugging
    # ==================================================
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}-logs
        path: ${{ inputs.module_dir }}/build.log
