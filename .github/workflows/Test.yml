name: Build Kernel Module with DeClang

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'exianb-dev'

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Setup DeClang with proper configuration
      run: |
        apt-get update && apt-get install -y wget unzip
        
        # Download DeClang
        wget -q https://github.com/DeNA/DeClang/releases/download/swift5.10-v1.0.0/Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        
        # Extract
        unzip -q Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        
        # Setup DECLANG_HOME
        mkdir -p ~/.DeClang
        mv Release-Linux-swift5.10-v1.0.0-ubuntu2204 ~/.DeClang/
        
        # Check the actual structure
        echo "=== DeClang structure ==="
        find ~/.DeClang -type f -name "*.json" -o -name "gen_config*" | head -20
        
        # Check if gen_config binary exists
        if [ -f ~/.DeClang/Release-Linux-swift5.10-v1.0.0-ubuntu2204/gen_config/bin/Linux/gen_config ]; then
            echo "Found gen_config binary for Linux"
        fi

    - name: Generate DeClang configuration
      run: |
        export DECLANG_HOME=~/.DeClang
        
        # Create config.pre.json based on the template but customized for kernel modules
        cat > $DECLANG_HOME/config.pre.json << 'EOF'
{
    "build_seed": "kernel_module_seed_${{ github.run_id }}_$(date +%s)",
    "overall_obfuscation": 80,
    "flatten": [
        {
            "name": ".*",
            "seed": "deadbeefcafebabe",
            "split_level": 2,
            "enable_obfuscation": 1
        }
    ]
}
EOF
        
        echo "=== Created config.pre.json ==="
        cat $DECLANG_HOME/config.pre.json
        
        # Run gen_config.sh to generate config.json
        echo "=== Generating config.json ==="
        cd $DECLANG_HOME
        
        if [ -f $DECLANG_HOME/Release-Linux-swift5.10-v1.0.0-ubuntu2204/gen_config.sh ]; then
            # Use the wrapper script
            $DECLANG_HOME/Release-Linux-swift5.10-v1.0.0-ubuntu2204/gen_config.sh \
                -path "$DECLANG_HOME" \
                -seed "kernel_seed_$(date +%s)"
        elif [ -f $DECLANG_HOME/Release-Linux-swift5.10-v1.0.0-ubuntu2204/gen_config/bin/Linux/gen_config ]; then
            # Call the binary directly
            $DECLANG_HOME/Release-Linux-swift5.10-v1.0.0-ubuntu2204/gen_config/bin/Linux/gen_config \
                -path "$DECLANG_HOME" \
                -seed "kernel_seed_$(date +%s)"
        else
            echo "ERROR: Could not find gen_config!"
            # Create a simple config.json as fallback
            cp config.pre.json config.json
        fi
        
        echo "=== Generated config.json ==="
        cat $DECLANG_HOME/config.json

    - name: Build with DeClang
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko for KMI: ${{ matrix.kmi }} ==="
        
        # MUST SET DECLANG_HOME for obfuscation to work
        export DECLANG_HOME=~/.DeClang
        echo "DECLANG_HOME set to: $DECLANG_HOME"
        
        # Path to DeClang compilers
        DECLANG_CLANG="$DECLANG_HOME/Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang"
        DECLANG_CLANGPP="$DECLANG_HOME/Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang++"
        
        echo "Using DeClang from: $DECLANG_CLANG"
        
        # Create a smart wrapper that:
        # 1. Filters problematic kernel flags
        # 2. Ensures optimization is enabled (-O2 for obfuscation)
        mkdir -p /tmp/declang-kernel
        
        cat > /tmp/declang-kernel/clang << 'EOF'
#!/bin/bash
# DeClang wrapper for kernel module compilation
CLEAN_ARGS=()
HAS_O_FLAG=false

for arg in "$@"; do
    # Remove problematic kernel flag
    if [[ "$arg" == *"enable-trivial-auto-var-init-zero-knowing-it-will-be-removed-from-clang"* ]]; then
        echo "[DeClang] Filtering out problematic flag"
        continue
    fi
    
    # Check if optimization flag is present
    if [[ "$arg" == -O* ]]; then
        HAS_O_FLAG=true
    fi
    
    CLEAN_ARGS+=("$arg")
done

# DeClang documentation says optimization must be enabled for obfuscation
if [ "$HAS_O_FLAG" = false ]; then
    echo "[DeClang] Adding -O2 flag for obfuscation"
    CLEAN_ARGS+=("-O2")
fi

# Execute DeClang
exec "DECLANG_PATH" "${CLEAN_ARGS[@]}"
EOF
        
        # Insert actual DeClang path
        sed -i "s|DECLANG_PATH|$DECLANG_CLANG|g" /tmp/declang-kernel/clang
        chmod +x /tmp/declang-kernel/clang
        
        # Create clang++ wrapper
        cp /tmp/declang-kernel/clang /tmp/declang-kernel/clang++
        sed -i "s|$DECLANG_CLANG|$DECLANG_CLANGPP|g" /tmp/declang-kernel/clang++
        
        # Build with DeClang
        # DeClang will automatically read ~/.DeClang/config.json for obfuscation settings
        make -C $KERNEL_SRC \
            M=$PWD/${{ inputs.module_dir }} \
            CC="/tmp/declang-kernel/clang" \
            CXX="/tmp/declang-kernel/clang++" \
            LD="/tmp/declang-kernel/clang" \
            modules
        
        echo "=== Build completed ==="

        # Output handling
        mkdir -p /github/workspace/out
        KO_FILE=$(find "${{ inputs.module_dir }}" -name "*.ko" -type f | head -1)
        
        if [ -n "$KO_FILE" ] && [ -f "$KO_FILE" ]; then
            TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
            OUTPUT_NAME="${{ inputs.module_dir }}-declang-${{ matrix.kmi }}-$TIMESTAMP.ko"
            cp "$KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
            echo "✅ DeClang-obfuscated module: $OUTPUT_NAME"
            
            # Quick obfuscation check
            echo "=== Obfuscation check ==="
            if command -v strings >/dev/null 2>&1; then
                echo "First 15 strings (look for obfuscated patterns):"
                strings "/github/workspace/out/$OUTPUT_NAME" | head -15
            fi
        else
            echo "❌ ERROR: No .ko file produced!"
            exit 1
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-declang-${{ matrix.kmi }}-${{ github.run_id }}
        path: /github/workspace/out/${{ inputs.module_dir }}-declang-${{ matrix.kmi }}-*.ko
