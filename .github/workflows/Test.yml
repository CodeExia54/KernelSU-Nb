name: Build Obfuscated Kernel Module with DeClang

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'hello-world'

jobs:
  build-obfuscated:
    name: Build ${{ inputs.module_dir }}.ko
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
          - android14-6.1  # Test with one first

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Install tools
      run: |
        apt-get update
        apt-get install -y wget unzip
        
    - name: Download and prepare DeClang
      id: declang
      run: |
        echo "=== DOWNLOAD DECLANG ==="
        wget -q https://github.com/DeNA/DeClang/releases/download/swift5.10-v1.0.0/Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        
        echo "=== EXTRACT ==="
        unzip -q Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        
        echo "=== FIND CLANG ==="
        # Search recursively
        find . -type f -name "clang" | while read f; do
            echo "Candidate: $f"
            file "$f" 2>/dev/null || true
        done
        
        # Get the most likely clang
        CLANG_PATH=$(find . -type f -path "*/bin/clang" | head -1)
        [ -z "$CLANG_PATH" ] && CLANG_PATH=$(find . -type f -name "clang" | head -1)
        
        if [ ! -f "$CLANG_PATH" ]; then
            echo "ERROR: No clang found"
            find . -type f | head -30
            exit 1
        fi
        
        echo "Using clang: $CLANG_PATH"
        chmod +x "$CLANG_PATH"
        
        # Get absolute path
        CLANG_PATH=$(realpath "$CLANG_PATH")
        echo "CLANG_PATH=$CLANG_PATH" >> $GITHUB_OUTPUT
        
        # Test
        echo "DeClang version:"
        "$CLANG_PATH" --version || echo "May need QEMU"
        
    - name: Create PATH hijack wrapper
      run: |
        echo "=== HIJACKING COMPILER VIA PATH ==="
        
        DECLANG_CLANG="${{ steps.declang.outputs.CLANG_PATH }}"
        
        # Create a fake bin directory that will be FIRST in PATH
        mkdir -p /github/workspace/fake_bin
        
        # Create wrapper scripts for ALL compiler tools
        cat > /github/workspace/fake_bin/clang << 'EOF'
#!/bin/bash
# This intercepts calls to 'clang'
DECLANG_CLANG="${{ steps.declang.outputs.CLANG_PATH }}"

# Obfuscation flags
OBF_FLAGS="-mllvm -fla -mllvm -sub"

# Check if we should skip obfuscation for certain cases
for arg in "$@"; do
    case "$arg" in
        *--version*|*-v*|*--help*)
            # No obfuscation for version/help queries
            exec "$DECLANG_CLANG" "$@"
            ;;
    esac
done

# Regular compilation with obfuscation
exec "$DECLANG_CLANG" "$@" $OBF_FLAGS
EOF
        
        # Create wrapper for Android cross-compiler
        cat > /github/workspace/fake_bin/aarch64-linux-android-clang << 'EOF'
#!/bin/bash
# This intercepts cross-compiler calls
DECLANG_CLANG="${{ steps.declang.outputs.CLANG_PATH }}"
OBF_FLAGS="-mllvm -fla -mllvm -sub"
exec "$DECLANG_CLANG" "$@" $OBF_FLAGS --target=aarch64-linux-android
EOF
        
        # Create symlinks for other compiler tools
        for tool in clang++ clang-cl clang-cpp; do
            ln -sf clang /github/workspace/fake_bin/$tool
        done
        
        # Make all wrappers executable
        chmod +x /github/workspace/fake_bin/*
        
        echo "Created wrappers in /github/workspace/fake_bin/"
        ls -la /github/workspace/fake_bin/
        
    - name: Build with hijacked PATH
      env:
        # Put our fake_bin FIRST in PATH
        PATH: /github/workspace/fake_bin:$PATH
      run: |
        echo "=== BUILDING WITH HIJACKED COMPILER ==="
        echo "PATH: $PATH"
        echo "Which clang: $(which clang)"
        
        # Test that our wrapper is being used
        echo "--- Compiler test ---"
        clang --version
        
        # Build module
        cd "${{ inputs.module_dir }}"
        
        echo "--- Building module ---"
        make -C $KERNEL_SRC M=$(pwd) modules V=1 2>&1 | grep -i "clang\|error\|warning" | head -30
        
        # Check result
        KO_FILE=$(find . -name "*.ko" -type f | head -1)
        if [ -f "$KO_FILE" ]; then
            echo "✓ SUCCESS: $KO_FILE"
            
            # Copy to output
            mkdir -p /github/workspace/out
            cp "$KO_FILE" "/github/workspace/out/obfuscated-${{ inputs.module_dir }}.ko"
            
            # Verify it's ARM64
            file "$KO_FILE"
        else
            echo "✗ FAILED: No .ko file"
            echo "Trying without V=1 for more info..."
            make -C $KERNEL_SRC M=$(pwd) modules 2>&1 | tail -50
            exit 1
        fi
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: obfuscated-${{ inputs.module_dir }}-${{ matrix.kmi }}
        path: /github/workspace/out/*.ko
