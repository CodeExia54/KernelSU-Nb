name: Build Kernel Module with OLLVM

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - exianb-dev
        - exianb
        - ovo
        - prctl-fd
        - prctl-hook
        - offset
        - hello-world
        - wuwa
        - panic
        default: 'exianb-dev'
      obfuscation_level:
        description: 'OLLVM obfuscation level'
        required: false
        default: 'medium'
        type: choice
        options:
        - none
        - light
        - medium
        - heavy
      use_custom_clang:
        description: 'Use custom OLLVM clang from ZIP'
        required: false
        default: 'false'
        type: boolean

jobs:
  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko for ${{ matrix.kmi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kmi:
         # - android12-5.10
        #  - android13-5.10
          - android13-5.15
        #  - android14-5.15
       #   - android14-6.1
       #   - android15-6.6
        #  - android16-6.12

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Install unzip in container
      run: |
        echo "=== Installing unzip ==="
        apt-get update && apt-get install -y unzip file

    - name: Setup OLLVM Clang (if requested)
      if: ${{ inputs.use_custom_clang }}
      run: |
        echo "=== Setting up OLLVM Clang ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Check for clang.zip in module directory
        if [ -f "$MODULE_DIR/clang.zip" ]; then
          echo "Found clang.zip in $MODULE_DIR/"
          
          # Extract clang binary
          mkdir -p /tmp/ollvm-clang
          unzip -q "$MODULE_DIR/clang.zip" -d /tmp/ollvm-clang/
          
          # Find the clang binary
          OLLVM_CLANG=$(find /tmp/ollvm-clang -type f -name "clang" | head -1)
          
          if [ -z "$OLLVM_CLANG" ]; then
            echo "❌ No clang found in clang.zip"
            exit 1
          fi
          
          # Make it executable if not already
          chmod +x "$OLLVM_CLANG"
          
          echo "✅ OLLVM Clang found: $OLLVM_CLANG"
          
          # Test it
          echo ""
          echo "=== Testing OLLVM Clang ==="
          "$OLLVM_CLANG" --version 2>&1 | head -3 || true
          
          # Create OLLVM directory
          mkdir -p /usr/local/ollvm/bin
          
          # Copy the entire clang directory structure
          if [ -d "/tmp/ollvm-clang" ]; then
            # Find all files and copy them
            find /tmp/ollvm-clang -type f -executable -name "*" | while read file; do
              cp "$file" /usr/local/ollvm/bin/ 2>/dev/null || true
            done
            
            # Also copy any needed libraries or support files
            if [ -d "/tmp/ollvm-clang/lib" ]; then
              cp -r /tmp/ollvm-clang/lib /usr/local/ollvm/ 2>/dev/null || true
            fi
          fi
          
          # Ensure we have the main clang binary
          if [ ! -f "/usr/local/ollvm/bin/clang" ]; then
            cp "$OLLVM_CLANG" /usr/local/ollvm/bin/clang
          fi
          
          chmod +x /usr/local/ollvm/bin/clang
          
          # Add to PATH globally (for all users)
          echo 'export PATH=/usr/local/ollvm/bin:$PATH' >> /etc/profile.d/ollvm.sh
          export PATH=/usr/local/ollvm/bin:$PATH
          
          # Verify installation
          echo ""
          echo "=== Verifying OLLVM installation ==="
          echo "PATH: $PATH"
          echo "Which clang: $(which clang)"
          /usr/local/ollvm/bin/clang --version 2>&1 | head -1
          
          # Test OLLVM flags - use echo instead of heredoc
          echo ""
          echo "=== Testing OLLVM flags ==="
          echo 'int test_function(int a, int b) { int result = 0; for (int i = 0; i < a; i++) { result += b; } return result; }' > /tmp/test.c
          
          /usr/local/ollvm/bin/clang --target=aarch64-linux-android \
            -mllvm -fla -O2 -c /tmp/test.c -o /tmp/test.o 2>&1 && \
            echo "✅ OLLVM compilation successful" || echo "⚠️ OLLVM compilation warning"
          
          echo "OLLVM_INSTALLED=true" >> $GITHUB_ENV
          
        else
          echo "❌ clang.zip not found in $MODULE_DIR/"
          exit 1
        fi

    - name: Show build environment
      run: |
        echo "=== Build Environment ==="
        echo "Module directory: ${{ inputs.module_dir }}"
        echo "KMI: ${{ matrix.kmi }}"
        echo "KERNEL_SRC: $KERNEL_SRC"
        echo "ARCH: $ARCH"
        echo "Use custom clang: ${{ inputs.use_custom_clang }}"
        echo "OLLVM level: ${{ inputs.obfuscation_level }}"
        echo ""
        echo "=== PATH ==="
        echo $PATH
        echo ""
        echo "=== Available compilers ==="
        echo "Default container clang:"
        which clang
        /opt/ddk/clang/clang-r450784e/bin/clang --version 2>&1 | head -1
        echo ""
        echo "OLLVM clang:"
        if [ -f "/usr/local/ollvm/bin/clang" ]; then
          which clang
          /usr/local/ollvm/bin/clang --version 2>&1 | head -1
        else
          echo "Not installed"
        fi

    - name: Build module with OLLVM
      id: build_module
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Set compiler based on input
        if [ "${{ inputs.use_custom_clang }}" = "true" ] && [ -f "/usr/local/ollvm/bin/clang" ]; then
          echo "=== USING OLLVM COMPILER ==="
          
          # Force use of OLLVM clang by overriding PATH
          export PATH="/usr/local/ollvm/bin:$PATH"
          export CC="/usr/local/ollvm/bin/clang"
          export LD="/usr/local/ollvm/bin/clang"
          
          echo "CC: $(which $CC)"
          echo "LD: $(which $LD)"
          
          # Set OLLVM flags
          case "${{ inputs.obfuscation_level }}" in
            "light")
              OLLVM_FLAGS="-mllvm -fla"
              echo "OLLVM Level: light (-fla)"
              ;;
            "medium")
              OLLVM_FLAGS="-mllvm -fla -mllvm -sub"
              echo "OLLVM Level: medium (-fla -sub)"
              ;;
            "heavy")
              OLLVM_FLAGS="-mllvm -fla -mllvm -sub -mllvm -bcf"
              echo "OLLVM Level: heavy (-fla -sub -bcf)"
              ;;
            *)
              OLLVM_FLAGS=""
              echo "OLLVM Level: none"
              ;;
          esac
          
          echo "OLLVM Flags: $OLLVM_FLAGS"
          
          # Test compiler
          echo ""
          echo "=== Compiler test ==="
          /usr/local/ollvm/bin/clang --version 2>&1 | head -1
          
          # Build command
          BUILD_CMD="make -C \"$KERNEL_SRC\" M=\"$PWD/$MODULE_DIR\" modules"
          BUILD_CMD="$BUILD_CMD CC=\"$CC $OLLVM_FLAGS\""
          BUILD_CMD="$BUILD_CMD LD=\"$LD $OLLVM_FLAGS\""
          BUILD_CMD="$BUILD_CMD HOSTCC=\"gcc\" HOSTCXX=\"g++\""
          BUILD_CMD="$BUILD_CMD -j$(nproc)"
          
          echo "Build command: $BUILD_CMD"
          echo ""
          
          # Execute build
          eval $BUILD_CMD 2>&1 | tee /tmp/build.log
          
          # Check for OLLVM usage
          if grep -i "fla\|sub\|bcf" /tmp/build.log >/dev/null 2>&1; then
            echo "✅ OLLVM flags detected in build output"
          else
            echo "⚠️ Warning: No OLLVM flags detected in build output"
            echo "Last 20 lines of build log:"
            tail -20 /tmp/build.log
          fi
          
        else
          echo "=== USING DEFAULT COMPILER ==="
          echo "Reason - custom clang requested: ${{ inputs.use_custom_clang }}"
          echo "Reason - OLLVM clang exists: $(if [ -f "/usr/local/ollvm/bin/clang" ]; then echo 'yes'; else echo 'no'; fi)"
          
          # Build normally
          make -C "$KERNEL_SRC" M="$PWD/$MODULE_DIR" modules -j$(nproc) 2>&1 | tee /tmp/build.log
        fi

    - name: Verify OLLVM was used
      if: ${{ inputs.use_custom_clang && inputs.obfuscation_level != 'none' }}
      run: |
        echo "=== Verifying OLLVM Usage ==="
        
        # Find the .ko file
        KO_FILE=$(find "${{ inputs.module_dir }}" -name "*.ko" -type f | head -1)
        
        if [ -f "$KO_FILE" ]; then
          echo "Module: $KO_FILE"
          
          # Check build log for OLLVM flags
          echo ""
          echo "=== Checking build log ==="
          if grep -i "mllvm\|fla\|sub\|bcf" /tmp/build.log 2>/dev/null | head -5; then
            echo "✅ OLLVM flags found in build log"
          else
            echo "❌ NO OLLVM flags found in build log!"
          fi
          
          # Check which compiler was actually used
          echo ""
          echo "=== Checking compiler used ==="
          grep -i "clang.*--target\|cc.*command" /tmp/build.log 2>/dev/null | head -3
        fi

    - name: Process output
      run: |
        echo "=== Processing output ==="
        
        MODULE_DIR="${{ inputs.module_dir }}"
        
        # Find the .ko file
        KO_FILE=$(find "$MODULE_DIR" -name "*.ko" -type f | head -1)
        
        if [ -z "$KO_FILE" ] || [ ! -f "$KO_FILE" ]; then
          echo "❌ ERROR: No .ko file found!"
          exit 1
        fi
        
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        
        # Determine build type
        if [ "${{ inputs.use_custom_clang }}" = "true" ] && [ -f "/usr/local/ollvm/bin/clang" ]; then
          BUILD_TYPE="ollvm-${{ inputs.obfuscation_level }}"
          OUTPUT_NAME="$MODULE_DIR-${{ matrix.kmi }}-ollvm-${{ inputs.obfuscation_level }}-$TIMESTAMP.ko"
        else
          BUILD_TYPE="default"
          OUTPUT_NAME="$MODULE_DIR-${{ matrix.kmi }}-default-$TIMESTAMP.ko"
        fi
        
        # Create output directory
        mkdir -p /github/workspace/out
        
        # Copy the module
        cp "$KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
        echo "✅ Module saved: $OUTPUT_NAME"
        
        # Get file info
        ORIGINAL_SIZE=$(stat -c%s "/github/workspace/out/$OUTPUT_NAME")
        echo "Size: $ORIGINAL_SIZE bytes ($((ORIGINAL_SIZE/1024)) KB)"
        
        # Strip if possible
        if command -v llvm-strip >/dev/null 2>&1; then
          llvm-strip -d "/github/workspace/out/$OUTPUT_NAME" 2>/dev/null || true
          STRIPPED_SIZE=$(stat -c%s "/github/workspace/out/$OUTPUT_NAME")
          echo "Stripped size: $STRIPPED_SIZE bytes"
        fi
        
        # Create detailed build info - using echo statements
        BUILD_INFO_FILE="/github/workspace/out/build-info-$OUTPUT_NAME.txt"
        {
          echo "========================================="
          echo "BUILD INFORMATION"
          echo "========================================="
          echo "Module: $MODULE_DIR"
          echo "KMI: ${{ matrix.kmi }}"
          echo "Build Type: $BUILD_TYPE"
          echo "Use Custom Clang: ${{ inputs.use_custom_clang }}"
          echo "OLLVM Level: ${{ inputs.obfuscation_level }}"
          echo "Timestamp: $(date)"
          echo ""
          echo "COMPILER INFORMATION:"
          echo "Default Clang: $(which clang)"
          echo "Default Clang Version: $(/opt/ddk/clang/clang-r450784e/bin/clang --version 2>&1 | head -1)"
          echo ""
          echo "OLLVM STATUS:"
          if [ -f "/usr/local/ollvm/bin/clang" ]; then
            echo "OLLVM Clang Installed: YES"
            echo "OLLVM Clang Path: /usr/local/ollvm/bin/clang"
            echo "OLLVM Clang Version: $(/usr/local/ollvm/bin/clang --version 2>&1 | head -1)"
          else
            echo "OLLVM Clang Installed: NO"
            echo "OLLVM Clang Path: N/A"
            echo "OLLVM Clang Version: N/A"
          fi
          echo ""
          echo "BUILD OUTPUT:"
          echo "Original File: $KO_FILE"
          echo "Output File: $OUTPUT_NAME"
          echo "Original Size: $ORIGINAL_SIZE bytes"
          echo "Stripped Size: ${STRIPPED_SIZE:-$ORIGINAL_SIZE} bytes"
          echo ""
          echo "OLLVM VERIFICATION:"
          if [ "${{ inputs.use_custom_clang }}" = "true" ] && [ -f "/tmp/build.log" ]; then
            echo "Build log contains OLLVM flags:"
            grep -i "mllvm\|fla\|sub\|bcf" /tmp/build.log 2>/dev/null | head -3 || echo "None found"
          else
            echo "No OLLVM verification data"
          fi
          echo ""
          echo "MODULE STRUCTURE:"
          echo "Source files: $(find "$MODULE_DIR/src" -name "*.c" 2>/dev/null | wc -l)"
          echo "Header files: $(find "$MODULE_DIR/src" -name "*.h" 2>/dev/null | wc -l)"
          echo "========================================="
        } > "$BUILD_INFO_FILE"
        
        echo "ARTIFACT_PATH=/github/workspace/out/$OUTPUT_NAME" >> $GITHUB_ENV

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}
        path: |
          ${{ env.ARTIFACT_PATH }}
          /github/workspace/out/build-info-*.txt
        retention-days: 7
