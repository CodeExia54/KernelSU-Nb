name: Build with DeClang OLLVM (No Container)

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Module directory to build'
        required: true
        type: choice
        options:
        - wuwa
        default: 'wuwa'
      obfuscation_level:
        description: 'OLLVM obfuscation level'
        required: false
        default: 'medium'
        type: choice
        options:
        - none
        - light
        - medium
        - heavy

jobs:
  test-declang:
    name: Test DeClang OLLVM Support
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download Swift DeClang
      run: |
        echo "=== Downloading Swift DeClang ==="
        
        wget -q https://github.com/DeNA/DeClang/releases/download/swift5.10-v1.0.0/Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        unzip -q Release-Linux-swift5.10-v1.0.0-ubuntu2204.zip
        
        DECLANG_CLANG="$(pwd)/Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang"
        chmod +x "$DECLANG_CLANG"
        
        echo "✅ DeClang: $DECLANG_CLANG"
        
        # Test OLLVM support
        echo ""
        echo "=== Testing OLLVM Support ==="
        
        # Create test file
        echo 'int test(){return 42;}' > test.c
        
        # Test -mllvm -fla
        echo "Testing -mllvm -fla:"
        if "$DECLANG_CLANG" -c test.c -o test.o -mllvm -fla 2>&1; then
          echo "✅ -mllvm -fla works"
          echo "OLLVM_SUPPORTED=true" >> $GITHUB_ENV
        else
          echo "❌ -mllvm -fla failed"
          "$DECLANG_CLANG" -c test.c -o test.o -mllvm -fla 2>&1 | head -3
          echo "OLLVM_SUPPORTED=false" >> $GITHUB_ENV
        fi
        
        rm -f test.c test.o
        
        echo "DECLANG_CLANG=$DECLANG_CLANG" >> $GITHUB_ENV

    - name: Upload DeClang Binary
      if: env.OLLVM_SUPPORTED == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: declang-binary
        path: Release-Linux-swift5.10-v1.0.0-ubuntu2204/compiler/bin/clang

  ddk-build:
    name: Build ${{ inputs.module_dir }}.ko
    runs-on: ubuntu-latest
    needs: test-declang
    if: needs.test-declang.outputs.OLLVM_SUPPORTED == 'true'
    strategy:
      matrix:
        kmi: [android13-5.10, android14-5.15]

    container:
      image: ghcr.io/ylarod/ddk:${{ matrix.kmi }}

    steps:
    - uses: actions/checkout@v4
    
    - name: Download Tested DeClang
      uses: actions/download-artifact@v4
      with:
        name: declang-binary
        path: /tmp
        
    - name: Setup DeClang in Container
      run: |
        echo "=== Setting up DeClang in container ==="
        
        # Make DeClang executable
        chmod +x /tmp/clang
        
        # Backup and replace system clang
        if [ -f "/usr/bin/clang" ]; then
          mv /usr/bin/clang /usr/bin/clang.backup
        fi
        
        cp /tmp/clang /usr/bin/clang
        chmod +x /usr/bin/clang
        
        echo "✅ System clang replaced"
        clang --version 2>&1 | head -1

    - name: Build Module with OLLVM
      run: |
        echo "=== Building ${{ inputs.module_dir }}.ko ==="
        
        # Set OLLVM flags
        case "${{ inputs.obfuscation_level }}" in
          "light")
            OLLVM_FLAGS="-mllvm -fla"
            ;;
          "medium")
            OLLVM_FLAGS="-mllvm -fla -mllvm -sub"
            ;;
          "heavy")
            OLLVM_FLAGS="-mllvm -fla -mllvm -sub -mllvm -bcf"
            ;;
        esac
        
        echo "OLLVM Flags: $OLLVM_FLAGS"
        
        # Quick test
        echo 'int x;' | clang -x c -c - -o /dev/null $OLLVM_FLAGS 2>&1 && \
          echo "✅ OLLVM test passed" || echo "⚠️  OLLVM test warning"
        
        # Build
        make -C $KERNEL_SRC M=$PWD/${{ inputs.module_dir }} modules \
          OLLVM_FLAGS="$OLLVM_FLAGS"
        
        echo ""
        echo "=== Build Result ==="
        
        KO_FILE=$(find "${{ inputs.module_dir }}" -name "*.ko" -type f | head -1)
        if [ -f "$KO_FILE" ]; then
          echo "✅ SUCCESS: $KO_FILE"
          echo "BUILT_KO_FILE=$KO_FILE" >> $GITHUB_ENV
        else
          echo "❌ FAILED"
          exit 1
        fi

    - name: Create Artifact
      env:
        BUILT_KO_FILE: ${{ env.BUILT_KO_FILE }}
      run: |
        mkdir -p /github/workspace/out
        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        OUTPUT_NAME="${{ inputs.module_dir }}-${{ matrix.kmi }}-ollvm-${{ inputs.obfuscation_level }}-$TIMESTAMP.ko"
        cp "$BUILT_KO_FILE" "/github/workspace/out/$OUTPUT_NAME"
        echo "ARTIFACT_PATH=/github/workspace/out/$OUTPUT_NAME" >> $GITHUB_ENV

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module_dir }}-${{ matrix.kmi }}
        path: ${{ env.ARTIFACT_PATH }}
